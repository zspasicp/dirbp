var JSFun={extend:function(t,e){function i(){}i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t,t.baseConstructor=e,t.base=e.prototype},isNumber:function(t){return"number"==typeof t&&isFinite(t)},isString:function(t){return"string"==typeof t},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},isBoolean:function(t){return"boolean"==typeof t}},Point=function(t,e){this.setPoint(t,e)};Point.prototype.setPoint=function(t,e){return t instanceof Point?(this.setX(t._x),this.setY(t._y)):(this.setX(t),this.setY(e)),this},Point.prototype.setX=function(t){return JSFun.isNumber(t)&&(this._x=t),this},Point.prototype.setY=function(t){return JSFun.isNumber(t)&&(this._y=t),this},Point.prototype.getX=function(){return this._x},Point.prototype.getY=function(){return this._y},Point.prototype.equals=function(t){return t instanceof Point&&this._x==t.x&&this.y==t._y},Point.prototype.pixelX=function(){return parseInt(this._x)+.5},Point.prototype.pixelY=function(){return parseInt(this._y)+.5};var Element=function(){};Element.prototype.select=function(t,e){return!1},Element.prototype.deselect=function(){},Element.prototype.drag=function(t,e){},Element.prototype.drop=function(t,e){},Element.prototype.draw=function(t){},Element.prototype.drawShape=function(t){},Element.prototype.isOver=function(t,e){return!1},Element.prototype.setDiagram=function(t){},Element.prototype.getParent=function(){return null},Element.prototype.getCentralPoint=function(){return new Point},Element.prototype.getLinkCentered=function(t,e){return new Point},Element.prototype.setElementXML=function(t){},Element.prototype.getElementXML=function(t){return""};var JSGraphic={toPixel:function(t){return parseInt(t)+.5},dashedLine:function(t,e,i,n,o,s){var r=Math.sqrt((n-e)*(n-e)+(o-i)*(o-i))/s;r=r/2-1;var h=Math.abs(Math.atan2(o-i,n-e)),a=Math.cos(h)*s,l=Math.sin(h)*s,d=e,p=i;o<i&&(l=-l),t.beginPath();for(var c=0;c<r;c++)t.moveTo(d,p),d+=a,p+=l,t.lineTo(d,p),d+=a,p+=l;t.moveTo(d,p),d+=a,p+=l,(a>0&&d>n||a<0&&d<n)&&(d=n),(l>0&&p>o||l<0&&p<o)&&(p=o),t.lineTo(d,p),t.stroke()},lineIntersection:function(t,e,i,n,o,s,r,h){var a,l,d=n-e,p=t-i,c=-p*e-d*t,u=h-s,_=o-r,g=-_*s-u*o;if(t==i)l=-(g+u*(a=t))/_;else if(e==n)a=-(g+_*(l=e))/u;else if(o==r)l=-(c+d*(a=o))/p;else if(s==h)a=-(c+p*(l=s))/d;else{var m=-p/_;l=-(c+d*(a=-(m*g+c)/(d+m*u)))/p}return new Point(a,l)},ellipse:function(t,e,i,n,o){var s=.5522847498307933,r=s*n,h=s*o;t.beginPath(),t.moveTo(e-n,i),t.bezierCurveTo(e-n,i-h,e-r,i-o,e,i-o),t.bezierCurveTo(e+r,i-o,e+n,i-h,e+n,i),t.bezierCurveTo(e+n,i+h,e+r,i+o,e,i+o),t.bezierCurveTo(e-r,i+o,e-n,i+h,e-n,i)},rhombus:function(t,e,i,n,o){t.beginPath(),t.moveTo(e,i+o/2),t.lineTo(e+n/2,i),t.lineTo(e+n,i+o/2),t.lineTo(e+n/2,i+o),t.closePath()},triangle:function(t,e,i,n,o,s){switch(t.beginPath(),s){case 0:t.moveTo(e,i+o/2),t.lineTo(e+n/2,i),t.lineTo(e+n,i+o/2);break;case 1:t.moveTo(e+n/2,i),t.lineTo(e+n,i+o/2),t.lineTo(e+n/2,i+o);break;case 2:t.moveTo(e,i+o/2),t.lineTo(e+n,i+o/2),t.lineTo(e+n/2,i+o);break;default:t.moveTo(e,i+o/2),t.lineTo(e+n/2,i),t.lineTo(e+n/2,i+o)}t.closePath()},ellipseIntersection:function(t,e,i,n,o,s){var r,h=(s-e)/(o-t),a=0,l=0;return i>0&&n>0&&(a=Math.sqrt(1/(1/(i*i)+h*h/(n*n)))),r=n*n*(1-a*a/(i*i)),i>0&&r>=0&&(l=Math.sqrt(r)),o<t&&(a=-a),s<e&&(l=-l),new Point(t+a,e+l)}},ComponentStyle={component_color:"#000000"},Component=function(t){t=t||{},this._x=0,this._y=0,this._width=0,this._height=0,this._minWidth=0,this._minHeight=0,this._superWidth=0,this._parent=null,this._setId(t.id||""),this._setMargin(t.margin||0),this._setPosition(t.position||Component.Float),this._setCentered(t.centered||!1),this._orientation=t.orientation||0,this._visible=t.visible||!0};Component.Static=0,Component.Float=1,Component.TopRight=2,Component.Bottom=3,Component.BottomLeft=4,Component.BottomRight=5,Component.TopLeft=8,Component.Xmovement=10,Component.Top=11,Component.Left=12,Component.Right=13,Component.prototype._setId=function(t){JSFun.isString(t)?this._id=t:this._id=""},Component.prototype.getId=function(){return this._id},Component.prototype.getUniqueId=function(){return this.getParent()instanceof SuperComponent?this.getParent().getUniqueId()+this.getParent()._childs.indexOf(this):this.getParent().getId()+this._id},Component.prototype.setCoordinates=function(t,e){this._x=t,this._y=e},Component.prototype.updatePosition=function(t,e){this._x+=t,this._y+=e},Component.prototype.setWidth=function(t){t>this._minWidth?this._width=t+2*this._margin:this._width=this._minWidth,this._width=100},Component.prototype.setHeight=function(t){t>this._minHeight?this._height=t+2*this._margin:this._height=this._minHeight},Component.prototype.setVisibility=function(t){this._visible=t},Component.prototype.setMinWidth=function(t){t>0&&(this._minWidth=t),t>this._width&&(this._width=t)},Component.prototype.setMinHeight=function(t){t>0&&(this._minHeight=t),t>this._height&&(this._height=t)},Component.prototype.setSuperWidth=function(t){t>=0&&(this._superWidth=t)},Component.prototype._setMargin=function(t){JSFun.isNumber(t)?this._margin=t:this._margin=0},Component.prototype.setParent=function(t){(t instanceof Element||t instanceof SuperComponent||t instanceof Diagram)&&(this._parent=t)},Component.prototype._setPosition=function(t){t==Component.Float||t==Component.Static||t==Component.TopRight||t==Component.Bottom||t==Component.BottomLeft||t==Component.BottomRight||t==Component.TopLeft||t==Component.sideLeft||t==Component.Xmovement||t==Component.Top||t==Component.Left||t==Component.Right?this._position=t:this._position=Component.Float},Component.prototype._setCentered=function(t){this._centered=1==t},Component.prototype._getX=function(){return this._x},Component.prototype._getY=function(){return this._y},Component.prototype.getPixelX=function(){return JSGraphic.toPixel(this._x)},Component.prototype.getPixelY=function(){return JSGraphic.toPixel(this._y)},Component.prototype._getMX=function(){return this._x+this._margin},Component.prototype._getMY=function(){return this._y+this._margin},Component.prototype.getWidth=function(){return this._width},Component.prototype.getHeight=function(){return this._height},Component.prototype._getMargin=function(){return this._margin},Component.prototype.getSuperWidth=function(){return this._parent instanceof SuperComponent?this._parent.getSuperWidth():this._superWidth},Component.prototype.getParent=function(){return this._parent},Component.prototype.getPosition=function(){return this._position},Component.prototype.isCentered=function(){return this._centered},Component.prototype.getComponentXML=function(t){var e=t.createElement("item");return this._id&&e.setAttribute("id",this._id),e.setAttribute("value",this.getValue()),e},Component.prototype.notifyDraw=function(){this._parent&&this._parent.notifyDraw()},Component.prototype.notifyChange=function(){if(this._parent){this._orientation?this._parent._height:this._parent._width;this._parent instanceof SuperNode?this._parent.notifyChange(!0):this._parent.notifyChange(),this._parent&&this._parent._parent instanceof SuperNode&&this._parent._parent.notifyChange(!0),this._parent.notifyDraw()}},Component.prototype.notifyDelete=function(){(this._parent instanceof SuperComponent||this._parent instanceof Diagram||this._parent.getParent()instanceof SuperNode)&&this._parent.notifyDelete(this)},Component.prototype.notifyToUp=function(){this._parent instanceof SuperComponent&&this._parent.notifyToUp(this)},Component.prototype.notifyToDown=function(){this._parent instanceof SuperComponent&&this._parent.notifyToDown(this)},Component.prototype.isOver=function(t,e,i){var n=i||0;return!!(this._visible&&t+n>=this._x&&t<=this._x+this._width+n&&e+n>=this._y&&e<=this._y+this._height+n)},Component.prototype.draw=function(t){},Component.prototype.select=function(t,e,i){return!1},Component.prototype.drawShape=function(t){},Component.prototype.deselect=function(){},Component.prototype.setValue=function(t){},Component.prototype.getValue=function(){},Component.prototype.setFontColor=function(t){},Component.prototype.getFontColor=function(){},Component.prototype.setFontFamily=function(t){},Component.prototype.getFontFamily=function(){},Component.prototype.setFontSize=function(t){},Component.prototype.getFontSize=function(){},Component.prototype.setFontStyle=function(t){},Component.prototype.getFontStyle=function(){},Component.prototype.getFontWeight=function(){},Component.prototype.setFontWeight=function(t){},Component.prototype.getUnderlineText=function(){return this._underline},Component.prototype.setUnderlineText=function(t){this._underline=t},Component.prototype.setComponentXML=function(t){t.getAttribute("id")&&(this._id=t.getAttribute("id")),t.getAttribute("fontColor")&&this.setFontColor(t.getAttribute("fontColor")),t.getAttribute("fontSize")&&this.setFontSize(t.getAttribute("fontSize")),t.getAttribute("fontFamily")&&this.setFontFamily(t.getAttribute("fontFamily")),t.getAttribute("fontStyle")&&this.setFontStyle(t.getAttribute("fontStyle")),t.getAttribute("fontWeight")&&this.setFontWeight(t.getAttribute("fontWeight")),this.setValue(t.getAttribute("value"))};var SuperComponent=function(t){t=t||{},SuperComponent.baseConstructor.call(this,t),this._childs=[],this._activeChild=null,this._visibleSubComponents=!0,this.setFontColor(t.text_color||"#000000"),this.setFontSize(t.font_size||"12"),this._font_width=this.getFontSize()/1.5,this.line_height=parseInt(this.getFontSize())+1,this.setFontFamily(t.text_family||"monospace"),this.setFontStyle(t.font_style||"normal"),this.setFontWeight(t.font_weight||"normal")};JSFun.extend(SuperComponent,Component),SuperComponent.prototype.changeVisibility=function(){this._visibleSubComponents=!this._visibleSubComponents},SuperComponent.prototype.setVisibility=function(t){this._visible=t;for(var e=0;e<this._childs.length;e++)this._childs[e]._visible=t},SuperComponent.prototype.visibilitySubComponents=function(){return this._visibleSubComponents},SuperComponent.prototype.isOver=function(t,e,n){for(i in this._childs)if(this._childs[i].isOver(t,e,n))return!0;return SuperComponent.base.select.call(this,t,e,n)},SuperComponent.prototype.getComponentXML=function(t){var e,i=t.createElement("superitem");i.setAttribute("id",this._id),i.setAttribute("visibleSubComponents",this._visibleSubComponents),"#000000"!=this.getFontColor()&&i.setAttribute("fontColor",this.getFontColor()),"12"!=this.getFontSize()&&i.setAttribute("fontSize",this.getFontSize()),"normal"!=this.getFontStyle()&&i.setAttribute("fontStyle",this.getFontStyle()),"monospace"!=this.getFontFamily()&&i.setAttribute("fontFamily",this.getFontFamily()),"normal"!=this.getFontWeight()&&i.setAttribute("fontWeight",this.getFontWeight());for(e in this._childs)i.appendChild(this._childs[e].getComponentXML(t));return i},SuperComponent.prototype.setComponentXML=function(t){var e,i=t.childNodes;for("true"==t.getAttribute("visibleSubComponents")?this._visibleSubComponents=!0:this._visibleSubComponents=!1,t.getAttribute("fontColor")&&this.setFontColor(t.getAttribute("fontColor")),t.getAttribute("fontSize")&&this.setFontSize(t.getAttribute("fontSize")),t.getAttribute("fontStyle")&&this.setFontStyle(t.getAttribute("fontStyle")),t.getAttribute("fontFamily")&&this.setFontFamily(t.getAttribute("fontFamily")),t.getAttribute("fontWeigth")&&this.setFontWeight(t.getAttribute("fontWeight")),e=0;e<i.length;e++)this.addField(i[e].getAttribute("value"))},SuperComponent.prototype.updatePosition=function(t,e){var i;SuperComponent.base.updatePosition.call(this,t,e);for(i in this._childs)this._childs[i].updatePosition(t,e)},SuperComponent.prototype.addSubComponent=function(t){t instanceof Component&&(t.setParent(this),t.setFontFamily(this.getFontFamily()),t.setFontColor(this.getFontColor()),t.setFontSize(this.getFontSize()),t.setFontStyle(this.getFontStyle()),t.setFontWeight(this.getFontWeight()),this._childs.push(t))},SuperComponent.prototype.delSubComponent=function(t){var e;for(e in this._childs)if(this._childs[e]==t){this._childs.splice(e,1);break}},SuperComponent.prototype.updateComponents=function(){if(this._visibleSubComponents){var t,e=0,i=0;for(t in this._childs)this._orientation?(this._childs[t].getHeight()>i&&(i=this._childs[t].getHeight()),e+=this._childs[t].getWidth()):(this._childs[t].getWidth()>e&&(e=this._childs[t].getWidth()),i+=this._childs[t].getHeight());this._orientation?(this.setWidth(e),this.setHeight(i+this._getMargin())):(this.setWidth(e+this._getMargin()),this.setHeight(i));var n=this._getMX(),o=this._getMY();for(t=0;t<this._childs.length;t++)this._orientation?(this._childs[t].setCoordinates(n,o),n+=this._childs[t].getWidth()):(this._childs[t].setCoordinates(n,o),o+=this._childs[t].getHeight())}else this.setWidth(1),this.setHeight(1)},SuperComponent.prototype.select=function(t,e){var i;if(this._visibleSubComponents)for(i in this._childs)if(this._childs[i].select(t,e))return this._activeChild=this._childs[i],!0},SuperComponent.prototype.deselect=function(){this._activeChild&&(this._activeChild.deselect(),this._activeChild=null)},SuperComponent.prototype.drawShape=function(t){var e;if(this._visible&&(t.save(),t.strokeStyle="#aaaaaa",t.strokeRect(this.getPixelX(),this.getPixelY(),this.getWidth(),this.getHeight()),t.restore(),this._visibleSubComponents))for(e in this._childs)this._childs[e].drawShape(t)},SuperComponent.prototype.notifyToUp=function(t){var e;for(e=0;e<this._childs.length;e++)if(this._childs[e]==t)return void(e>0&&(this._childs[e]=this._childs[e-1],this._childs[e-1]=t))},SuperComponent.prototype.notifyToDown=function(t){var e;for(e=0;e<this._childs.length-1;e++)if(this._childs[e]==t)return this._childs[e]=this._childs[e+1],void(this._childs[e+1]=t)},SuperComponent.prototype.notifyChange=function(){this.updateComponents(),this._parent&&(this._parent instanceof SuperNode?this._parent.notifyChange(!0):this._parent.notifyChange(),this._parent&&this._parent._parent instanceof SuperNode&&this._parent._parent.notifyChange(!0))},SuperComponent.prototype.notifyDelete=function(t){this.delSubComponent(t),this.updateComponents()},SuperComponent.prototype.draw=function(t){var e;if(this._visible&&this._visibleSubComponents)for(e in this._childs)this._childs[e].draw(t)},SuperComponent.prototype.setFontSize=function(t){var e;this._font_size=t;for(e in this._childs)this._childs[e].setFontSize(t)},SuperComponent.prototype.getFontSize=function(){return this._font_size},SuperComponent.prototype.setFontColor=function(t){var e;this._font_color=t;for(e in this._childs)this._childs[e].setFontColor(t)},SuperComponent.prototype.getFontColor=function(){return this._font_color},SuperComponent.prototype.setFontFamily=function(t){var e;this._font_family=t;for(e in this._childs)this._childs[e].setFontFamily(t)},SuperComponent.prototype.getFontFamily=function(){return this._font_family},SuperComponent.prototype.setFontStyle=function(t){var e;this._font_style=t;for(e in this._childs)this._childs[e].setFontStyle(t)},SuperComponent.prototype.getFontStyle=function(){return this._font_style},SuperComponent.prototype.setFontWeight=function(t){var e;this._font_weight=t;for(e in this._childs)this._childs[e].setFontWeight(t)},SuperComponent.prototype.getFontWeight=function(){return this._font_weight};var Text=function(t){t=t||{},Text.baseConstructor.call(this,t),this.setFontColor(t.text_color||"#000000"),this.setFontSize(t.font_size||"12"),this._font_width=this.getFontSize()/1.5,this._line_height=parseInt(this.getFontSize())+1,this.setFontFamily(t.text_family||"monospace"),this.setFontStyle(t.font_style||"normal"),this.setFontWeight(t.font_weight||"normal"),this.setText(t.text||"")};JSFun.extend(Text,Component),Text.prototype.setValue=function(t){this.setText(t)},Text.prototype.getValue=function(){return this._text},Text.prototype.setText=function(t){JSFun.isString(t)&&(this._text=t,""==t?this._orientation?this.setHeight(50):this.setWidth(50):this._orientation?this.setHeight(this._text.length*this._font_width):this.setWidth(this._text.length*this._font_width),this._orientation?this.setWidth(this._line_height):this.setHeight(this._line_height))},Text.prototype.draw=function(t){this._visible&&(t.save(),t.font=this.getFontStyle()+" "+this.getFontWeight()+" "+this.getFontSize()+"px "+this.getFontFamily(),t.textBaseline="middle",t.fillStyle=this.getFontColor(),this._orientation?(t.translate(this._getMX()+this._line_height/2,this._getMY()),t.rotate(-90*Math.PI/180),t.fillText(this._text,2*this._margin-this.getHeight(),0)):this._text&&t.fillText(this._text,this._getMX(),this._getMY()+this._line_height/2),t.restore())},Text.prototype.setFontSize=function(t){this._font_size=t,this.resize()},Text.prototype.getFontSize=function(){return this._font_size},Text.prototype.setFontColor=function(t){this._font_color=t},Text.prototype.getFontColor=function(){return this._font_color},Text.prototype.setFontFamily=function(t){this._font_family=t},Text.prototype.getFontFamily=function(){return this._font_family},Text.prototype.resize=function(){this._line_height=parseInt(this.getFontSize(),10)+1,this._font_width=this.getFontSize()/1.5;var t=this.getValue()||"";""==t?this._orientation?this.setHeight(50):this.setWidth(50):this._orientation?this.setHeight(t.length*this._font_width):this.setWidth(t.length*this._font_width),this._orientation?this.setWidth(this._line_height):this.setHeight(this._line_height)},Text.prototype.setFontStyle=function(t){this._font_style=t},Text.prototype.getFontStyle=function(){return this._font_style},Text.prototype.setFontWeight=function(t){this._font_weight=t},Text.prototype.getFontWeight=function(){return this._font_weight},Text.prototype.getComponentXML=function(t){var e=t.createElement("item");return this._id&&e.setAttribute("id",this._id),"#000000"!=this.getFontColor()&&e.setAttribute("fontColor",this.getFontColor()),"12"!=this.getFontSize()&&e.setAttribute("fontSize",this.getFontSize()),"normal"!=this.getFontStyle()&&e.setAttribute("fontStyle",this.getFontStyle()),"monospace"!=this.getFontFamily()&&e.setAttribute("fontFamily",this.getFontFamily()),"normal"!=this.getFontWeight()&&e.setAttribute("fontWeight",this.getFontWeight()),e.setAttribute("value",this.getValue()),e};var TextBox=function(t){t=t||{},TextBox.baseConstructor.call(this,t),this.selected=t.selected||!1,this.deletable=!1,t.width&&(this._width=t.width)};JSFun.extend(TextBox,Text),TextBox.prototype.setDeletable=function(){this.deletable=!0},TextBox.prototype.select=function(t,e,i){var n=i||0;return!(this.selected||!this.isOver(t,e,n))&&(this.showDialog(t,e),!0)},TextBox.prototype.deselect=function(){this.active&&(this.closeDialog(),this.active=!1)},TextBox.prototype.showDialog=function(){if(!this.active){var t=this;this.active=!0;var e=document.createElement("div"),i=document.createElement("form"),n=document.createElement("input"),o=document.createElement("input");if(e.className="ud_popup",n.setAttribute("type","text"),n.setAttribute("value",this.decode(this.getValue())),o.setAttribute("type","submit"),o.setAttribute("value","OK"),this.changeText=function(i){t.active&&(t.setText(t.encode(n.value)),document.body.removeChild(e),t.active=!1,t.notifyChange())},this.closeDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyChange())},i.onsubmit=function(){return!1},o.addEventListener("click",this.changeText,!1),i.appendChild(n),i.appendChild(o),this.deletable){var s=document.createElement("input");s.setAttribute("type","submit"),s.setAttribute("value","delete"),this.deleteDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyDelete(),t.notifyChange())},s.addEventListener("click",this.deleteDialog,!1),i.appendChild(s)}e.appendChild(i),document.body.appendChild(e),n.focus(),e.style.top=(window.innerHeight-i.offsetHeight)/2+"px",e.style.left=(window.innerWidth-i.offsetWidth)/2+"px"}},TextBox.prototype.drawShape=function(t){this._visible&&(t.save(),t.strokeStyle="#aaaaaa",t.strokeRect(this.getPixelX(),this.getPixelY(),this.getWidth(),this.getHeight()),t.restore())},TextBox.prototype.draw=function(t){this._visible&&(t.save(),this.active&&(t.fillStyle="#ffc485",t.fillRect(this.getPixelX(),this.getPixelY(),this.getWidth(),this.getHeight())),t.restore(),TextBox.base.draw.call(this,t))},TextBox.prototype.encode=function(t){return t},TextBox.prototype.decode=function(t){return t};var CollapsibleFields=function(t){t=t||{},CollapsibleFields.baseConstructor.call(this,t),this.setMinHeight(10),0==t.visibleSubComponents&&this.changeVisibility()};JSFun.extend(CollapsibleFields,SuperComponent),CollapsibleFields.prototype.addField=function(t){var e=this.newItem();e.setDeletable(),t&&e.setValue(t),this.addSubComponent(e),this.notifyChange()},CollapsibleFields.prototype.newItem=function(){return new TextBox},CollapsibleFields.prototype.isOver=function(t,e,i){var n=i||0;return Math.abs(t-(this._getX()+5))<=6+n&&Math.abs(e-(this._getY()+5))<=6+n||(!!(this.visibilitySubComponents()&&Math.abs(t-(this._getX()+this.getSuperWidth()-5))<=6+n&&Math.abs(e-(this._getY()+5))<=6+n)||CollapsibleFields.base.isOver.call(this,t,e,n))},CollapsibleFields.prototype.select=function(t,e,i){var n=i||0;return Math.abs(t-(this._getX()+5))<=6+n&&Math.abs(e-(this._getY()+5))<=6+n?(this.changeVisibility(),this.notifyChange(),!0):this.visibilitySubComponents()&&Math.abs(t-(this._getX()+this.getSuperWidth()-5))<=6+n&&Math.abs(e-(this._getY()+5))<=6+n?(this.addField(),!0):CollapsibleFields.base.select.call(this,t,e)},CollapsibleFields.prototype.drawShape=function(t){if(this._visible){CollapsibleFields.base.drawShape.call(this,t);var e=this.getPixelX(),i=this.getPixelY();t.save(),t.fillStyle="#ff0000",t.beginPath(),this.visibilitySubComponents()?(t.moveTo(e,i+5),t.lineTo(e+10,i+5),t.lineTo(e+5,i),t.closePath(),t.fill(),t.fillStyle="#94dc91",t.beginPath(),t.arc(this.getPixelX()+this.getSuperWidth()-5,this.getPixelY()+5,4,0,2*Math.PI,!0),t.closePath(),t.fill(),t.restore()):(t.moveTo(e+5,i),t.lineTo(e+5,i+10),t.lineTo(e+10,i+5),t.closePath(),t.fill(),t.restore())}},CollapsibleFields.prototype.draw=function(t){this._visible&&(this.visibilitySubComponents()&&(t.save(),t.beginPath(),t.moveTo(this.getPixelX(),this.getPixelY()),t.lineTo(this.getPixelX()+this.getSuperWidth(),this.getPixelY()),t.stroke(),t.restore()),CollapsibleFields.base.draw.call(this,t))};var ArtifactItem=function(t){t=t||{},ArtifactItem.baseConstructor.call(this,t),this.setMinWidth(40)};JSFun.extend(ArtifactItem,TextBox),ArtifactItem.prototype.select=function(t,e){return Math.abs(t-(this.getPixelX()+this.getSuperWidth()-20))<=5&&Math.abs(e-(this.getPixelY()+8.66))<=5?(this.notifyToUp(),this.notifyChange(),!0):Math.abs(t-(this.getPixelX()+this.getSuperWidth()-30))<=5&&Math.abs(e-(this.getPixelY()+7.33))<=5?(this.notifyToDown(),this.notifyChange(),!0):ArtifactItem.base.select.call(this,t,e)},ArtifactItem.prototype.drawShape=function(t){if(this._visible){var e=this.getPixelX()+this.getSuperWidth()-35,i=this.getPixelY()+3;t.save(),t.fillStyle="#0000aa",t.beginPath(),t.moveTo(e,i),t.lineTo(e+10,i),t.lineTo(e+5,i+7),t.closePath(),t.fill(),e+=10,t.beginPath(),t.moveTo(e+5,i),t.lineTo(e,i+7),t.lineTo(e+10,i+7),t.closePath(),t.fill(),t.restore()}};var ArtifactFields=function(t){t=t||{},ArtifactFields.baseConstructor.call(this,t),this._default=t.text||"new_artifact"};JSFun.extend(ArtifactFields,CollapsibleFields),ArtifactFields.prototype.newItem=function(){return new ArtifactItem({text:this._default})},ArtifactFields.prototype.draw=function(t){this._visible&&CollapsibleFields.base.draw.call(this,t)};var ArtifactSymbol=function(t){t=t||{},ArtifactSymbol.baseConstructor.call(this,t),this.setWidth(15),this.setHeight(15)};JSFun.extend(ArtifactSymbol,Component),ArtifactSymbol.prototype.draw=function(t){if(this._visible){var e=this.getPixelX()+this._getMargin(),i=this.getPixelY()+this._getMargin();t.save(),t.strokeStyle=ComponentStyle.component_color,t.beginPath(),t.moveTo(e+5,i),t.lineTo(e+10,i),t.lineTo(e+15,i+5),t.lineTo(e+15,i+10),t.lineTo(e+5,i+10),t.lineTo(e+5,i),t.stroke(),t.beginPath(),t.moveTo(e+10,i),t.lineTo(e+10,i+5),t.lineTo(e+15,i+5),t.stroke(),t.restore()}};var AttributeItem=function(t){t=t||{},AttributeItem.baseConstructor.call(this,t);this._parse=new RegExp("^(?:«([^«»:={}\\x5B\\x5D]+)»)?([-|#|+|~])?([/])?([^«»:={}\\x5B\\x5D]+)?(?::([^«»:={}\\x5B\\x5D]+))?(?:=([^«»:={}\\x5B\\x5D]+)?)?(?:\\x5B([^«»:={}\\x5B\\x5D]+)\\x5D)?(?:{([^«»:={}\\x5B\\x5D]+)})?$"),this.setMinWidth(40)};JSFun.extend(AttributeItem,TextBox),AttributeItem.prototype.encode=function(t){var e="";return t[0]&&(e+="«"+t[0]+"»"),t[1]&&(e+=t[1]),t[2]&&(e+=t[2]),t[3]&&(e+=t[3]),t[4]&&(e+=":"+t[4]),t[5]&&(e+="="+t[5]),t[6]&&(e+="["+t[6]+"]"),t[7]&&(e+="{"+t[7]+"}"),this._parse.exec(e)?e:"wrong_attribute"},AttributeItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},AttributeItem.prototype.showDialog=function(){if(!this.active){var t=this;this.active=!0;var e,i,n=document.createElement("div"),o=document.createElement("form"),s=[];for(e=0;e<8;e++)s.push(document.createElement("input"));s[1]=document.createElement("select"),(i=document.createElement("option")).value="",i.appendChild(document.createTextNode("(none)")),s[1].appendChild(i),(i=document.createElement("option")).value="+",i.appendChild(document.createTextNode("+ (public)")),s[1].appendChild(i),(i=document.createElement("option")).value="-",i.appendChild(document.createTextNode("- (private)")),s[1].appendChild(i),(i=document.createElement("option")).value="#",i.appendChild(document.createTextNode("# (protected)")),s[1].appendChild(i),(i=document.createElement("option")).value="~",i.appendChild(document.createTextNode("~ (package)")),s[1].appendChild(i),s[2]=document.createElement("select"),(i=document.createElement("option")).value="",i.appendChild(document.createTextNode("no")),s[2].appendChild(i),(i=document.createElement("option")).value="/",i.appendChild(document.createTextNode("yes")),s[2].appendChild(i);var r=document.createElement("input");n.className="ud_popup";var h=this.decode(this.getValue());for(e=0;e<s.length;e++)s[e].type="text",s[e].value=h[e]||"";if(h[1]){var a=s[1].childNodes;for(e in a)a[e].value==h[1]&&a[e].setAttribute("selected","selected")}if(h[2]){a=s[2].childNodes;for(e in a)a[e].value==h[2]&&a[e].setAttribute("selected","selected")}r.setAttribute("type","submit"),r.setAttribute("value","OK"),this.changeText=function(e){if(t.active){var i,o=[];for(i=0;i<s.length;i++)o.push(s[i].value);t.setText(t.encode(o)),document.body.removeChild(n),t.active=!1,t.notifyChange()}},this.closeDialog=function(e){t.active&&(document.body.removeChild(n),t.active=!1,t.notifyChange())},o.onsubmit=function(){return!1},r.addEventListener("click",this.changeText,!1);var l,d,p=["stereotype","visibility","derived","name","type","default","multiplicity","restrictions"];for(e=0;e<s.length;e++)d=document.createElement("div"),(l=document.createElement("label")).appendChild(document.createTextNode(p[e])),d.appendChild(l),d.appendChild(s[e]),o.appendChild(d);if(o.appendChild(r),this.deletable){var c=document.createElement("input");c.setAttribute("type","submit"),c.setAttribute("value","delete"),this.deleteDialog=function(e){t.active&&(document.body.removeChild(n),t.active=!1,t.notifyDelete(),t.notifyChange())},c.addEventListener("click",this.deleteDialog,!1),o.appendChild(c)}n.appendChild(o),document.body.appendChild(n),n.style.top=(window.innerHeight-o.offsetHeight)/2+"px",n.style.left=(window.innerWidth-o.offsetWidth)/2+"px"}},AttributeItem.prototype.select=function(t,e){return Math.abs(t-(this.getPixelX()+this.getSuperWidth()-20))<=5&&Math.abs(e-(this.getPixelY()+8.66))<=5?(this.notifyToUp(),this.notifyChange(),!0):Math.abs(t-(this.getPixelX()+this.getSuperWidth()-30))<=5&&Math.abs(e-(this.getPixelY()+7.33))<=5?(this.notifyToDown(),this.notifyChange(),!0):AttributeItem.base.select.call(this,t,e)},AttributeItem.prototype.drawShape=function(t){if(this._visible){var e=this.getPixelX()+this.getSuperWidth()-35,i=this.getPixelY()+3;t.save(),t.fillStyle="#0000aa",t.beginPath(),t.moveTo(e,i),t.lineTo(e+10,i),t.lineTo(e+5,i+7),t.closePath(),t.fill(),e+=10,t.beginPath(),t.moveTo(e+5,i),t.lineTo(e,i+7),t.lineTo(e+10,i+7),t.closePath(),t.fill(),t.restore()}};var AttributeFields=function(t){t=t||{},AttributeFields.baseConstructor.call(this,t),this._default=t.text||"new_attribute"};JSFun.extend(AttributeFields,CollapsibleFields),AttributeFields.prototype.newItem=function(){return new AttributeItem({text:this._default})};var CircleSymbol=function(t){t=t||{},CircleSymbol.baseConstructor.call(this,t),this.setWidth(15),this.setHeight(15)};JSFun.extend(CircleSymbol,Component),CircleSymbol.prototype.draw=function(t){this._visible&&(t.save(),t.strokeStyle=ComponentStyle.component_color,t.beginPath(),t.arc(this.getPixelX()+this._getMargin()+7,this.getPixelY()+this._getMargin()+7,7,0,2*Math.PI,!0),t.stroke(),t.restore())};var ComponentSymbol=function(t){t=t||{},ComponentSymbol.baseConstructor.call(this,t),this.setWidth(15),this.setHeight(15)};JSFun.extend(ComponentSymbol,Component),ComponentSymbol.prototype.draw=function(t){if(this._visible){var e=this.getPixelX()+this._getMargin(),i=this.getPixelY()+this._getMargin();t.save(),t.strokeStyle=ComponentStyle.component_color,t.strokeRect(e+1,i+2,8,4),t.strokeRect(e+1,i+9,8,4),t.beginPath(),t.moveTo(e+5,i+2),t.lineTo(e+5,i),t.lineTo(e+15,i),t.lineTo(e+15,i+15),t.lineTo(e+5,i+15),t.lineTo(e+5,i+13),t.stroke(),t.beginPath(),t.moveTo(e+5,i+6),t.lineTo(e+5,i+9),t.stroke(),t.restore()}};var ConnectorItem=function(t){t=t||{},ConnectorItem.baseConstructor.call(this,t)};JSFun.extend(ConnectorItem,TextBox),ConnectorItem.prototype.setText=function(t){JSFun.isString(t)&&(this._text=t,""==t?this._orientation?this.setHeight(14):this.setWidth(14):this._orientation?this.setHeight(this._text.length*this._font_width):this.setWidth(this._text.length*this._font_width),this._orientation?this.setWidth(this._line_height):this.setHeight(this._line_height))},ConnectorItem.prototype.resize=function(){this._line_height=parseInt(this.getFontSize(),10)+1,this._font_width=this.getFontSize()/1.5;var t=this.getValue();t||(t=""),""==t?this._orientation?this.setHeight(14):this.setWidth(14):this._orientation?this.setHeight(t.length*this._font_width):this.setWidth(t.length*this._font_width),this._orientation?this.setWidth(this._line_height):this.setHeight(this._line_height)},ConnectorItem.prototype.getValue=function(){return this._text};var figureStyle={border:"#294253"},NodeFigure=function(t){t=t||{},this._changeFigureColor=0!=t.changeFigureColor,this._changeFigureLineWidth=0!=t.changeFigureLineWidth,t.color?this._color=t.color:this._color="#ffffff",t.lineColor?this._lineColor=t.lineColor:this._lineColor="#294253",t.lineWidth?this._lineWidth=t.Width:this._lineWidth=1};NodeFigure.prototype.draw=function(t,e,i,n,o){},NodeFigure.prototype.getColor=function(){return this._color},NodeFigure.prototype.setColor=function(t){this._changeFigureColor&&t&&(this._color=t)},NodeFigure.prototype.setLineColor=function(t){this._changeFigureColor&&t&&(this._lineColor=t)},NodeFigure.prototype.getLineColor=function(){return this._lineColor},NodeFigure.prototype.setLineWidth=function(t){this._changeFigureLineWidth&&JSFun.isNumber(t)&&(this._lineWidth=t)},NodeFigure.prototype.getLineWidth=function(){return this._lineWidth};var StickmanFigure=function(){};JSFun.extend(StickmanFigure,NodeFigure),StickmanFigure.prototype.draw=function(t,e,i,n,o){e=JSGraphic.toPixel(e),i=JSGraphic.toPixel(i),t.save(),t.strokeStyle="#000000",t.beginPath(),t.arc(e+n/2,i+n/4,n/4,0,2*Math.PI,!0),t.moveTo(e+n/2,i+n/2),t.lineTo(e+n/2,i+n/2+o/3),t.lineTo(e,i+o),t.moveTo(e+n/2,i+n/2+o/3),t.lineTo(e+n,i+o),t.moveTo(e,i+o/2),t.lineTo(e+n,i+o/2),t.stroke(),t.restore()};var EllipseFigure=function(t){t=t||{},EllipseFigure.baseConstructor.call(this,t)};JSFun.extend(EllipseFigure,NodeFigure),EllipseFigure.prototype.draw=function(t,e,i,n,o){var s=n/2,r=o/2;t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),JSGraphic.ellipse(t,e+s,i+r,s,r),t.stroke(),t.restore(),t.save(),t.fillStyle=this.getColor(),JSGraphic.ellipse(t,e+s,i+r,s,r),t.fill(),t.restore()};var HalfFilledEllipseFigure=function(t){t=t||{},HalfFilledEllipseFigure.baseConstructor.call(this,t)};JSFun.extend(HalfFilledEllipseFigure,EllipseFigure),HalfFilledEllipseFigure.prototype.draw=function(t,e,i,n,o){var s=n/2,r=o/2;t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.save(),t.fillStyle=this.getColor(),JSGraphic.ellipse(t,e+s,i+r,s,r),t.fill(),t.restore(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),JSGraphic.ellipse(t,e+s,i+r,s,r),t.stroke(),t.restore(),t.save(),t.fillStyle="#000000",JSGraphic.ellipse(t,e+s,i+r,.5*s,.5*r),t.fill(),t.restore()};var CrossEllipseFigure=function(t){t=t||{},CrossEllipseFigure.baseConstructor.call(this,t)};JSFun.extend(CrossEllipseFigure,EllipseFigure),CrossEllipseFigure.prototype.draw=function(t,e,i,n,o){var s=n/2,r=o/2,h=(Math.sqrt(n*n+o*o)-2*s)/2;t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),JSGraphic.ellipse(t,e+s,i+r,s,r),t.fill(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),JSGraphic.ellipse(t,e+s,i+r,s,r),t.moveTo(e+h,i+h),t.lineTo(e+n-h,i+o-h),t.moveTo(e+n-h,i+h),t.lineTo(e+h,i+o-h),t.stroke(),t.restore()};var CrossFigure=function(t){t=t||{},CrossFigure.baseConstructor.call(this,t)};JSFun.extend(CrossFigure,NodeFigure),CrossFigure.prototype.draw=function(t,e,i,n,o){t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.beginPath(),t.moveTo(e,i),t.lineTo(e+n,i+o),t.moveTo(e+n,i),t.lineTo(e,i+o),t.closePath(),t.stroke(),t.restore()};var RhombusFigure=function(t){t=t||{},RhombusFigure.baseConstructor.call(this,t)};JSFun.extend(RhombusFigure,NodeFigure),RhombusFigure.prototype.draw=function(t,e,i,n,o){t.save(),t.fillStyle="#ffffff",t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),JSGraphic.rhombus(t,e,i,n,o),t.fill(),t.stroke(),t.restore()};var RectangleFigure=function(t){t=t||{},RectangleFigure.baseConstructor.call(this,t)};JSFun.extend(RectangleFigure,NodeFigure),RectangleFigure.prototype.draw=function(t,e,i,n,o){var s=JSGraphic.toPixel(e),r=JSGraphic.toPixel(i);t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.fillRect(e,i,n,o),t.restore(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.strokeRect(s,r,n,o)};var ExpansionNodeFigure=function(t){t=t||{},ExpansionNodeFigure.baseConstructor.call(this,t)};JSFun.extend(ExpansionNodeFigure,NodeFigure),ExpansionNodeFigure.prototype.draw=function(t,e,i,n,o){var s=JSGraphic.toPixel(e),r=JSGraphic.toPixel(i);t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.fillRect(e,i,n,o),t.beginPath(),n<o?(t.moveTo(s,JSGraphic.toPixel(i+o/4)),t.lineTo(s+n,r+JSGraphic.toPixel(o/4)),t.moveTo(s,JSGraphic.toPixel(r+o/4*2)),t.lineTo(s+n,JSGraphic.toPixel(r+o/4*2)),t.moveTo(s,JSGraphic.toPixel(r+o/4*3)),t.lineTo(s+n,JSGraphic.toPixel(r+o/4*3))):(t.moveTo(JSGraphic.toPixel(e+n/4),r),t.lineTo(s+JSGraphic.toPixel(n/4),r+o),t.moveTo(JSGraphic.toPixel(s+n/4*2),r),t.lineTo(JSGraphic.toPixel(s+n/4*2),r+o),t.moveTo(JSGraphic.toPixel(s+n/4*3),r),t.lineTo(JSGraphic.toPixel(s+n/4*3),r+o)),t.closePath(),t.stroke(),t.restore(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.strokeRect(s,r,n,o)};var RoundedRectangleFigure=function(t){t=t||{},RoundedRectangleFigure.baseConstructor.call(this,t)};JSFun.extend(RoundedRectangleFigure,NodeFigure),RoundedRectangleFigure.prototype.draw=function(t,e,i,n,o){e=JSGraphic.toPixel(e),i=JSGraphic.toPixel(i);t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.beginPath(),t.moveTo(e+4,i),t.lineTo(e+n-4,i),t.quadraticCurveTo(e+n,i,e+n,i+4),t.lineTo(e+n,i+o-4),t.quadraticCurveTo(e+n,i+o,e+n-4,i+o),t.lineTo(e+4,i+o),t.quadraticCurveTo(e,i+o,e,i+o-4),t.lineTo(e,i+4),t.quadraticCurveTo(e,i,e+4,i),t.closePath(),t.fill(),t.restore(),t.save(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.beginPath(),t.moveTo(e+4,i),t.lineTo(e+n-4,i),t.quadraticCurveTo(e+n,i,e+n,i+4),t.lineTo(e+n,i+o-4),t.quadraticCurveTo(e+n,i+o,e+n-4,i+o),t.lineTo(e+4,i+o),t.quadraticCurveTo(e,i+o,e,i+o-4),t.lineTo(e,i+4),t.quadraticCurveTo(e,i,e+4,i),t.stroke(),t.restore()};var RegionFigure=function(t){t=t||{},RegionFigure.baseConstructor.call(this,t)};JSFun.extend(RegionFigure,NodeFigure),RegionFigure.prototype.draw=function(t,e,i,n,o,s,r,h){s=s||15,r=r||75,h=h||15;e=JSGraphic.toPixel(e),i=JSGraphic.toPixel(i);t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.beginPath(),t.fillRect(e+15,i,r,s),i+=s,o-=s,t.moveTo(e+4,i),t.lineTo(e+n-4,i),t.quadraticCurveTo(e+n,i,e+n,i+4),t.lineTo(e+n,i+o-4),t.quadraticCurveTo(e+n,i+o,e+n-4,i+o),t.lineTo(e+4,i+o),t.quadraticCurveTo(e,i+o,e,i+o-4),t.lineTo(e,i+4),t.quadraticCurveTo(e,i,e+4,i),t.closePath(),t.fill(),t.restore(),i-=s,o+=s,t.save(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.beginPath(),t.strokeRect(e+15,i,r,s),i+=s,o-=s,t.moveTo(e+4,i),t.lineTo(e+n-4,i),t.quadraticCurveTo(e+n,i,e+n,i+4),t.lineTo(e+n,i+o-4),t.quadraticCurveTo(e+n,i+o,e+n-4,i+o),t.lineTo(e+4,i+o),t.quadraticCurveTo(e,i+o,e,i+o-4),t.lineTo(e,i+4),t.quadraticCurveTo(e,i,e+4,i),t.stroke(),t.restore()};var PackageFigure=function(t){t=t||{},PackageFigure.baseConstructor.call(this,t)};JSFun.extend(PackageFigure,NodeFigure),PackageFigure.prototype.draw=function(t,e,i,n,o){t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.fillRect(e,i,60,15),t.fillRect(e,i+15,n,o-15),t.restore(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.strokeRect(e+.5,i+.5,60,15),t.strokeRect(e+.5,i+15.5,n,o-15)};var NoteFigure=function(t){t=t||{},NoteFigure.baseConstructor.call(this,t)};JSFun.extend(NoteFigure,NodeFigure),NoteFigure.prototype.draw=function(t,e,i,n,o){e=JSGraphic.toPixel(e),i=JSGraphic.toPixel(i),t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.beginPath(),t.moveTo(e,i),t.lineTo(e+n-15,i),t.lineTo(e+n,i+15),t.lineTo(e+n,i+o),t.lineTo(e,i+o),t.closePath(),t.fill(),t.restore(),t.save(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.stroke(),t.beginPath(),t.moveTo(e+n-15,i),t.lineTo(e+n-15,i+15),t.lineTo(e+n,i+15),t.stroke(),t.restore()};var FromImageFigure=function(t){t=t||{},NoteFigure.baseConstructor.call(this,t),t.route&&(this.route=t.route,this.load=!0,this.image=new Image,this.image.setAttribute("src",this.route)),this._associatedStereotypes=[]};JSFun.extend(FromImageFigure,NodeFigure),FromImageFigure.prototype.addAssociatedStereotype=function(t){this._associatedStereotypes.push(t)},FromImageFigure.prototype.delAssociatedStereotype=function(t){for(var e=0;e<this._associatedStereotypes.length;e++)if(this._associatedStereotypes[e]==t){this._associatedStereotypes.splice(e,1);break}},FromImageFigure.prototype.foundInAssociatedStereotypes=function(t){for(var e=0;e<this._associatedStereotypes.length;e++)if(this._associatedStereotypes[e]==t)return!0;return!1},FromImageFigure.prototype.draw=function(t,e,i,n,o){if(this.load)try{t.drawImage(this.image,e,i,n,o)}catch(t){}};var LifelineFigure=function(t){t=t||{},LifelineFigure.baseConstructor.call(this,t)};JSFun.extend(LifelineFigure,NodeFigure),LifelineFigure.prototype.draw=function(t,e,i,n,o,s){s=s||25;var r=JSGraphic.toPixel(e+n/2);t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.fillRect(e,i,n,s),t.restore(),t.save(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.strokeRect(e+.5,i+.5,n,s),t.restore(),JSGraphic.dashedLine(t,r,i+s,r,i+o,10)};var AcceptEventActionFigure=function(t){t=t||{},AcceptEventActionFigure.baseConstructor.call(this,t)};JSFun.extend(AcceptEventActionFigure,NodeFigure),AcceptEventActionFigure.prototype.draw=function(t,e,i,n,o){e=JSGraphic.toPixel(e),i=JSGraphic.toPixel(i);t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.beginPath(),t.moveTo(e,i),t.lineTo(e+n,i),t.lineTo(e+n,i+o),t.lineTo(e,i+o),t.lineTo(e+25,i+o/2),t.closePath(),t.fill(),t.restore(),t.save(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.beginPath(),t.moveTo(e,i),t.lineTo(e+n,i),t.lineTo(e+n,i+o),t.lineTo(e,i+o),t.lineTo(e+25,i+o/2),t.lineTo(e,i),t.stroke(),t.restore()};var TimeEventFigure=function(t){t=t||{},TimeEventFigure.baseConstructor.call(this,t)};JSFun.extend(TimeEventFigure,NodeFigure),TimeEventFigure.prototype.draw=function(t,e,i,n,o){e=JSGraphic.toPixel(e),i=JSGraphic.toPixel(i);t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.strokeStyle=figureStyle.border,t.fillStyle=this.getColor(),t.beginPath(),t.moveTo(e,i),t.lineTo(e+n,i),t.lineTo(e+n/2,i+o/2),t.closePath(),t.fill(),t.beginPath(),t.moveTo(e,i+o),t.lineTo(e+n,i+o),t.lineTo(e+n/2,i+o/2),t.closePath(),t.fill(),t.restore(),t.save(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.beginPath(),t.moveTo(e,i),t.lineTo(e+n,i),t.lineTo(e+n/2,i+o/2),t.lineTo(e,i),t.stroke(),t.beginPath(),t.moveTo(e,i+o),t.lineTo(e+n,i+o),t.lineTo(e+n/2,i+o/2),t.lineTo(e,i+o),t.stroke(),t.restore()};var SendSignalActionFigure=function(t){t=t||{},SendSignalActionFigure.baseConstructor.call(this,t)};JSFun.extend(SendSignalActionFigure,NodeFigure),SendSignalActionFigure.prototype.draw=function(t,e,i,n,o){e=JSGraphic.toPixel(e),i=JSGraphic.toPixel(i);t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.beginPath(),t.moveTo(e,i),t.lineTo(e+n-25,i),t.lineTo(e+n,i+o/2),t.lineTo(e+n-25,i+o),t.lineTo(e,i+o),t.closePath(),t.fill(),t.restore(),t.save(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.beginPath(),t.moveTo(e,i),t.lineTo(e+n-25,i),t.lineTo(e+n,i+o/2),t.lineTo(e+n-25,i+o),t.lineTo(e,i+o),t.lineTo(e,i),t.stroke(),t.restore()};var SwimlaneFigure=function(t){t=t||{},SwimlaneFigure.baseConstructor.call(this,t)};JSFun.extend(SwimlaneFigure,NodeFigure),SwimlaneFigure.prototype.draw=function(t,e,i,n,o){e=JSGraphic.toPixel(e),i=JSGraphic.toPixel(i);t.save(),t.lineWidth=2.5,t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.beginPath(),t.moveTo(e+n,i),t.lineTo(e,i),t.lineTo(e,i+o),t.lineTo(e+n,i+o),t.stroke(),t.restore()};var VerticalSwimlaneFigure=function(t){t=t||{},VerticalSwimlaneFigure.baseConstructor.call(this,t)};JSFun.extend(VerticalSwimlaneFigure,NodeFigure),VerticalSwimlaneFigure.prototype.draw=function(t,e,i,n,o){e=JSGraphic.toPixel(e),i=JSGraphic.toPixel(i);t.save(),t.lineWidth=2.5,t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.beginPath(),t.moveTo(e,i+o),t.lineTo(e,i),t.lineTo(e+n,i),t.lineTo(e+n,i+o),t.stroke(),t.restore()};var TriangleFigure=function(t){(t=t||{}).direction&&JSFun.isNumber(t.direction)&&this.setDirection(t.direction),TriangleFigure.baseConstructor.call(this,t)};JSFun.extend(TriangleFigure,NodeFigure),TriangleFigure.prototype.draw=function(t,e,i,n,o){t.save(),t.fillStyle="#ffffff",t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),JSGraphic.triangle(t,e,i,n,o,this.getDirection()),t.fill(),t.stroke(),t.restore()},TriangleFigure.prototype.setDirection=function(t){JSFun.isNumber(t)&&(this._direction=t)},TriangleFigure.prototype.getDirection=function(){return JSFun.isNumber(this._direction)?this._direction:0};var CubeFigure=function(t){t=t||{},CubeFigure.baseConstructor.call(this,t)};JSFun.extend(CubeFigure,NodeFigure),CubeFigure.prototype.draw=function(t,e,i,n,o){var s=JSGraphic.toPixel(e),r=JSGraphic.toPixel(i);t.save(),t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=2,t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=this.getColor(),t.fillRect(e,i,n,o),t.restore(),t.save(),t.fillStyle=this.getColor(),t.beginPath(),t.moveTo(s+10,r-10),t.lineTo(s+10+n,r-10),t.lineTo(s+10+n,r+o-10),t.lineTo(s+n,r+o),t.lineTo(s+n,r),t.lineTo(s,r),t.closePath(),t.fill(),t.restore(),t.save(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.strokeRect(s,r,n,o),t.restore(),t.save(),t.strokeStyle=this.getLineColor(),t.lineWidth=this.getLineWidth(),t.beginPath(),t.moveTo(s+10,r-10),t.lineTo(s+10+n,r-10),t.lineTo(s+10+n,r+o-10),t.lineTo(s+n,r+o),t.lineTo(s+n,r),t.lineTo(s,r),t.lineTo(s+10,r-10),t.moveTo(s+n,r),t.lineTo(s+10+n,r-10),t.stroke(),t.restore()};var NodeStyle={shape_color:"rgb( 0, 0, 0 )",control:""},Node=function(t){t=t||{},this._id=0,this._type="untyped",this._x=t.x||0,this._y=t.y||0,this._prex=this._x,this._prey=this._y,this._relx=0,this._rely=0,this._width=10,this._height=10,this._minHeight=5,this._minWidth=5,this._selected=!1,this._selectedBefore=!1,this._resizing=!1,this._moved=!1,this._moveable=!1,this._proportional=!1,this._container=!1,this._alone=!1,this._figures=[],this._components=[],this._activeComponent=null,this._diagram=null,this._parent=null,this._nodeChilds=[],this._relationChilds=[],this._relations=[],this._menu=[],this._tagValues=[],this._selectedFigure=0,this._beforeNameComponent=null,this._visible=!0,this._beforeHeight=0,this._beforeWidth=0};JSFun.extend(Node,Element),Node.prototype.setAlone=function(){this._alone=!0},Node.prototype.isAlone=function(){return this._alone},Node.prototype.setId=function(t){this._id=this.getType()+"_"+t},Node.prototype.getId=function(){return this._diagram.getId()+":"+this._id},Node.prototype.setType=function(t){"untyped"==this._type&&JSFun.isString(t)&&(this._type=t)},Node.prototype.getType=function(){return this._type},Node.prototype.getElementXML=function(t){var e,i=t.createElement(this.getType()),n=[];for(this._selectedFigure&&this.setSelectedFigure(0),i.setAttribute("id",this.getId()),i.setAttribute("x",this.getX()),i.setAttribute("y",this.getY()),i.setAttribute("width",this.getWidth()),i.setAttribute("height",this.getHeight()),i.setAttribute("backgroundColor",this.getBackgroundColor()),this.getLineColor()&&i.setAttribute("lineColor",this.getLineColor()),this.getLineWidth()&&i.setAttribute("lineWidth",this.getLineWidth()),this.getFontColor()&&i.setAttribute("fontColor",this.getFontColor()),this.getFontFamily()&&i.setAttribute("fontFamily",this.getFontFamily()),this.getFontSize()&&i.setAttribute("fontSize",this.getFontSize()),this.getFontStyle()&&i.setAttribute("fontStyle",this.getFontStyle()),this.getFontWeight()&&i.setAttribute("fontWeight",this.getFontWeight()),e=0;e<this._tagValues.length;e++)n.push(this._tagValues[e][0]+":"+this._tagValues[e][1]);i.setAttribute("tagValues",n);for(e in this._components)this._components[e].getId()&&i.appendChild(this._components[e].getComponentXML(t));for(e in this._nodeChilds)i.appendChild(this._nodeChilds[e].getElementXML(t));for(e in this._relationChilds)i.appendChild(this._relationChilds[e].getElementXML(t));return i},Node.prototype.setElementXML=function(t){this.setPosition(parseInt(t.getAttribute("x")),parseInt(t.getAttribute("y"))),this.resetMovement(),this.setWidth(parseInt(t.getAttribute("width"))),this.setHeight(parseInt(t.getAttribute("height"))),this.setBackgroundColor(t.getAttribute("backgroundColor")),t.getAttribute("lineColor")&&this.setLineColor(t.getAttribute("lineColor")),t.getAttribute("lineWidth")&&this.setLineWidth(parseInt(t.getAttribute("lineWidth"))),t.getAttribute("fontColor")&&this.setFontColor(t.getAttribute("fontColor")),t.getAttribute("fontFamily")&&this.setFontFamily(t.getAttribute("fontFamily")),t.getAttribute("fontSize")&&this.setFontSize(t.getAttribute("fontSize")),t.getAttribute("fontStyle")&&this.setFontStyle(t.getAttribute("fontStyle")),t.getAttribute("fontWeight")&&this.setFontWeight(t.getAttribute("fontWeight"));for(var e,i,n=t.getAttribute("tagValues"),o=[];""!=n;)-1==(e=n.indexOf(","))?(o.push(n),n=""):(o.push(n.substring(0,e)),n=n.substring(e+1));this.setTagValues(o);var s=t.childNodes;for(i=0;i<s.length;i++){var r;for(r in this._components)this._components[r].getId()==s[i].getAttribute("id")&&(this._components[r].setComponentXML(s[i]),this.updateComponents())}this.notifyDraw()},Node.prototype.setValue=function(t,e){var i;for(i in this._components)if(!(this._components[i]instanceof SuperComponent)&&this._components[i].getId()==t)return this._components[i].setValue(e),this.updateComponents(),!0;return!1},Node.prototype.addValue=function(t,e){var i;for(i in this._components)if(this._components[i]instanceof SuperComponent&&this._components[i].getId()==t)return this._components[i].addField(e),this.updateComponents(),!0;return!1},Node.prototype.addChild=function(t){t instanceof Node?(this._nodeChilds.push(t),t.setParent(this)):t instanceof Relation&&(this._relationChilds.push(t),t.setParent(this))},Node.prototype.delChild=function(t){var e;if(t instanceof Node){for(e in this._nodeChilds)if(this._nodeChilds[e]==t){this._nodeChilds.splice(e,1),t.setParent();break}}else if(t instanceof Relation)for(e in this._relationChilds)if(this._relationChilds[e]==t){this._relationChilds.splice(e,1),t.setParent();break}},Node.prototype.addRelation=function(t){t instanceof Relation&&this._relations.push(t)},Node.prototype.delRelation=function(t){var e;for(e in this._relations)if(this._relations[e]==t){this._relations.splice(e,1);break}},Node.prototype.setDiagram=function(t){t instanceof Diagram&&(this._diagram=t)},Node.prototype.notifyDraw=function(){this._diagram&&this._diagram.draw()},Node.prototype.notifyChange=function(){if(this._resizing=!0,this._container){if(this.updateContainer(),this._parent)for(var t=this._parent.getParent();t;)t instanceof SuperNode?(t.notifyChange(!0),t=null):t=t._parent}else if(this.updateComponents(),this._parent){this._parent.updateContainer();for(t=this._parent.getParent();t;)t instanceof SuperNode?(t.notifyChange(!0),t=null):t=t._parent}this._resizing=!1},Node.prototype.getX=function(){return this._x},Node.prototype.getY=function(){return this._y},Node.prototype.width=function(t){return!!JSFun.isNumber(t)&&(this.setWidth(t),this.notifyChange(),!0)},Node.prototype.height=function(t){return!!JSFun.isNumber(t)&&(this.setHeight(t),this.notifyChange(),!0)},Node.prototype.position=function(t,e){return!(!JSFun.isNumber(t)||!JSFun.isNumber(e))&&(this.setPosition(t,e),this.updatePosition(),this.resetMovement(),!0)},Node.prototype.setPosition=function(t,e){JSFun.isNumber(t)&&JSFun.isNumber(e)&&(this._x=t,this._y=e)},Node.prototype.getMovement=function(){return new Point(this._x-this._prex,this._y-this._prey)},Node.prototype.resetMovement=function(){this._prex=this._x,this._prey=this._y},Node.prototype.deselect=function(){this.deselectComponent(),this._selectedBefore=!1,this._selected=!1},Node.prototype.deselectComponent=function(){this._activeComponent&&(this._activeComponent.deselect(),this._activeComponent=null)},Node.prototype.select=function(t,e){if(!this._visible)return!1;if(this.deselectComponent(),this._diagram._activeMenu&&this.removeContextualMenu(),1==this._diagram._pressMouse||1==this._diagram._touch){if(this._selected){var i=this._diagram._touch?7:0;if(this._moveable&&Math.abs(t-(this._x+this._width+2.5))<=2.5+i&&Math.abs(e-(this._y+this._height+2.5))<=2.5+i)return this._resizing=!0,this._component=!1,!0}if(this._selected){i=this._diagram._touch?4:2;if(this.isOverComponent(t,e,i))return this._relx=t-this._x,this._rely=e-this._y,this._selectedBefore=!0,this._component=!0,!0}return!!this.isOver(t,e)&&(this._relx=t-this._x,this._rely=e-this._y,this._selectedBefore=this._selected,this._component=!1,this._selected=!0,!0)}if(1==this._diagram._pressMouseRight||1==this._diagram._hold){if(this.isOver(t,e)){this.disableDefaultContextualMenu();var n=document.documentElement.scrollTop||document.body.scrollTop;return t+=this._diagram._div.offsetLeft,e=n?e-n+this._diagram._div.offsetTop:e+this._diagram._div.offsetTop,this.showContextualMenu(t,e),!0}return!1}},Node.prototype.showContextualMenu=function(t,e){if(!this._diagram._activeMenu&&this._menu.length){this._diagram._activeMenu=!0;var i=document.createElement("div");i.className="ud_contextualMenu",i.style.cursor="pointer";for(var n=0;n<this._menu.length;n++)this.addItem(this._menu[n],i);document.body.appendChild(i),this._diagram._divMenu=i,i.style.top=e+"px",i.style.left=t+"px"}},Node.prototype.removeContextualMenu=function(){this._diagram._activeMenu&&(this.showDefaultContextualMenu(),document.body.removeChild(this._diagram._divMenu),this._diagram._activeMenu=!1,this.notifyDraw())},Node.prototype.showDefaultContextualMenu=function(){document.oncontextmenu=function(){return!0}},Node.prototype.disableDefaultContextualMenu=function(){document.oncontextmenu=function(){return!1}},Node.prototype.addItem=function(t,e){var i=document.createElement("div");i.className="ud_contextualMenuItem";var n=document.createElement("span");n.appendChild(document.createTextNode(t[1])),i.appendChild(n),e.appendChild(i),i.addEventListener("mouseup",t[0],!1)},Node.prototype.showStyleDialog=function(t){var e=t.that||this,n=e._Backgroundcolor,o=e._lineColor,s=e._textColor,r=e._Backgroundcolor.split("#")[1],h=new Array(parseInt(r.slice(0,2),16),parseInt(r.slice(2,4),16),parseInt(r.slice(4,6),16)),a=document.createElement("div");a.className="ud_popupStyle";var l=document.createElement("div");l.setAttribute("id","divBlock1");var d=document.createElement("div");d.setAttribute("id","divBlock2");var p=document.createElement("div");p.setAttribute("id","colorHtml"),p.style.color="#ffffff";var c=document.createElement("div");c.setAttribute("id","red");var u=document.createElement("canvas");u.setAttribute("id","R"),u.width=150,u.height=20,c.appendChild(u);var _=u.getContext("2d"),g=document.createElement("div");g.setAttribute("id","green");var m=document.createElement("canvas");m.setAttribute("id","G"),m.width=150,m.height=20,g.appendChild(m);var f=m.getContext("2d"),v=document.createElement("div");v.setAttribute("id","blue");var y=document.createElement("canvas");y.setAttribute("id","B"),y.width=150,y.height=20,v.appendChild(y);var C=y.getContext("2d"),b=document.createElement("div");b.setAttribute("id","divSelectColor");var x=document.createElement("canvas");x.setAttribute("id","selectColor"),x.width=90,x.height=90,b.appendChild(x);var S=x.getContext("2d"),w=document.createElement("form"),T=document.createElement("div");T.setAttribute("id","divRadio");var F=document.createElement("label");F.innerHTML="Background color";var A=document.createElement("input");A.setAttribute("id","radio_background"),A.setAttribute("type","radio"),A.setAttribute("name","radio"),A.setAttribute("value","background"),A.setAttribute("checked","true"),F.appendChild(A);var P=document.createElement("label");P.innerHTML="Line color";var E=document.createElement("input");E.setAttribute("id","radio_line"),E.setAttribute("type","radio"),E.setAttribute("name","radio"),E.setAttribute("value","line"),P.appendChild(E);var N=document.createElement("label");N.innerHTML="Text color";var W=document.createElement("input");W.setAttribute("id","radio_text"),W.setAttribute("type","radio"),W.setAttribute("name","radio"),W.setAttribute("value","text"),N.appendChild(W),T.appendChild(P),T.appendChild(N),T.appendChild(F);var L=[A,E,W],M=document.createElement("div");M.setAttribute("id","divFont");var R=document.createElement("input");R.setAttribute("type","number"),R.setAttribute("name","size"),R.setAttribute("value",parseInt(e._fontSize)||"12"),R.setAttribute("style","width: 40px");var I=document.createElement("label");I.innerHTML=" Font size ",I.setAttribute("for","size");var B=document.createElement("input");B.setAttribute("type","text"),B.setAttribute("name","family"),B.setAttribute("value",e._fontFamily||"monospace"),B.setAttribute("style","width: 70px");var k=document.createElement("label");k.innerHTML="Font family ",k.setAttribute("for","family");var X=document.createElement("input");X.setAttribute("type","number"),X.setAttribute("name","width"),X.setAttribute("value",e._lineWidth||"2"),X.setAttribute("style","width: 40px");var H=document.createElement("label");H.innerHTML=" Line width ",H.setAttribute("for","width"),M.appendChild(k),M.appendChild(B),M.appendChild(I),M.appendChild(R),M.appendChild(H),M.appendChild(X);var D=document.createElement("select");D.name="weight";var Y=e._fontWeight||"normal";for(D.add(new Option("Normal","normal")),D.add(new Option("Bold","bold")),D.add(new Option("Bolder","bolder")),i=0;i<D.length;i++)D.options[i].value==Y&&(D.options[i].selected=!0);D.style="width: 85px";var O=document.createElement("label");O.innerHTML=" Text weight ",O.setAttribute("for","weight");var J=document.createElement("select");for(J.name="style",Y=e._fontStyle||"normal",J.add(new Option("Normal","normal")),J.add(new Option("Italic","italic")),J.add(new Option("Oblique","oblique")),i=0;i<J.length;i++)J.options[i].value==Y&&(J.options[i].selected=!0);J.style="width: 85px";var z=document.createElement("label");z.innerHTML="Text style ",z.setAttribute("for","style");var V=document.createElement("input");V.setAttribute("type","submit"),V.setAttribute("value","OK");var G=document.createElement("input");G.setAttribute("type","submit"),G.setAttribute("value","Cancel");var U=document.createElement("input");U.setAttribute("title","Click here to use the advanced color picker"),U.setAttribute("type","color"),U.setAttribute("id","color");var q=document.createElement("input");q.setAttribute("type","submit"),q.setAttribute("title","Click here to use the selected color in the color picker"),q.setAttribute("value","Adjust color");var K=function(t){var e=tt();e||(e="#000000"),$(e),e=e.split("#")[1];var i=new Array(parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16));_.clearRect(0,0,parseInt(u.width),u.height),j(u,_,i[0],"#ff0000"),f.clearRect(0,0,parseInt(m.width),u.height),j(m,f,i[1],"#00ff00"),C.clearRect(0,0,parseInt(y.width),u.height),j(y,C,i[2],"#0000ff")};A.addEventListener("click",K,!1),E.addEventListener("click",K,!1),W.addEventListener("click",K,!1),V.addEventListener("click",function(t){e.setFontFamily(B.value),e.setFontSize(parseInt(R.value,10)),e.setLineWidth(parseFloat(X.value,10)),e.setFontStyle(J.options[J.selectedIndex].value),e.setFontWeight(D.options[D.selectedIndex].value),e.notifyDraw(),document.body.removeChild(a)},!1),G.addEventListener("click",function(t){e.setBackgroundColor(n),e.setLineColor(o),e.setFontColor(s),document.body.removeChild(a)},!1),q.addEventListener("click",function(t){for(coll=document.getElementById("color").value,$(coll),coll2=coll,coll=coll.substring(1,7),coll_R=parseInt(coll.slice(0,2),16),coll_G=parseInt(coll.slice(2,4),16),coll_B=parseInt(coll.slice(4,6),16),h[0]=coll_R,h[1]=coll_G,h[2]=coll_B,_.clearRect(0,0,parseInt(u.width),u.height),j(u,_,coll_R,"#ff0000"),f.clearRect(0,0,parseInt(m.width),u.height),j(m,f,coll_G,"#00ff00"),C.clearRect(0,0,parseInt(y.width),u.height),j(y,C,coll_B,"#0000ff");p.hasChildNodes();)p.removeChild(p.lastChild);var e=document.createElement("font");e.style.color="#"+coll;var i=document.createTextNode("#"),n=document.createTextNode(coll.toUpperCase());e.appendChild(i),e.appendChild(n),p.appendChild(e),et(coll2)},!1),w.onsubmit=function(){return!1},V.focus(),w.appendChild(U),w.appendChild(q),w.appendChild(document.createElement("hr")),w.appendChild(T),w.appendChild(document.createElement("hr")),w.appendChild(M),w.appendChild(z),w.appendChild(J),w.appendChild(O),w.appendChild(D),w.appendChild(document.createElement("br")),w.appendChild(V),w.appendChild(G),l.appendChild(p),l.appendChild(c),l.appendChild(g),l.appendChild(v),l.appendChild(w),a.appendChild(l),d.appendChild(b),d.appendChild(document.createElement("div")),a.appendChild(d);var j=function(t,e,i,n){0==i?i=.1:120==i&&(i=119.9),e.save(),e.font="12px monospace",e.textBaseline="middle",e.fillStyle="#ffffff",e.fillText(t.getAttribute("id"),0,t.height/2),e.restore(),e.save(),e.beginPath(),e.fillStyle=n,e.fillRect(20,0,parseInt(t.width)-50,u.height),e.closePath(),e.restore(),e.fillStyle="#000000",e.beginPath(),e.arc(20+100*i/255,parseInt(t.height)/2,4,0,2*Math.PI,!0),e.closePath(),e.fill(),e.save(),e.font="12px monospace",e.textBaseline="middle",e.fillStyle="#ffffff",e.fillText(parseInt(i),125,t.height/2),e.restore()},$=function(t){S.save(),S.beginPath(),S.fillStyle=t,S.fillRect(20,20,80,80),S.closePath(),S.restore()},Z=function(t){for(var e=function(t){var e="0123456789ABCDEF",i=parseInt(t)%16,n=(parseInt(t)-i)/16;return hex=""+e.charAt(n)+e.charAt(i),hex},i=e(t[0])+e(t[1])+e(t[2]);p.hasChildNodes();)p.removeChild(p.lastChild);var n=document.createElement("font");n.style.color="#"+i;var o=document.createTextNode("#"),s=document.createTextNode(i);n.appendChild(o),n.appendChild(s),p.appendChild(n),et("#"+i)},Q=function(t){var e=t.pageX-a.offsetLeft-this.offsetLeft;t.pageY,this.offsetTop;"red"==this.getAttribute("id")&&(h[0]=255*(e-20)/100,h[0]>255&&(h[0]=255),h[0]<0&&(h[0]=0),_.clearRect(0,0,parseInt(u.width),u.height),j(u,_,h[0],"#ff0000")),"green"==this.getAttribute("id")&&(h[1]=255*(e-20)/100,h[1]>255&&(h[1]=255),h[1]<0&&(h[1]=0),f.clearRect(0,0,parseInt(m.width),m.height),j(m,f,h[1],"#00ff00")),"blue"==this.getAttribute("id")&&(h[2]=255*(e-20)/100,h[2]>255&&(h[2]=255),h[2]<0&&(h[2]=0),C.clearRect(0,0,parseInt(y.width),y.height),j(y,C,h[2],"#0000ff")),Z(h),$(tt())},tt=function(){for(var t=0;t<L.length&&!L[t].checked;t++);switch(L[t].value){case"background":return e.getBackgroundColor();case"line":return e.getLineColor();case"text":return e.getFontColor()}return e.getBackgroundColor()},et=function(t){for(var i=0;i<L.length&&!L[i].checked;i++);switch(L[i].value){case"background":e.setBackgroundColor(t);break;case"line":e.setLineColor(t);break;case"text":e.setFontColor(t)}};j(u,_,h[0],"#ff0000"),j(m,f,h[1],"#00ff00"),j(y,C,h[2],"#0000ff"),$(e._Backgroundcolor),Z(h),c.addEventListener("mousedown",Q,!1),g.addEventListener("mousedown",Q,!1),v.addEventListener("mousedown",Q,!1),document.body.appendChild(a),a.style.top=(window.innerHeight-parseInt(a.offsetHeight))/2+"px",a.style.left=(window.innerWidth-parseInt(a.offsetWidth))/2+"px"},Node.prototype.setTagValues=function(t){if(!JSFun.isArray(t))return!1;for(var e,i="",n="",o=0;o<t.length;o++)-1==(e=t[o].indexOf(":"))?i=t[o].substring(0):(i=t[o].substring(0,e),n=t[o].substring(e+1)),this.foundInTagValues(this._tagValues,i)||this._tagValues.push([i,n]);return!0},Node.prototype.foundInTagValues=function(t,e){for(var i=0;i<t.length;i++)if(t[i][0]==e)return!0;return!1},Node.prototype.setMenu=function(t){t instanceof Array&&(this._menu=t)},Node.prototype.getMenu=function(){return this._menu},Node.prototype.drag=function(t,e){if(this._resizing){var i=t-this._x,n=e-this._y;i=Math.round(i),i-=i%5,n=Math.round(n);var o=i,s=n-=n%5;if(this._proportional){var r=this._width/this._height;o>s?s=o/r:o=s*r}this.setWidth(o),this.setHeight(s)}else if(this._selected){i=t-this._relx,n=e-this._rely;i=Math.round(i),i-=i%5,n=n=Math.round(n),this.setPosition(i,n),this._moved=!0}},Node.prototype.drop=function(t,e){if(this._moved){if(this._alone||this._diagram.checkForParent(this),this.updatePosition(),this._parent){this._parent.updateContainer();for(var i=this._parent.getParent();i;)i instanceof SuperNode?(i.notifyChange(!0),i=null):i=i._parent}}else if(this._resizing){if(this.updatePosition(),this instanceof SuperNode){this.notifyChange(!0,!0)}else this.notifyChange();if(this._parent){this._parent.updateContainer();for(i=this._parent.getParent();i;)i instanceof SuperNode?(i.notifyChange(!0,!0),i=null):i=i._parent}}else this._selectedBefore&&this.selectComponent(t,e);this._moved=!1,this._resizing=!1},Node.prototype.setContainer=function(){this._container=!0},Node.prototype.isContainer=function(){return!!this._container},Node.prototype.isChildOf=function(t){return null!=this._parent&&(this._parent==t||this._parent.isChildOf(t))},Node.prototype.setParent=function(t){t instanceof Node&&t._container?this._parent=t:this._parent=null},Node.prototype.getParent=function(){return this._parent},Node.prototype.updateContainer=function(t){if(0!=t&&1!=t&&(t=!0),this._container){var e,i,n,o,s,r,h=this._x,a=this._y,l=this._x,d=this._y;for(e in this._nodeChilds)(i=this._nodeChilds[e])._visible&&(s=i._x,r=i._y,n=i._x+i._width,o=i._y+i._height,n>l&&(l=n),o>d&&(d=o),s<h&&(h=s),r<a&&(a=r));h<this._x||a<this._y?(this.setWidth(this._x-h+this._width),this.setHeight(this._y-a+this._height),this._x=h,this._y=a,this.setMinWidth(l-h),this.setMinHeight(d-a)):(this.setMinWidth(l-this._x),this.setMinHeight(d-this._y)),this._prex=this._x,this._prey=this._y,this.updateComponents(),this._parent&&t&&this._parent.updateContainer()}},Node.prototype.updatePosition=function(t,e,i){var n;if(i=i||!1,void 0==t||void 0==e){var o=this.getMovement();t=o.getX(),e=o.getY();for(n in this._relations)this._relations[n].updatePosition()}else this._x+=t,this._y+=e;this.resetMovement();for(n in this._components)this._components[n].updatePosition(t,e);for(n in this._relations){var s=this._relations[n].getParent();(s==this._parent||s instanceof SuperNode&&s==this._parent._parent)&&!i||this._relations[n].notifyChange()}if(this._container){for(n in this._nodeChilds)this._nodeChilds[n].updatePosition(t,e);for(n in this._relationChilds)this._relationChilds[n].updatePosition(t,e)}},Node.prototype.getParticularWidth=function(t){return t>=this._y&&t<=this._y+this._height?[this._x,this._width]:[0,0]},Node.prototype.getParticularHeight=function(t){return t>=this._x&&t<=this._x+this._width?[this._y,this._height]:[0,0]},Node.prototype.isOverComponent=function(t,e,i){var n,o=i||0;for(n=0;n<this._components.length;n+=1)if(this._components[n].isOver(t,e,o))return!0;return!1},Node.prototype.selectComponent=function(t,e){var i;for(i=0;i<this._components.length;i+=1)if(this._components[i].select(t,e))return void(this._activeComponent=this._components[i])},Node.prototype.addFigure=function(t){t instanceof NodeFigure&&(t instanceof FromImageFigure||this.setBackgroundColor(t._color),this.setLineWidth(t._lineWidth),this.setLineColor(t._lineColor),this._figures.push(t))},Node.prototype.delFigure=function(t){if(t instanceof NodeFigure)for(var e=1;e<this._figures.length;e++)if(this._figures[e]==t){this._selectedFigure==e&&this.setSelectedFigure(0),this._figures.splice(e,1);break}},Node.prototype.setBackgroundColor=function(t){this._Backgroundcolor=t;for(var e=0;e<this._figures.length;e++)this._figures[e].setColor(t)},Node.prototype.getBackgroundColor=function(){return this._Backgroundcolor},Node.prototype.setSelectedFigure=function(t){if(JSFun.isNumber(t)&&t>-1&&t<this._figures.length){if(this._selectedFigure==t)return!1;if(this._selectedFigure=t,this._figures[t]instanceof FromImageFigure){for(var e=0;e<this._components.length;e++)if("name"==this._components[e]._id){if(!this._beforeNameComponent){this._beforeNameComponent=this._components[e];var i=this._beforeNameComponent._text,n=this._beforeNameComponent._font_color,o=this._beforeNameComponent._font_family,s=this._beforeNameComponent._font_size,r=this._beforeNameComponent._font_weight,h=this._beforeNameComponent.selected;this._beforeNameComponent instanceof TextArea&&(this._components[e]=new TextArea({id:"name",text:i.join("\n"),text_color:n,text_family:o,font_size:s,font_weight:r,selected:h,position:Component.Bottom,margin:3})),this._beforeNameComponent instanceof TextBox&&(this._components[e]=new TextBox({id:"name",text:i,text_color:n,text_family:o,font_size:s,font_weight:r,selected:h,position:Component.Bottom,margin:3})),this._components[e].setParent(this)}}else this._components[e].setVisibility(!1);for(this._beforeHeight=this._height,this._beforeWidth=this._width,e=0;e<this._nodeChilds.length;e++)this._nodeChilds[e].setVisibility(!1)}else{for(e=0;e<this._components.length;e++)"name"==this._components[e]._id?this._beforeNameComponent&&(this._beforeNameComponent instanceof TextArea?this._beforeNameComponent.setText(this._components[e]._text.join("\n")):this._beforeNameComponent instanceof TextBox&&this._beforeNameComponent.setText(this._components[e]._text),this._components[e]=this._beforeNameComponent,this._beforeNameComponent=null):this._components[e]instanceof SpecificationItem&&!(this._components[e]instanceof SpecificationItem&&""!=this._components[e].getValue())||this._components[e].setVisibility(!0);for(e=0;e<this._nodeChilds.length;e++)this._nodeChilds[e].setVisibility(!0);this.setHeight(this._beforeHeight),this.setWidth(this._beforeWidth),this.notifyChange(!0),this._diagram._sortNodesByArea()}this.updateComponents()}return!0},Node.prototype.setVisibility=function(t){this._visible=t;var e=!0;this._selectedFigure&&t&&(e=!1);for(var i=0;i<this._components.length;i++)(e||!e&&"name"==this._components[i]._id)&&this._components[i].setVisibility(t);if(this._container&&e)for(i=0;i<this._nodeChilds.length;i++)this._nodeChilds[i].setVisibility(t)},Node.prototype.drawFigures=function(t){var e;for(e=0;e<this._figures.length;e+=1)e==this._selectedFigure&&this._figures[e].draw(t,this._x,this._y,this._width,this._height)},Node.prototype.addComponent=function(t){t instanceof Component&&(t.setParent(this),this._components.push(t),this.updateComponents())},Node.prototype.calculateSize=function(){if(this._components.length>0){var t,e,i,n=0,o=0,s=!1;for(i in this._components)!(t=this._components[i])._visible||t instanceof RegionLine||!(t.getPosition()==Component.Float||t.getPosition()==Component.BottomLeft&&t._visible||t.getPosition()==Component.BottomRight||t.getPosition()==Component.Xmovement)?t._visible||(s=!0):t._orientation?(n+=t.getWidth(),!(t instanceof RegionLine)&&t.getHeight()>o&&(o=t.getHeight())):(o+=t.getHeight(),e=t.getPosition()==Component.Xmovement?t.getWidth()+2*t._parent._Xmovement:t.getWidth(),!(t instanceof RegionLine)&&e>n&&(n=e));0==o&&1==s&&(o=20),0==n&&1==s&&(n=20),this._container&&!this._selectedFigure?(o>this._minHeight&&this.setMinHeight(o),n>this._minWidth&&this.setMinWidth(n)):(o>0&&this.setMinHeight(o),n>0&&this.setMinWidth(n))}},Node.prototype.insertComponents=function(t,e,i,n){var o,s,r=-1,h=-1,a=-1,l=-1,d=[];for(o=0;o<this._components.length;o++){if((s=this._components[o])instanceof Separator)if(s._orientation){var p=this.getParticularHeight(t);s.setCoordinates(t,p[0]),s.setHeight(p[1]-2*s._margin)}else{p=this.getParticularWidth(e);s.setCoordinates(p[0],e),s.setWidth(p[1])}else s.isCentered()?s._orientation?s.setCoordinates(t,e+n/2-s.getHeight()/2):s.setCoordinates(t+i/2-s.getWidth()/2,e):s.getPosition()==Component.TopRight?s.setCoordinates(t+i-s.getWidth(),this._y):s.getPosition()==Component.TopLeft?s.setCoordinates(t,this._y):s.getPosition()==Component.Top&&s._visible?d.push(s):s.getPosition()==Component.Bottom&&s._visible?(-1==h&&(h=this._y+this._height),s.setCoordinates(this._x+this._width/2-s.getWidth()/2,h),h+=s.getHeight()):s.getPosition()==Component.Left&&s._visible?(-1==a&&(a=this._y+this._height/2-s.getHeight()/2),s.setCoordinates(this._x-s.getWidth(),a),a+=s.getHeight()):s.getPosition()==Component.Right&&s._visible?(-1==l&&(l=this._y+this._height/2-s.getHeight()/2),s.setCoordinates(this._x+this._width,l),l+=s.getHeight()):s.getPosition()==Component.BottomLeft?s.setCoordinates(this._x,this._y+this._height-s.getHeight()):s.getPosition()==Component.BottomRight?s.setCoordinates(this._x+this._width-s.getWidth(),this._y+this._height-s.getHeight()):s.getPosition()==Component.Xmovement?s.setCoordinates(t+this._Xmovement,e):(s.setCoordinates(t,e),s.setSuperWidth(this._width));s.getPosition()!=Component.Float&&s.getPosition()!=Component.Xmovement||(s._orientation?t+=s.getWidth():e+=s.getHeight()),s instanceof SuperComponent&&s.updateComponents()}for(o=d.length-1;o>-1;o--)-1==r&&(r=this._y-d[o].getHeight()),d[o].setCoordinates(this._x+this._width/2-d[o].getWidth()/2,r),0!=o&&(r-=d[o-1].getHeight()),d[o]instanceof SuperComponent&&d[o].updateComponents()},Node.prototype.updateComponents=function(t){var e;if(t=void 0==t||t,this._components.length>0&&(this.calculateSize(),this.insertComponents(this._x,this._y,this._width,this._height)),t)for(e in this._relations)this._relations[e].notifyChange()},Node.prototype.drawComponents=function(t){var e;for(e=0;e<this._components.length;e+=1)this._components[e].draw(t)},Node.prototype.drawComponentsShape=function(t){var e;for(e=0;e<this._components.length;e+=1)this._components[e].drawShape(t)},Node.prototype.setMoveable=function(){this._moveable=!0},Node.prototype.setProportional=function(){this._proportional=!0},Node.prototype.setWidth=function(t){t<this._minWidth&&(t=this._minWidth),this._width=t},Node.prototype.setHeight=function(t){t<this._minHeight&&(t=this._minHeight),this._height=t},Node.prototype.setMinWidth=function(t){this._minWidth=t<0?0:t,this._width<this._minWidth&&(this._width=this._minWidth)},Node.prototype.setMinHeight=function(t){this._minHeight=t<0?0:t,this._height<this._minHeight&&(this._height=this._minHeight)},Node.prototype.getWidth=function(){return this._width},Node.prototype.getHeight=function(){return this._height},Node.prototype.draw=function(t){this._visible&&(t.save(),t.fillStyle=NodeStyle.shape_color,this._moveable&&this._selected&&t.fillRect(parseInt(this._x+this._width),parseInt(this._y+this._height),5,5),t.restore(),this.drawFigures(t),this.drawComponents(t),this._selected&&this.drawComponentsShape(t))},Node.prototype.isOver=function(t,e){return t instanceof Point&&(e=t.getY(),t=t.getX()),t>=this._x&&t<=this._x+this._width&&e>=this._y&&e<=this._y+this._height},Node.prototype.isOverBeforePosition=function(t,e){return t instanceof Point&&(e=t.getY(),t=t.getX()),t>=this._prex&&t<=this._prex+this._width&&e>=this._prey&&e<=this._prey+this._height&&t>=this._x&&t<=this._x+this._width},Node.prototype.getArea=function(){return this._width*this._height},Node.prototype.notifyDelete=function(t){if(this._parent instanceof SuperNode){var e;for(e in this._components)if(this._components[e]==t){this._components.splice(e,1);break}this.updateComponents()}},Node.prototype.drawShape=function(t){t.save(),t.lineWidth=2.5,t.strokeStyle=NodeStyle.shape_color,t.strokeRect(JSGraphic.toPixel(this._x),JSGraphic.toPixel(this._y),this._width,this._height),t.restore()},Node.prototype.getCentralPoint=function(){return new Point(this._x+this._width/2,this._y+this._height/2)},Node.prototype.getLinkCentered=function(t,e){t instanceof Point&&(e=t.getY(),t=t.getX());var i=0,n=0,o=this._width/2,s=this._height/2,r=this._x+o,h=this._y+s;if(t-r!=0){var a=(e-h)/(t-r);i=Math.abs(s/a),n=Math.abs(o*a)}else i=0,n=s;return i>o&&(i=o),n>s&&(n=s),t<r&&(i=-i),e<h&&(n=-n),new Point(r+i,h+n)},Node.prototype.getLink=function(t,e,i,n){if(!i||!n)return this.getLinkCentered(t,e);var o=0,s=0,r=i-this._x,h=n-this._y;if(t>i&&(r=this._width-r),e>n&&(h=this._height-h),t-i!=0){var a=(e-n)/(t-i);o=Math.abs(h/a),s=Math.abs(r*a)}else o=0,s=h;return o>r&&(o=r),s>h&&(s=h),t<i&&(o=-o),e<n&&(s=-s),new Point(i+o,n+s)},Node.prototype.notifyDeleted=function(t){var e;for(e in this._relations)this._relations[e]==t&&this._relations.splice(e,1)},Node.prototype.remove=function(){for(;this._relations[0];)this._relations.pop().remove();if(this._parent){var t=this._parent;this._parent.delChild(this),t.updateContainer()}if(this._container)for(;this._nodeChilds[0];)this._nodeChilds.pop().remove();this._diagram.notifyDeleted(this)},Node.prototype.toString=function(){return"Node"},Node.prototype.getLineWidth=function(){return this._lineWidth},Node.prototype.setLineWidth=function(t){this._lineWidth=t;for(var e=0;e<this._figures.length;e++)this._figures[e].setLineWidth(t)},Node.prototype.getLineColor=function(){return this._lineColor},Node.prototype.setLineColor=function(t){this._lineColor=t;for(var e=0;e<this._figures.length;e++)this._figures[e].setLineColor(t)},Node.prototype.getFontFamily=function(){return this._fontFamily},Node.prototype.setFontFamily=function(t){var e;this._fontFamily=t;for(e in this._components)this._components[e].setFontFamily(t)},Node.prototype.getFontColor=function(){return this._fontColor},Node.prototype.setFontColor=function(t){var e;this._fontColor=t;for(e in this._components)this._components[e].setFontColor(t)},Node.prototype.getFontSize=function(){return this._fontSize},Node.prototype.setFontSize=function(t){var e;this._fontSize=t;for(e in this._components)this._components[e].setFontSize(t);this.notifyChange(!0,!0)},Node.prototype.getFontStyle=function(){return this._fontStyle},Node.prototype.setFontStyle=function(t){var e;this._fontStyle=t;for(e in this._components)this._components[e].setFontStyle(t)},Node.prototype.getFontWeight=function(){return this._fontWeight},Node.prototype.setFontWeight=function(t){var e;this._fontWeight=t;for(e in this._components)this._components[e].setFontWeight(t)},Node.prototype.showColorDialog=function(t){var e=t.that||this,i=e._Backgroundcolor,n=e._Backgroundcolor.split("#")[1],o=new Array(parseInt(n.slice(0,2),16),parseInt(n.slice(2,4),16),parseInt(n.slice(4,6),16)),s=document.createElement("div");s.className="ud_popupColor";var r=document.createElement("div");r.setAttribute("id","divBlock1");var h=document.createElement("div");h.setAttribute("id","divBlock2");var a=document.createElement("div");a.setAttribute("id","colorHtml"),a.style.color="#ffffff";var l=document.createElement("div");l.setAttribute("id","red");var d=document.createElement("canvas");d.setAttribute("id","R"),d.width=150,d.height=20,l.appendChild(d);var p=d.getContext("2d"),c=document.createElement("div");c.setAttribute("id","green");var u=document.createElement("canvas");u.setAttribute("id","G"),u.width=150,u.height=20,c.appendChild(u);var _=u.getContext("2d"),g=document.createElement("div");g.setAttribute("id","blue");var m=document.createElement("canvas");m.setAttribute("id","B"),m.width=150,m.height=20,g.appendChild(m);var f=m.getContext("2d"),v=document.createElement("div");v.setAttribute("id","divSelectColor");var y=document.createElement("canvas");y.setAttribute("id","selectColor"),y.width=90,y.height=90,v.appendChild(y);var C=y.getContext("2d"),b=document.createElement("form"),x=document.createElement("input");x.setAttribute("type","submit"),x.setAttribute("value","OK");var S=document.createElement("input");S.setAttribute("type","submit"),S.setAttribute("value","Cancel");x.addEventListener("click",function(t){e.notifyDraw(),document.body.removeChild(s)},!1),S.addEventListener("click",function(t){e.setBackgroundColor(i),document.body.removeChild(s)},!1),b.onsubmit=function(){return!1},x.focus(),b.appendChild(x),b.appendChild(S),r.appendChild(a),r.appendChild(l),r.appendChild(c),r.appendChild(g),r.appendChild(b),s.appendChild(r),h.appendChild(v),h.appendChild(document.createElement("div")),s.appendChild(h);var w=function(t,e,i,n){0==i?i=.1:120==i&&(i=119.9),e.save(),e.font="12px monospace",e.textBaseline="middle",e.fillStyle="#ffffff",e.fillText(t.getAttribute("id"),0,t.height/2),e.restore(),e.save(),e.beginPath(),e.fillStyle=n,e.fillRect(20,0,parseInt(t.width)-50,d.height),e.closePath(),e.restore(),e.fillStyle="#000000",e.beginPath(),e.arc(20+100*i/255,parseInt(t.height)/2,4,0,2*Math.PI,!0),e.closePath(),e.fill(),e.save(),e.font="12px monospace",e.textBaseline="middle",e.fillStyle="#ffffff",e.fillText(parseInt(i),125,t.height/2),e.restore()},T=function(t){C.save(),C.beginPath(),C.fillStyle=t,C.fillRect(20,20,80,80),C.closePath(),C.restore()},F=function(t){for(var e=function(t){var e="0123456789ABCDEF",i=parseInt(t)%16,n=(parseInt(t)-i)/16;return hex=""+e.charAt(n)+e.charAt(i),hex},i=e(t[0])+e(t[1])+e(t[2]);a.hasChildNodes();)a.removeChild(a.lastChild);var n=document.createElement("font");n.style.color="#"+i;var o=document.createTextNode("#"),s=document.createTextNode(i);n.appendChild(o),n.appendChild(s),a.appendChild(n),setCheckedColor("#"+i)},A=function(t){var i=t.pageX-s.offsetLeft-this.offsetLeft;t.pageY,this.offsetTop;"red"==this.getAttribute("id")&&(o[0]=255*(i-20)/100,o[0]>255&&(o[0]=255),o[0]<0&&(o[0]=0),p.clearRect(0,0,parseInt(d.width),d.height),w(d,p,o[0],"#ff0000")),"green"==this.getAttribute("id")&&(o[1]=255*(i-20)/100,o[1]>255&&(o[1]=255),o[1]<0&&(o[1]=0),_.clearRect(0,0,parseInt(u.width),u.height),w(u,_,o[1],"#00ff00")),"blue"==this.getAttribute("id")&&(o[2]=255*(i-20)/100,o[2]>255&&(o[2]=255),o[2]<0&&(o[2]=0),f.clearRect(0,0,parseInt(m.width),m.height),w(m,f,o[2],"#0000ff")),F(o),T(e._Backgroundcolor)};w(d,p,o[0],"#ff0000"),w(u,_,o[1],"#00ff00"),w(m,f,o[2],"#0000ff"),T(e._Backgroundcolor),F(o),l.addEventListener("mousedown",A,!1),c.addEventListener("mousedown",A,!1),g.addEventListener("mousedown",A,!1),document.body.appendChild(s),s.style.top=(window.innerHeight-parseInt(s.offsetHeight))/2+"px",s.style.left=(window.innerWidth-parseInt(s.offsetWidth))/2+"px"},Node.prototype.getNodeChilds=function(){return this._nodeChilds},Node.prototype.getComponents=function(){return this._components},Node.prototype.isVisible=function(){return this._visible},Node.prototype.getRelations=function(){return this._relations};var Cube=function(t){t=t||{},Cube.baseConstructor.call(this,t)};JSFun.extend(Cube,Node),Cube.prototype.setElementXML=function(t){Cube.base.setElementXML.call(this,t)},Cube.prototype.getLinkCentered=function(t,e){t instanceof Point&&(e=t.getY(),t=t.getX());var i=0,n=0,o=(this._width+10)/2,s=(this._height+10)/2,r=this._x+o,h=this._y-10+s;if(t-r!=0){var a=(e-h)/(t-r);i=Math.abs(s/a),n=Math.abs(o*a)}else i=0,n=s;return i>o&&(i=o),n>s&&(n=s),t<r&&(i=-i),e<h&&(n=-n),new Point(r+i,h+n)},Cube.prototype.getLink=function(t,e,i,n){if(!i||!n)return this.getLinkCentered(t,e);var o=0,s=0,r=i-this._x,h=n-this._y-10;if(t>i&&(r=this._width+10-r),e>n&&(h=this._height+10-h),t-i!=0){var a=(e-n)/(t-i);o=Math.abs(h/a),s=Math.abs(r*a)}else o=0,s=h;return o>r&&(o=r),s>h&&(s=h),t<i&&(o=-o),e<n&&(s=-s),new Point(i+o,n+s)};var DataStoreItem=function(t){t=t||{},DataStoreItem.baseConstructor.call(this,t),this._parse=/^([a-zA-Z]*)(?:\[([^\[\]]*)\])?$/};JSFun.extend(DataStoreItem,TextBox),DataStoreItem.prototype.encode=function(t){var e="";return t[0]&&(e+=t[0]),t[1]&&(e+="["+t[1]+"]"),this._parse.exec(e)?e:"wrong_operation"},DataStoreItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},DataStoreItem.prototype.showDialog=function(){if(!this.active){var t=this;this.active=!0;var e=document.createElement("div");e.className="ud_popup";var i,n=document.createElement("form"),o=[];for(i=0;i<2;i++)o.push(document.createElement("input"));var s=document.createElement("input");s.setAttribute("type","submit"),s.setAttribute("value","OK");var r=this.decode(this.getValue());for(i=0;i<o.length;i++)o[i].setAttribute("type","text"),o[i].setAttribute("value",r[i]||"");this.changeText=function(i){if(t.active){var n,s=[];for(n=0;n<o.length;n++)s.push(o[n].value);t.setText(t.encode(s)),document.body.removeChild(e),t.active=!1,t.notifyChange()}},n.onsubmit=function(){return!1},s.addEventListener("click",this.changeText,!1);var h,a,l=["name","state"];for(i=0;i<o.length;i++)a=document.createElement("div"),(h=document.createElement("label")).appendChild(document.createTextNode(l[i])),a.appendChild(h),a.appendChild(o[i]),n.appendChild(a);if(n.appendChild(s),this.deletable){var d=document.createElement("input");d.setAttribute("type","submit"),d.setAttribute("value","delete"),this.deleteDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyDelete(),t.notifyChange())},d.addEventListener("click",this.deleteDialog,!1),n.appendChild(d)}e.appendChild(n),document.body.appendChild(e),s.focus(),e.style.top=(window.innerHeight-n.offsetHeight)/2+"px",e.style.left=(window.innerWidth-n.offsetWidth)/2+"px"}};var DeploymentItem=function(t){t=t||{},this._pos=" ",DeploymentItem.baseConstructor.call(this,t),this.setMinWidth(40)};JSFun.extend(DeploymentItem,TextBox),DeploymentItem.prototype.select=function(t,e){return Math.abs(t-(this.getPixelX()+this.getSuperWidth()-20))<=5&&Math.abs(e-(this.getPixelY()+8.66))<=5?(this.notifyToUp(),this.notifyChange(),!0):Math.abs(t-(this.getPixelX()+this.getSuperWidth()-30))<=5&&Math.abs(e-(this.getPixelY()+7.33))<=5?(this.notifyToDown(),this.notifyChange(),!0):DeploymentItem.base.select.call(this,t,e)},DeploymentItem.prototype.drawShape=function(t){if(this._visible){var e=this.getPixelX()+this.getSuperWidth()-35,i=this.getPixelY()+3;t.save(),t.fillStyle="#0000aa",t.beginPath(),t.moveTo(e,i),t.lineTo(e+10,i),t.lineTo(e+5,i+7),t.closePath(),t.fill(),e+=10,t.beginPath(),t.moveTo(e+5,i),t.lineTo(e,i+7),t.lineTo(e+10,i+7),t.closePath(),t.fill(),t.restore()}},DeploymentItem.prototype.draw=function(t){if(this._visible){if(t.save(),t.font=this.getFontStyle()+" "+this.getFontWeight()+" "+this.getFontSize()+"px "+this.getFontFamily(),t.textBaseline="middle",t.fillStyle=this.getFontColor(),this._text)switch(this._pos){case"alone":var e="{"+this._text+"}";break;case"first":e="{"+this._text+",";break;case"last":e=this._text+"}";break;default:e=this._text+","}this._orientation?(t.translate(this._getMX()+this._line_height/2,this._getMY()+4),t.rotate(-90*Math.PI/180),e&&t.fillText(e,2*this._margin-this.getHeight(),0)):e&&t.fillText(e,this._getMX()+4,this._getMY()+this._line_height/2),t.restore()}};var DeploymentFields=function(t){t=t||{},DeploymentFields.baseConstructor.call(this,t),this._default=t.text||"new_deploymentproperty"};JSFun.extend(DeploymentFields,CollapsibleFields),DeploymentFields.prototype.newItem=function(){return new DeploymentItem({text:this._default})},DeploymentFields.prototype._updatePos=function(){if(1!=this._childs.length)for(i=0;i<this._childs.length;i++)0==i?this._childs[i]._pos="first":i==this._childs.length-1?this._childs[i]._pos="last":this._childs[i]._pos=" ";else this._childs[0]._pos="alone"},DeploymentFields.prototype.addSubComponent=function(t){DeploymentFields.base.addSubComponent.call(this,t),t instanceof Component&&this._updatePos()},DeploymentFields.prototype.delSubComponent=function(t){DeploymentFields.base.delSubComponent.call(this,t),this._updatePos()},DeploymentFields.prototype.notifyToUp=function(t){DeploymentFields.base.notifyToUp.call(this,t),this._updatePos()},DeploymentFields.prototype.notifyToDown=function(t){DeploymentFields.base.notifyToDown.call(this,t),this._updatePos()},DeploymentFields.prototype.draw=function(t){this._visible&&CollapsibleFields.base.draw.call(this,t)};var RelationLine=function(){};RelationLine.prototype.draw=function(t,e,i){};var SolidLine=function(){};JSFun.extend(SolidLine,RelationLine),SolidLine.prototype.draw=function(t,e,i,n){var o;for(t.save(),t.strokeStyle=i,t.lineWidth=n,t.beginPath(),e[0]&&t.moveTo(e[0].pixelX(),e[0].pixelY()),o=1;o<e.length;o++)t.lineTo(e[o].pixelX(),e[o].pixelY());t.stroke(),t.restore()};var DashedLine=function(){};JSFun.extend(DashedLine,RelationLine),DashedLine.prototype.draw=function(t,e,i,n){var o;for(t.save(),t.strokeStyle=i,t.lineWidth=n,o=0;o<e.length-1;o++)JSGraphic.dashedLine(t,e[o].pixelX(),e[o].pixelY(),e[o+1].pixelX(),e[o+1].pixelY(),10);t.restore()};var RelationEnd=function(){};RelationEnd.prototype.draw=function(t,e,i,n,o){};var CloseTip=function(t){t=t||{},this._color=t.color||"#ffffff"};JSFun.extend(CloseTip,RelationEnd),CloseTip.prototype.draw=function(t,e,i,n,o){t.save(),t.strokeStyle=o,t.fillStyle=this._color,t.translate(e,i),t.rotate(n),t.beginPath(),t.moveTo(0,0),t.lineTo(-8.5,5.5),t.lineTo(-8.5,-5.5),t.closePath(),t.fill(),t.stroke(),t.restore()};var OpenTip=function(){};JSFun.extend(OpenTip,RelationEnd),OpenTip.prototype.draw=function(t,e,i,n,o){t.save(),t.strokeStyle=o,t.fillStyle="#ffffff",t.translate(e,i),t.rotate(n),t.beginPath(),t.moveTo(-8.5,5.5),t.lineTo(0,0),t.lineTo(-8.5,-5.5),t.stroke(),t.restore()};var AggregationEnd=function(){};JSFun.extend(AggregationEnd,RelationEnd),AggregationEnd.prototype.draw=function(t,e,i,n,o){t.save(),t.strokeStyle=o,t.fillStyle="#ffffff",t.translate(e,i),t.rotate(n),t.beginPath(),t.moveTo(0,0),t.lineTo(-7,-5),t.lineTo(-14,0),t.lineTo(-7,5),t.closePath(),t.fill(),t.stroke(),t.restore()};var CompositionEnd=function(){};JSFun.extend(CompositionEnd,RelationEnd),CompositionEnd.prototype.draw=function(t,e,i,n,o){t.save(),t.fillStyle="#000000",t.translate(e,i),t.rotate(n),t.beginPath(),t.moveTo(0,0),t.lineTo(-7,-5),t.lineTo(-14,0),t.lineTo(-7,5),t.closePath(),t.fill(),t.restore()};var InterfaceUsageEnd=function(){};JSFun.extend(InterfaceUsageEnd,RelationEnd),InterfaceUsageEnd.prototype.draw=function(t,e,i,n,o){t.save(),t.strokeStyle=o,t.translate(e+1*Math.cos(n),i+1*Math.sin(n)),t.rotate(n),t.beginPath(),t.arc(8,0,12,Math.PI/2,1.5*Math.PI,!1),t.stroke(),t.restore()};var OpenTipAggregationEnd=function(){};JSFun.extend(OpenTipAggregationEnd,RelationEnd),OpenTipAggregationEnd.prototype.draw=function(t,e,i,n,o){t.save(),t.strokeStyle=o,t.fillStyle="#ffffff",t.translate(e,i),t.rotate(n),t.beginPath(),t.moveTo(0,0),t.lineTo(-7,-5),t.lineTo(-14,0),t.lineTo(-7,5),t.lineTo(0,0),t.fill(),t.moveTo(-22.5,5.5),t.lineTo(-14,0),t.lineTo(-22.5,-5.5),t.stroke(),t.restore()};var OpenTipCompositionEnd=function(){};JSFun.extend(OpenTipCompositionEnd,RelationEnd),OpenTipCompositionEnd.prototype.draw=function(t,e,i,n,o){t.save(),t.strokeStyle=o,t.fillStyle="#000000",t.translate(e,i),t.rotate(n),t.beginPath(),t.moveTo(0,0),t.lineTo(-7,-5),t.lineTo(-14,0),t.lineTo(-7,5),t.lineTo(0,0),t.fill(),t.moveTo(-22.5,5.5),t.lineTo(-14,0),t.lineTo(-22.5,-5.5),t.stroke(),t.restore()};var RelationStyle={shape_color:"#000000"},Relation=function(t){t=t||{},this._id=0,this._type="untyped",this._line_color="#000000",this._line_width=1.25,this._points=[new Point,new Point],this._selected=-1,this._selectedBefore=!1,this._moved=!1,this._activeComponent=null,this._selectedLine=!1,this._selectedPoint=!1,this._components=[],this._relations=[],this._diagram=null,this.setElements(t.a,t.b)};JSFun.extend(Relation,Element),Relation.prototype.setElements=function(t,e){return t instanceof Element&&e instanceof Element&&(!(t instanceof Relation&&e instanceof Relation)&&(this._elemA&&this._elemA.delRelation(this),this._elemB&&this._elemB.delRelation(this),this._elemA=t,this._elemB=e,this._elemA.addRelation(this),this._elemB.addRelation(this),this.updateParent(),this._calculateLineEnds(),!0))},Relation.prototype.setElementA=function(t){return t instanceof Element&&(!(t instanceof Relation&&this._elemB instanceof Relation)&&(this._elemA&&this._elemA.delRelation(this),this._elemA=t,this._elemA.addRelation(this),this.updateParent(),!0))},Relation.prototype.setElementB=function(t){return t instanceof Element&&(!(t instanceof Relation&&this._elemA instanceof Relation)&&(this._elemB&&this._elemB.delRelation(this),this._elemB=t,this._elemB.addRelation(this),this.updateParent(),!0))},Relation.prototype.setValue=function(t,e){var i;for(i in this._components)if(this._components[i].getId()==t)return this._components[i].setValue(e),void this._updateComponents()},Relation.prototype.addValue=function(t,e){var i;for(i in this._components)if(this._components[i]instanceof SuperComponent&&this._components[i].getId()==t)return this._components[i].addField(e),void this._updateComponents()},Relation.prototype.getElementXML=function(t){var e,i=t.createElement(this.getType());for(i.setAttribute("id",this.getId()),i.setAttribute("side_A",this._elemA.getId()),i.setAttribute("side_B",this._elemB.getId()),e=0;e<this._points.length;e++){var n=t.createElement("point");n.setAttribute("x",this._points[e].getX()),n.setAttribute("y",this._points[e].getY()),i.appendChild(n)}for(e in this._components)this._components[e].getId()&&i.appendChild(this._components[e].getComponentXML(t));return"#000000"!=this.getLineColor()&&i.setAttribute("color",this.getLineColor()),1.25!=this.getLineWidth()&&i.setAttribute("width",this.getLineWidth()),this._lineStyleChanged&&i.setAttribute("style",this.getLineStyle()),"none"!=this.getDirection()&&i.setAttribute("direction",this.getDirection()),i},Relation.prototype.setElementXML=function(t,e){var i,n=t.getAttribute("side_A"),o=t.getAttribute("side_B");this.setElements(e[n],e[o]);var s=t.childNodes,r=0;for(i=0;i<s.length;i++)"point"==s[i].nodeName&&(this._points[r]=new Point(parseInt(s[i].getAttribute("x")),parseInt(s[i].getAttribute("y"))),r++);for(i=0;i<s.length;i++){var h;if("item"==s[i].nodeName)this.setValue(s[i].getAttribute("id"),s[i].getAttribute("value"));else if("superitem"==s[i].nodeName)for(h in this._components)this._components[h].getId()==s[i].getAttribute("id")&&this._components[h].setComponentXML(s[i])}var a=t.getAttribute("color");a&&this.setLineColor(a);var l=t.getAttribute("width");l&&this.setLineWidth(l);var d=t.getAttribute("style");d&&this.setLineStyle(d);var p=t.getAttribute("direction");p&&this.setDirection(p),this._updateComponents()},Relation.prototype.setId=function(t){this._id=this.getType()+"_"+t},Relation.prototype.getId=function(){return this._diagram.getId()+":"+this._id},Relation.prototype.setType=function(t){"untyped"==this._type&&JSFun.isString(t)&&(this._type=t)},Relation.prototype.getType=function(){return this._type},Relation.prototype.addRelation=function(t){t instanceof Relation&&this._relations.push(t)},Relation.prototype.delRelation=function(t){var e;for(e in this._relations)if(this._relations[e]==t){this._relations.splice(e,1);break}},Relation.prototype.setDiagram=function(t){t instanceof Diagram&&(this._diagram=t)},Relation.prototype._addComponent=function(t){t.setParent(this),this._components.push(t),this._updateComponents()},Relation.prototype._delComponent=function(t){var e;for(e in this._components)if(this._components[e]==t){this._components.splice(e,1);break}},Relation.prototype.setComponentName=function(t){this._name?this._name.setText(t):(this._name=new TextBox({id:"name",text:t}),this._addComponent(this._name))},Relation.prototype.setStereotype=function(t){this._stereotype=new Text({id:"stereotype",text:t}),this._addComponent(this._stereotype)},Relation.prototype.addComponentStereotype=function(t){this._stereotype||(this._stereotype=new StereotypeFields({id:"stereotype",width:100,text:t}),this._addComponent(this._stereotype))},Relation.prototype.setComponentRoleA=function(t){this._roleA?this._roleA.setText(t):(this._roleA=new RoleItem({id:"roleA",text:t,margin:4}),this._addComponent(this._roleA))},Relation.prototype.setComponentRoleB=function(t){this._roleB?this._roleB.setText(t):(this._roleB=new RoleItem({id:"roleB",text:t,margin:4}),this._addComponent(this._roleB))},Relation.prototype.setComponentMultiplicityA=function(t){this._multiA?this._multiA.setText(t):(this._multiA=new TextBox({id:"multiplicityA",text:t,margin:4}),this._addComponent(this._multiA))},Relation.prototype.setComponentMultiplicityB=function(t){this._multiB?this._multiB.setText(t):(this._multiB=new TextBox({id:"multiplicityB",text:t,margin:4}),this._addComponent(this._multiB))},Relation.prototype._updateComponents=function(){if(this._elemA&&this._elemB){var t=this._points.length,e=parseInt(t/2)-1;if(this._roleA){var i=this._points[0].getX(),n=this._points[0].getY(),o=this._points[1].getX(),s=this._points[1].getY();if(this._elemA instanceof Relation)this._roleA.setCoordinates(i,n-this._roleA.getHeight());else{var r=Math.atan2(s-n,o-i),h=Math.tan(r),a=this._roleA.getWidth(),l=this._roleA.getHeight();i==this._elemA.getX()?(d=-a,p=s<n?-l-h*a:-l):i==this._elemA.getX()+this._elemA.getWidth()?(d=0,p=s<n?h*a-l:-l):n==this._elemA.getY()?(p=-l,d=o<i?-a-l/h:-a):n==this._elemA.getY()+this._elemA.getHeight()&&(p=0,d=o<i?l/h-a:-a),this._roleA.setCoordinates(i+d,n+p)}}if(this._roleB){i=this._points[t-1].getX(),n=this._points[t-1].getY(),o=this._points[t-2].getX(),s=this._points[t-2].getY();if(this._elemB instanceof Relation)this._roleB.setCoordinates(i,n-this._roleB.getHeight());else{r=Math.atan2(s-n,o-i),h=Math.tan(r),a=this._roleB.getWidth(),l=this._roleB.getHeight();i==this._elemB.getX()?(d=-a,p=s<n?-l-h*this._roleB.getWidth():-l):i==this._elemB.getX()+this._elemB.getWidth()?(d=0,p=s<n?-l+h*this._roleB.getWidth():-l):n==this._elemB.getY()?(p=-l,d=o<i?-a-this._roleB.getHeight()/h:-a):n==this._elemB.getY()+this._elemB.getHeight()&&(p=0,d=o<i?-a+this._roleB.getHeight()/h:-a),this._roleB.setCoordinates(i+d,n+p)}}if(this._multiA){i=this._points[0].getX(),n=this._points[0].getY(),o=this._points[1].getX(),s=this._points[1].getY();if(this._elemA instanceof Relation)this._multiA.setCoordinates(i,n);else{r=Math.atan2(s-n,o-i),h=Math.tan(r),a=this._multiA.getWidth(),l=this._multiA.getHeight();var d=0,p=0,c=i-(g=this._elemA.getX()+this._elemA.getWidth()/2),u=n-(m=this._elemA.getY()+this._elemA.getHeight()/2),_=this._elemA.getHeight()/this._elemA.getWidth();c<0?u<0?u>_*c?(d=-a,p=0):(d=0,p=-l):u>-_*c?(d=0,p=0):(d=-a,p=-h*a):u<0?u<-_*c?(d=-l/h,p=-l):(d=0,p=0):u<_*c?(d=0,p=h*a):(d=l/h,p=0),this._multiA.setCoordinates(i+d,n+p)}}if(this._multiB){i=this._points[t-1].getX(),n=this._points[t-1].getY(),o=this._points[t-2].getX(),s=this._points[t-2].getY();if(this._elemB instanceof Relation)this._multiB.setCoordinates(i,n);else{r=Math.atan2(s-n,o-i),h=Math.tan(r),a=this._multiB.getWidth(),l=this._multiB.getHeight(),d=0,p=0,c=i-(g=this._elemB.getX()+this._elemB.getWidth()/2),u=n-(m=this._elemB.getY()+this._elemB.getHeight()/2),_=this._elemB.getHeight()/this._elemB.getWidth();c<0?u<0?u>_*c?(d=-a,p=0):(d=0,p=-l):u>-_*c?(d=0,p=0):(d=-a,p=-h*a):u<0?u<-_*c?(d=-l/h,p=-l):(d=0,p=0):u<_*c?(d=0,p=h*a):(d=l/h,p=0),this._multiB.setCoordinates(i+d,n+p)}}i=this._points[e].getX(),n=this._points[e].getY(),o=this._points[e+1].getX(),s=this._points[e+1].getY();if(t%2!=0)var g=o,m=s;else g=(i+o)/2,m=(n+s)/2;this._stereotype&&(i>o&&n<s||o>i&&s<n?this._name?this._stereotype.setCoordinates(g-this._stereotype.getWidth(),m-this._stereotype.getHeight()-this._name.getHeight()):this._stereotype.setCoordinates(g-this._stereotype.getWidth(),m-this._stereotype.getHeight()):this._name?this._stereotype.setCoordinates(g,m-this._stereotype.getHeight()-this._name.getHeight()):this._stereotype.setCoordinates(g,m-this._stereotype.getHeight()),this._stereotype instanceof SuperComponent&&this._stereotype.updateComponents()),this._name&&(i>o&&n<s||o>i&&s<n?this._name.setCoordinates(g-this._name.getWidth(),m-this._name.getHeight()):this._name.setCoordinates(g,m-this._name.getHeight()))}},Relation.prototype._drawComponents=function(t){var e;for(e=0;e<this._components.length;e++)this._components[e].draw(t)},Relation.prototype._drawComponentsShape=function(t){var e;for(e=0;e<this._components.length;e++)this._components[e].drawShape(t)},Relation.prototype.isLinked=function(t){return t instanceof Element&&(this._elemA==t||this._elemB==t)},Relation.prototype._selectLine=function(t,e,i,n,o){if(!(t instanceof Point&&e instanceof Point))return!1;o=o||5;var s,r,h,a,l,d,p,c,u,_,g=t.getX(),m=t.getY(),f=e.getX(),v=e.getY();if(g>f?(s=g,h=f):(s=f,h=g),m>v?(r=m,a=v):(r=v,a=m),g==f){if(n<=r&&n>=a&&i>=h-o&&i<=h+o)return!0}else if(l=(v-m)/(f-g),d=Math.atan((v-m)/(f-g)),p=Math.abs(Math.sin(d)*o),c=Math.abs(Math.cos(d)*o),i>=h-p&&i<=s+p&&n>=a-c&&n<=r+c&&(u=(i-g)*l+m,_=Math.abs(n-u),(_=Math.cos(d)*_)<=o))return!0;return!1},Relation.prototype._isOverComponent=function(t,e,i){var n,o=i||0;for(n=0;n<this._components.length;n++)if(this._components[n].isOver(t,e,o))return!0;return!1},Relation.prototype._deselectComponent=function(){this._activeComponent&&(this._activeComponent.deselect(),this._activeComponent=null)},Relation.prototype._selectComponent=function(t,e){var i;for(i=0;i<this._components.length;i++)if(this._components[i].select(t,e))return void(this._activeComponent=this._components[i])},Relation.prototype.isOver=function(t,e,i){for(var n=i||0,o=0;o<this._points.length-1;o++)if(this._selectLine(this._points[o],this._points[o+1],t,e,n))return!0;return!1},Relation.prototype.select=function(t,e){this._deselectComponent();var i=this._diagram._touch?6:0;if(this._diagram._activeMenu&&this.removeContextualMenu(),1==this._diagram._pressMouseRight||1==this._diagram._hold){i=this._diagram._touch?10:0;if(this.isOver(t,e,i)){this._diagram._pressMouseRight=!1,document.oncontextmenu=function(){return!1};var n=document.documentElement.scrollTop||document.body.scrollTop;return t+=this._diagram._div.offsetLeft,e=n?e-n+this._diagram._div.offsetTop:e+this._diagram._div.offsetTop,this.showContextualMenu(t,e),!0}return!1}for(o=0;o<this._points.length;o++)if(Math.abs(t-this._points[o].getX())<=4&&Math.abs(e-this._points[o].getY())<=4)return this._selected>-1&&(this._selectedBefore=!0),this._selected=o,this._selectedPoint=!0,this._component=!1,!0;if(this._selected>-1&&this._isOverComponent(t,e,i))return this._selectedBefore=!0,this._component=!0,!0;for(var o=0;o<this._points.length-1;o++)if(this._selectLine(this._points[o],this._points[o+1],t,e,20))return this._selected>-1&&(this._selectedBefore=!0),this._selected=o,this._selectedLine=!0,this._component=!1,this._points.splice(this._selected+1,0,new Point(t,e)),!0;return!1},Relation.prototype.drag=function(t,e){this._selectedLine?(this._elemA==this._elemB?(this._selected=2,this._points[this._selected].setPoint(t,e)):this._points[this._selected+1].setPoint(t,e),this._moved=!0):this._selectedPoint&&(this._elemA==this._elemB?1==this._selected?this._points[this._selected].setY(e):3==this._selected?this._points[this._selected].setX(t):this._points[this._selected].setPoint(t,e):this._points[this._selected].setPoint(t,e),this._moved=!0)},Relation.prototype._checkForNewNodes=function(t,e){if(this._selectedPoint&&(0==this._selected||this._selected==this._points.length-1)){var i=this._diagram.reassignRelationTo(this,t,e);i!=this&&(0==this._selected?this.setElementA(i):this.setElementB(i))}},Relation.prototype.drop=function(t,e){this._moved?this._checkForNewNodes(t,e):this._selectedBefore&&this._selectComponent(t,e),this._selectedLine=!1,this._selectedPoint=!1,this._moved=!1,this._delUselessPoints(),this.notifyChange()},Relation.prototype.notifyChange=function(){this._delUselessPoints(),this.updateParent(),this._calculateLineEnds(),this._updateComponents();for(var t in this._relations)this._relations[t].notifyChange()},Relation.prototype.notifyDraw=function(){this._diagram&&this._diagram.draw()},Relation.prototype.deselect=function(){this._deselectComponent(),this._selectedBefore=!1,this._selected=-1},Relation.prototype._calculateLineEnds=function(){var t,e,i=this._points.length;if(this._elemA==this._elemB){var n,o,s=this._elemA.getCentralPoint(),r=s.getX(),h=s.getY(),a=this._points[2]?this._points[2]._x:this._elemA._x+this._elemA._width,l=this._points[2]?this._points[2]._y:this._elemA._y+this._elemA._height;if(2==this._selected||0==this._selected||this._selected==i-1||-1==this._selected&&!this._elemA._moved||this._elemA._resizing)a-r>0?l-h>0?(t=this._elemA.getLinkCentered(r,h+this._elemA.getHeight()/2),e=this._elemA.getLinkCentered(r+this._elemA.getWidth()/2,h),n=(n=l-t.getY())<20?20:n,o=(o=a-e.getX())<20?20:o,this._points[1]=new Point(r,t.getY()+n),this._points[2]=new Point(e.getX()+o,t.getY()+n),this._points[3]=new Point(e.getX()+o,h)):(t=this._elemA.getLinkCentered(r,h-this._elemA.getHeight()/2),e=this._elemA.getLinkCentered(r+this._elemA.getWidth()/2,h),n=(n=t.getY()-l)<20?20:n,o=(o=a-e.getX())<20?20:o,this._points[1]=new Point(r,t.getY()-n),this._points[2]=new Point(e.getX()+o,t.getY()-n),this._points[3]=new Point(e.getX()+o,h)):l-h>0?(t=this._elemA.getLinkCentered(r,h+this._elemA.getHeight()/2),e=this._elemA.getLinkCentered(r-this._elemA.getWidth()/2,h),n=(n=l-t.getY())<20?20:n,o=(o=e.getX()-a)<20?20:o,this._points[1]=new Point(r,t.getY()+n),this._points[2]=new Point(e.getX()-o,t.getY()+n),this._points[3]=new Point(e.getX()-o,h)):(t=this._elemA.getLinkCentered(r,h-this._elemA.getHeight()/2),e=this._elemA.getLinkCentered(r-this._elemA.getWidth()/2,h),n=(n=t.getY()-l)<20?20:n,o=(o=e.getX()-a)<20?20:o,this._points[1]=new Point(r,t.getY()-n),this._points[2]=new Point(e.getX()-o,t.getY()-n),this._points[3]=new Point(e.getX()-o,h));else if(3==this._selected)a=this._points[3]._x,l=this._points[3]._y,t=this._elemA.getLinkCentered(r,this._points[0]._y),a-r>0?(o=(o=a-(e=this._elemA.getLinkCentered(r+this._elemA.getWidth()/2,h)).getX())<20?20:o,this._points[2].setX(e.getX()+o),this._points[3]=new Point(e.getX()+o,h)):(o=(o=(e=this._elemA.getLinkCentered(r-this._elemA.getWidth()/2,h)).getX()-a)<20?20:o,this._points[2].setX(e.getX()-o),this._points[3]=new Point(e.getX()-o,h));else if(1==this._selected)a=this._points[1]._x,l=this._points[1]._y,e=this._elemA.getLinkCentered(this._points[4]._x,h),l-h>0?(n=(n=l-(t=this._elemA.getLinkCentered(r,h+this._elemA.getHeight()/2)).getY())<20?20:n,this._points[1]=new Point(r,t.getY()+n),this._points[2].setY(t.getY()+n)):(n=(n=(t=this._elemA.getLinkCentered(r,h-this._elemA.getHeight()/2)).getY()-l)<20?20:n,this._points[1]=new Point(r,t.getY()-n),this._points[2].setY(t.getY()-n));else if(-1==this._selected){var d=0,p=0;if(this._elemA._moved){d=(this._elemA._x-this._elemA._prex)/2,p=(this._elemA._y-this._elemA._prey)/2;this._points[0].setPoint(this._points[0]._x+d,this._points[0]._y+p),this._points[4].setPoint(this._points[4]._x+d,this._points[4]._y+p),t=this._points[0],e=this._points[4],this._points[1].setPoint(this._points[1]._x+d,this._points[1]._y+p),this._points[2].setPoint(this._points[2]._x+d,this._points[2]._y+p),this._points[3].setPoint(this._points[3]._x+d,this._points[3]._y+p)}}for(this._points[0]=t,this._points[4]=e;this._points[5];)this._points.pop()}else i>2?(t=this._elemA.getLinkCentered(this._points[1]),e=this._elemB.getLinkCentered(this._points[i-2]),this._points[0]=t,this._points[i-1]=e):(t=this._elemA.getLinkCentered(this._elemB.getCentralPoint()),e=this._elemB.getLinkCentered(this._elemA.getCentralPoint()),this._points[0]=t,this._points[1]=e)},Relation.prototype.draw=function(t){var e,i=this._points.length;if(this._line&&this._line.draw(t,this._points,this.getLineColor(),this.getLineWidth()),this._end){var n=this._points[i-2].getX(),o=this._points[i-2].getY(),s=this._points[i-1].getX(),r=this._points[i-1].getY(),h=Math.atan2(r-o,s-n);this._end.draw(t,s,r,h,this.getLineColor())}if(this._start){s=this._points[0].getX(),r=this._points[0].getY(),n=this._points[1].getX(),o=this._points[1].getY(),h=Math.atan2(r-o,s-n);this._start.draw(t,s,r,h,this.getLineColor())}if(this._selected>=0)for(e=0;e<this._points.length;e++)t.fillRect(parseInt(this._points[e].getX())-3,parseInt(this._points[e].pixelY())-3,6,6);this._selected>-1&&this._drawComponentsShape(t),this._drawComponents(t)},Relation.prototype.drawShape=function(t){this._selectedPoint&&0==this._selected||this._selected==this._points.length-1||this._calculateLineEnds(),t.save(),t.lineWidth=2,t.strokeStyle=RelationStyle.shape_color,t.beginPath(),t.moveTo(this._points[0].pixelX(),this._points[0].pixelY());for(var e=1;e<this._points.length;e++)t.lineTo(this._points[e].pixelX(),this._points[e].pixelY());t.stroke(),t.restore()},Relation.prototype.setParent=function(t){this._parent=t instanceof Node?t:null},Relation.prototype.updateParent=function(){this._parent&&(this._parent.delChild(this),this._parent=null),this._elemA&&this._elemB&&(null!=this._elemA.getParent()&&this._elemA.getParent()==this._elemB.getParent()?this._elemA.getParent().addChild(this):this._elemA._parent&&this._elemB._parent&&this._elemA._parent._parent instanceof SuperNode&&this._elemB._parent._parent instanceof SuperNode&&this._elemA._parent._parent==this._elemB._parent._parent&&this._elemA.getParent().getParent().addChild(this))},Relation.prototype.updatePosition=function(t,e){var i;if(void 0==t&&void 0==e)this.notifyChange();else{for(i=0;i<this._points.length;i++)this._points[i].setPoint(this._points[i].getX()+t,this._points[i].getY()+e);for(i in this._components)this._components[i].updatePosition(t,e);for(i in this._relations)this._relations[i]._parent!=this._parent&&this._relations[i].notifyChange()}},Relation.prototype.setLine=function(t){t instanceof RelationLine&&(this._line=t)},Relation.prototype.setEnd=function(t){t instanceof RelationEnd&&(this._end=t)},Relation.prototype.setStart=function(t){t instanceof RelationEnd&&(this._start=t)},Relation.prototype.getParent=function(){return this._parent},Relation.prototype._delUselessPoints=function(){var t,e=this._points.length-1;if(this._elemA!=this._elemB)for(this._elemA instanceof Node&&this._points[1]!=this._points[e]&&this._elemA.isOver(this._points[1])&&(this._points.shift(),e-=1),this._elemB instanceof Node&&this._points[e-1]!=this._points[0]&&this._elemB.isOver(this._points[e-1])&&this._points.pop(),t=1;t<this._points.length-1;t++)this._selectLine(this._points[t-1],this._points[t+1],this._points[t].getX(),this._points[t].getY(),10)&&this._points.splice(t,1)},Relation.prototype.getCentralPoint=function(){var t=parseInt(this._points.length/2)-1,e=this._points[t].getX(),i=this._points[t].getY(),n=this._points[t+1].getX(),o=this._points[t+1].getY();return new Point((e+n)/2,(i+o)/2)},Relation.prototype.getLinkCentered=function(t,e){return this.getCentralPoint()},Relation.prototype.notifyDeleted=function(t){},Relation.prototype.remove=function(){for(;this._relations[0];)this._relations.pop().remove();this._elemA.notifyDeleted(this),this._elemB.notifyDeleted(this),this._parent&&this._parent.delChild(this),this._diagram&&this._diagram.notifyDeleted(this)},Relation.prototype.toString=function(){return"Relation"},Relation.prototype.setLineStyle=function(t){return"solid"==t.toLowerCase()?("solid"==this.getLineStyle()||this._lineStyleChanged?"solid"!=this.getLineStyle()&&this._lineStyleChanged&&(this._lineStyleChanged=!1):this._lineStyleChanged=!0,this.setLine(new SolidLine),!0):"dashed"==t.toLowerCase()&&(this._lineStyle="dashed","dashed"==this.getLineStyle()||this._lineStyleChanged?"dashed"!=this.getLineStyle()&&this._lineStyleChanged&&(this._lineStyleChanged=!1):this._lineStyleChanged=!0,this.setLine(new DashedLine),!0)},Relation.prototype.getLineStyle=function(){return this._line instanceof SolidLine?"solid":this._line instanceof DashedLine?"dashed":""},Relation.prototype.setLineColor=function(t){this._line_color=t},Relation.prototype.getLineColor=function(){return this._line_color},Relation.prototype.setLineWidth=function(t){this._line_width=t},Relation.prototype.getLineWidth=function(){return this._line_width},Relation.prototype.showContextualMenu=function(t,e){if(!this._diagram._activeMenu&&this._menu.length){this._diagram._activeMenu=!0;var i=document.createElement("div");i.className="ud_contextualMenu",i.style.cursor="pointer";for(var n=0;n<this._menu.length;n++)this.addItem(this._menu[n],i);document.body.appendChild(i),this._diagram._divMenu=i,i.style.top=e+"px",i.style.left=t+"px"}},Relation.prototype.removeContextualMenu=function(){this._diagram._activeMenu&&(document.body.removeChild(this._diagram._divMenu),this._diagram._activeMenu=!1,this.notifyDraw())},Relation.prototype.addItem=function(t,e){var i=document.createElement("div");i.className="ud_contextualMenuItem";var n=document.createElement("span");n.appendChild(document.createTextNode(t[1])),i.appendChild(n),e.appendChild(i),i.addEventListener("mouseup",t[0],!1)},Relation.prototype.showStyleDialog=function(t){var e=t.that||this,n=(t.x,t.y,e.getLineColor()),o=e.getLineColor().split("#")[1],s=new Array(parseInt(o.slice(0,2),16),parseInt(o.slice(2,4),16),parseInt(o.slice(4,6),16)),r=document.createElement("div");r.className="ud_popupLineStyle";var h=document.createElement("div");h.setAttribute("id","divBlock1");var a=document.createElement("div");a.setAttribute("id","divBlock2");var l=document.createElement("div");l.setAttribute("id","colorHtml"),l.style.color="#ffffff";var d=document.createElement("div");d.setAttribute("id","red");var p=document.createElement("canvas");p.setAttribute("id","R"),p.width=150,p.height=20,d.appendChild(p);var c=p.getContext("2d"),u=document.createElement("div");u.setAttribute("id","green");var _=document.createElement("canvas");_.setAttribute("id","G"),_.width=150,_.height=20,u.appendChild(_);var g=_.getContext("2d"),m=document.createElement("div");m.setAttribute("id","blue");var f=document.createElement("canvas");f.setAttribute("id","B"),f.width=150,f.height=20,m.appendChild(f);var v=f.getContext("2d"),y=document.createElement("div");y.setAttribute("id","divSelectColor");var C=document.createElement("canvas");C.setAttribute("id","selectColor"),C.width=90,C.height=90,y.appendChild(C);var b=C.getContext("2d"),x=document.createElement("form"),S=document.createElement("div");S.setAttribute("id","divLine");var w=document.createElement("input");w.setAttribute("type","number"),w.setAttribute("name","width"),w.setAttribute("value",e.getLineWidth()||"1"),w.setAttribute("style","width: 58px");var T=document.createElement("label");T.innerHTML="line width",T.setAttribute("for","width"),S.appendChild(w),S.appendChild(T);var F=document.createElement("select");for(F.name="style",value=e.getLineStyle()||"solid",F.add(new Option("Solid","solid")),F.add(new Option("Dashed","dashed")),i=0;i<F.length;i++)F.options[i].value==value&&(F.options[i].selected=!0);F.style="width: 85px";var A=document.createElement("label");A.innerHTML="line style",A.setAttribute("for","style");var P=document.createElement("input");P.setAttribute("type","submit"),P.setAttribute("value","OK"),P.setAttribute("style","bottom: 15px");var E=document.createElement("input");E.setAttribute("type","submit"),E.setAttribute("value","Cancel"),E.setAttribute("style","bottom: 15px");P.addEventListener("click",function(t){e.setLineWidth(parseFloat(w.value,10)),e.setLineStyle(F.options[F.selectedIndex].value),e.notifyDraw(),document.body.removeChild(r)},!1),E.addEventListener("click",function(t){e.setLineColor(n),document.body.removeChild(r)},!1),x.onsubmit=function(){return!1},P.focus(),x.appendChild(S),x.appendChild(F),x.appendChild(A),x.appendChild(document.createElement("br")),x.appendChild(P),x.appendChild(E),h.appendChild(l),h.appendChild(d),h.appendChild(u),h.appendChild(m),h.appendChild(x),r.appendChild(h),a.appendChild(y),a.appendChild(document.createElement("div")),r.appendChild(a);var N=function(t,e,i,n){0==i?i=.1:120==i&&(i=119.9),e.save(),e.font="12px monospace",e.textBaseline="middle",e.fillStyle="#ffffff",e.fillText(t.getAttribute("id"),0,t.height/2),e.restore(),e.save(),e.beginPath(),e.fillStyle=n,e.fillRect(20,0,parseInt(t.width)-50,p.height),e.closePath(),e.restore(),e.fillStyle="#000000",e.beginPath(),e.arc(20+100*i/255,parseInt(t.height)/2,4,0,2*Math.PI,!0),e.closePath(),e.fill(),e.save(),e.font="12px monospace",e.textBaseline="middle",e.fillStyle="#ffffff",e.fillText(parseInt(i),125,t.height/2),e.restore()},W=function(t){b.save(),b.beginPath(),b.fillStyle=t,b.fillRect(20,20,80,80),b.closePath(),b.restore()},L=function(t){for(var i=function(t){var e="0123456789ABCDEF",i=parseInt(t)%16,n=(parseInt(t)-i)/16;return hex=""+e.charAt(n)+e.charAt(i),hex},n=i(t[0])+i(t[1])+i(t[2]);l.hasChildNodes();)l.removeChild(l.lastChild);var o=document.createElement("font");o.style.color="#"+n;var s=document.createTextNode("#"),r=document.createTextNode(n);o.appendChild(s),o.appendChild(r),l.appendChild(o),e.setLineColor("#"+n)},M=function(t){var i=t.pageX-r.offsetLeft-this.offsetLeft;t.pageY,this.offsetTop;"red"==this.getAttribute("id")&&(s[0]=255*(i-20)/100,s[0]>255&&(s[0]=255),s[0]<0&&(s[0]=0),c.clearRect(0,0,parseInt(p.width),p.height),N(p,c,s[0],"#ff0000")),"green"==this.getAttribute("id")&&(s[1]=255*(i-20)/100,s[1]>255&&(s[1]=255),s[1]<0&&(s[1]=0),g.clearRect(0,0,parseInt(_.width),_.height),N(_,g,s[1],"#00ff00")),"blue"==this.getAttribute("id")&&(s[2]=255*(i-20)/100,s[2]>255&&(s[2]=255),s[2]<0&&(s[2]=0),v.clearRect(0,0,parseInt(f.width),f.height),N(f,v,s[2],"#0000ff")),L(s),W(e.getLineColor())};N(p,c,s[0],"#ff0000"),N(_,g,s[1],"#00ff00"),N(f,v,s[2],"#0000ff"),W(e.getLineColor()),L(s),d.addEventListener("mousedown",M,!1),u.addEventListener("mousedown",M,!1),m.addEventListener("mousedown",M,!1),document.body.appendChild(r),r.style.top=(window.innerHeight-parseInt(r.offsetHeight))/2+"px",r.style.left=(window.innerWidth-parseInt(r.offsetWidth))/2+"px"},Relation.prototype.setMenu=function(t){t instanceof Array&&(this._menu=t)},Relation.prototype.getMenu=function(){return this._menu},Relation.prototype.showDirectionDialog=function(t){var e=(t=t||{}).that||this,n=document.createElement("div");n.className="ud_popupDirection";var o=document.createElement("div");o.setAttribute("id","divNavegability");var s=document.createElement("form"),r=document.createElement("select");for(r.setAttribute("name","direction"),value=e.getDirection(),r.add(new Option("none","none")),r.add(new Option("a<-b","a")),r.add(new Option("a->b","b")),r.add(new Option("a<->b","ab")),i=0;i<r.length;i++)r.options[i].value==value&&(r.options[i].selected=!0);r.setAttribute("style","width: 85px");var h=document.createElement("h5");h.innerHTML="Navegability:";var a=document.createElement("input");a.setAttribute("type","submit"),a.setAttribute("value","OK");var l=document.createElement("input");l.setAttribute("type","submit"),l.setAttribute("value","Cancel");a.addEventListener("click",function(t){e.setDirection(r.options[r.selectedIndex].value),e.notifyDraw(),document.body.removeChild(n)},!1),l.addEventListener("click",function(t){document.body.removeChild(n)},!1),s.onsubmit=function(){return!1},a.focus(),s.appendChild(r),s.appendChild(document.createElement("br")),s.appendChild(a),s.appendChild(l),o.appendChild(s),n.appendChild(h),n.appendChild(o),document.body.appendChild(n),n.style.top=(window.innerHeight-parseInt(n.offsetHeight))/2+"px",n.style.left=(window.innerWidth-parseInt(n.offsetWidth))/2+"px"},Relation.prototype.setDirection=function(t){switch(t=t.toLowerCase()){case"a":this.setDirectionToA(!0),this.setDirectionToB(!1);break;case"b":this.setDirectionToA(!1),this.setDirectionToB(!0);break;case"ab":this.setDirectionToA(!0),this.setDirectionToB(!0);break;case"none":this.setDirectionToA(!1),this.setDirectionToB(!1)}},Relation.prototype.setDirectionToA=function(t){this._directionA=t,1==t?this.setStart(new OpenTip):this._start instanceof OpenTip&&(this._start=null)},Relation.prototype.setDirectionToB=function(t){this._directionB=t,1==t?this.setEnd(new OpenTip):this._end instanceof OpenTip&&(this._end=null)},Relation.prototype.getDirectionToA=function(){return void 0!=this._directionA?this._directionA:!(this._start instanceof OpenTip||this._end instanceof OpenTip)||this._start instanceof OpenTip},Relation.prototype.getDirectionToB=function(){return void 0!=this._directionB?this._directionB:this.getElementA()!=this.getElementB()&&(!(this._start instanceof OpenTip||this._end instanceof OpenTip)||this._end instanceof OpenTip)},Relation.prototype.getDirection=function(){return 1==this._directionA&&1==this._directionB?"ab":1==this._directionA?"a":1==this._directionB?"b":"none"},Relation.prototype.getElementA=function(){return this._elemA},Relation.prototype.getElementB=function(){return this._elemB},Relation.prototype.getEnd=function(){return this._end},Relation.prototype.getStart=function(){return this._start},Relation.prototype.getRelations=function(){return this._relations};var TextFields=function(t){t=t||{},TextFields.baseConstructor.call(this,t),this.setMinHeight(10),this.setMinWidth(25)};JSFun.extend(TextFields,SuperComponent),TextFields.prototype.isOver=function(t,e,i){var n=i||0;return!!(this._visible&&this.visibilitySubComponents()&&Math.abs(t-(this._getX()+this.getWidth()-5))<=6+n&&Math.abs(e-(this._getY()+5))<=6+n)||TextFields.base.isOver.call(this,t,e)},TextFields.prototype.select=function(t,e,i){var n=i||0,o=this._orientation?this._getX()+5:this._getX()+this.getWidth()-5,s=this._orientation?this._getY()+this.getHeight()-5:this._getY()+5;return this.visibilitySubComponents()&&Math.abs(t-o)<=6+n&&Math.abs(e-s-n)<=6+n?(this.addField(),!0):TextFields.base.select.call(this,t,e,n)},TextFields.prototype.newItem=function(){return new TextBox},TextFields.prototype.addField=function(t){var e=this.newItem();e.setDeletable(),e.setValue(t),this.addSubComponent(e),this.notifyChange()},TextFields.prototype.drawShape=function(t){this._visible&&(TextFields.base.drawShape.call(this,t),this.visibilitySubComponents()&&(t.save(),t.fillStyle="#94dc91",t.beginPath(),this._orientation?t.arc(this.getPixelX()+5,this.getPixelY()+this.getHeight()-5,4,0,2*Math.PI,!0):t.arc(this.getPixelX()+this.getWidth()-5,this.getPixelY()+5,4,0,2*Math.PI,!0),t.closePath(),t.fill(),t.restore()))};var StereotypeItem=function(t){t=t||{},StereotypeItem.baseConstructor.call(this,t),this._parse=/^\xAB(.*)\xBB$/,this._orientation?this.setMinHeight(40):this.setMinWidth(40)};JSFun.extend(StereotypeItem,TextBox),StereotypeItem.prototype.encode=function(t){var e="";return t&&(e+="«"+t+"»"),this._parse.exec(e)?e:"wrong_stereotype"},StereotypeItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e[0]):""};var StereotypeFields=function(t){t=t||{},StereotypeFields.baseConstructor.call(this,t),this.setMinHeight(1),this.setMinWidth(1),this.setHeight(1),this.setWidth(1)};JSFun.extend(StereotypeFields,TextFields),StereotypeFields.prototype.newItem=function(){return new StereotypeItem({text:"«stereotype»",orientation:this._orientation||0})};var Region=function(t){t=t||{},Region.baseConstructor.call(this,t),this.setType("Region"),this._parent=t.parent||null,this.setContainer(),0!=t.addComponent&&this.addComponents()};JSFun.extend(Region,Node),Region.prototype.addComponents=function(t){t=!JSFun.isBoolean(t)||t;var e=this._parent._nodeChilds,i=e.length;if(0==i&&(this._parent._orientation?this.setWidth(this._parent._width):this.setHeight(this._parent._height)),this._parent._orientation){if(i>0&&t&&(e[i-1].setWidth(e[i-1].getWidth()/2),this._x=e[i-1].getX()+e[i-1].getWidth(),this.setWidth(this._parent.getX()+this._parent.getWidth()-this._x)),this._parent instanceof Alternative||this._parent instanceof HierarchicalSwimlane||!this._parent._includeComponentByRegion||(this.addComponent(new StereotypeFields({id:"stereotypes",centered:!0})),this.addComponent(new TextBox({id:"name_node",text:"region",margin:3,centered:!0}))),i>0){var n=1,o=this._parent.getHeight()-this._parent._components[0]._height-this._parent._components[1]._height;this._parent._heightSmallRectangle;e[i-1].addComponent(new RegionLine({id:"region",margin:0,width:n,height:o,position:Component.TopRight,orientation:1}))}}else if(i>0&&t&&(e[i-1].setHeight(e[i-1].getHeight()/2),this._y=e[i-1].getY()+e[i-1].getHeight(),this.setHeight(this._parent.getY()+this._parent.getHeight()-this._y)),this._parent instanceof Alternative&&(this.addComponent(new StereotypeFields({id:"stereotypes"})),this.addComponent(new GuardItem({id:"description",text:"[]",margin:1}))),this._parent instanceof Alternative||this._parent instanceof HierarchicalSwimlane||!this._parent._includeComponentByRegion||(this.addComponent(new StereotypeFields({id:"stereotypes",centered:!0})),this.addComponent(new TextBox({id:"name_node",text:"region",margin:3,centered:!0}))),i>0){o=1,n=this._parent.getWidth();e[i-1].addComponent(new RegionLine({id:"region",margin:0,width:n,height:o,position:Component.BottomLeft,orientation:0}))}},Region.prototype.updateContainer=function(t){if(0!=t&&1!=t&&(t=!0),this._container){var e,i,n,o,s,r,h=this._x,a=this._y,l=this._x,d=this._y;for(e in this._nodeChilds)(i=this._nodeChilds[e])._visible&&(s=i._x,r=i._y,n=i._x+i._width,o=i._y+i._height,n>l&&(l=n),o>d&&(d=o),s<h&&(h=s),r<a&&(a=r));for(e=this._components.length;e--&&!(this._components[e]instanceof RegionLine););-1!=e&&(this.getParent()._orientation?l+=this._components[e]._width+2:d+=this._components[e]._height+2);var p=-1;if(this.getParent()._orientation){if(h<this._x||l>this._x+this._width){var c;for(e=0;e<this.getParent()._nodeChilds.length;e++){(u=this.getParent()._nodeChilds[e]).getX()+u.getWidth()>h&&-1==p&&(p=e),u.getX()<l&&e}-1!=p&&h<this._x&&(c=this._x-h+this.getParent().getWidth(),this.getParent()._x=this.getParent()._x-(this._x-h),this.getParent().setWidth(c)),l>this._x+this._width&&(c=l-this._x-this._width+this.getParent().getWidth(),this.getParent().setWidth(c))}}else if(a<this._y||d>this._y+this._height){for(e=0;e<this.getParent()._nodeChilds.length;e++){var u;(u=this.getParent()._nodeChilds[e]).getY()+u.getHeight()>a&&-1==p&&(p=e),u.getY()<d&&e}var _;-1!=p&&a<this._y&&(_=this._y-a+this.getParent().getHeight(),this.getParent()._y=this.getParent()._y-(this._y-a),this.getParent().setHeight(_)),d>this._y+this._height&&(_=d-this._y-this._height+this.getParent().getHeight(),this.getParent().setHeight(_))}h<this._x||a<this._y?(this.setWidth(this._x-h+this._width),this.setHeight(this._y-a+this._height),this._x=h,this._y=a,this.setMinWidth(l-h),this.setMinHeight(d-a)):(this.setMinWidth(l-this._x),this.setMinHeight(d-this._y)),this._prex=this._x,this._prey=this._y,this.updateComponents(),this._parent&&t&&this._parent.updateContainer()}},Region.prototype.isOverRegionLine=function(t,e){var i;for(i=0;i<this._components.length;i+=1)if(this._components[i]instanceof RegionLine&&this._components[i].isOver(t,e))return!0;return!1};var Diagram=function(t){this._alone=!1,this._width=0,this._height=0,this._background="#ffffff",this._div=null,this._mainContext=null,this._motionContext=null,this._nodes=[],this._relations=[],this._pressMouse=!1,this._pressMouseRight=!1,this._pressKey=!1,this._validElements=[],this._items=[],this._id,this._type="untyped",this._activeMenu=!1,this._visible=!0,this._name=new Tab({text:"Diagram name",margin:6}),this._name.setCoordinates(0,0),this._name.setParent(this),t&&(t.backgroundNodes&&(this._backgroundNodes=t.backgroundNodes),t.background&&(this._background=t.background),t.id&&(this._alone=!0,this._generateStructure(t.id,t.width,t.height))),this._element=null,this._lastElement=null,this._defineDragAndDrop(),this._updateCanvas=!1};Diagram.prototype._generateStructure=function(t,e,i){(!e||e<0)&&(e=300),(!i||i<0)&&(i=100),this._width=e,this._height=i,this._minWidth=e;var n=document.getElementById(t);if(null==n||"DIV"!=n.nodeName)throw{name:"NotCorrectId",message:"The id specified does not exist or not a div element"};n.setAttribute("class","ud_diagram_div"),n.style.width=e+"px",n.style.height=i+"px",this._div=n;var o=document.createElement("canvas");return o.setAttribute("class","ud_diagram_canvas"),o.width=e,o.height=i,this._mainContext=o.getContext("2d"),n.appendChild(o),(o=document.createElement("canvas")).setAttribute("class","ud_diagram_canvas"),o.width=this._width,o.height=this._height,o.onmousedown=function(){return!1},this._motionContext=o.getContext("2d"),n.appendChild(o),!0},Diagram.prototype.initialize=function(t,e,i,n,o,s){return!!(JSFun.isNumber(t)&&"DIV"==e.nodeName&&i instanceof CanvasRenderingContext2D&&n instanceof CanvasRenderingContext2D&&o>0&&s>0)&&(this._id=t,this._div=e,this._mainContext=i,this._motionContext=n,this._width=o,this._height=s,this._minWidth=o,!0)},Diagram.prototype.getId=function(){return this._id},Diagram.prototype.setId=function(t){this._id=t},Diagram.prototype.getName=function(){return this._name.getValue()},Diagram.prototype.setName=function(t){JSFun.isString(t)&&this._name.setValue(t)},Diagram.prototype.setType=function(t){"untyped"==this._type&&JSFun.isString(t)&&(this._type=t)},Diagram.prototype.getType=function(){return this._type},Diagram.prototype.notifyDraw=function(){this.draw()},Diagram.prototype.notifyChange=function(){this.draw()},Diagram.prototype._addElementOnly=function(t){t instanceof Node?(t.setDiagram(this),this._nodes.push(t)):t instanceof Relation&&(t.setDiagram(this),this._relations.push(t))},Diagram.prototype.addElement=function(t){if(!(t&&t instanceof Element))return!1;var e;for(e in this._validElements)if(t.getType()==this._validElements[e]){if(t instanceof Node)return this._addNode(t),!0;if(t instanceof Relation)return this._addRelation(t),!0}return!1},Diagram.prototype._addNode=function(t){if(t instanceof Node){if(t.setDiagram(this),t instanceof SuperNode)for(var e=0;e<t._nodeChilds.length;e++)t._nodeChilds[e].setDiagram(this);if(this._nodes.push(t),this._backgroundNodes&&t.setBackgroundColor(this._backgroundNodes),t.isAlone()||this.checkForParent(t),t.updatePosition(),t.getParent()){t._parent.updateContainer();for(var i=t._parent.getParent();i;)i instanceof SuperNode?(i.notifyChange(!0),i=null):i=i._parent}this._sortNodesByArea()}},Diagram.prototype.setBackgroundNodes=function(t){t&&(this._backgroundNodes=t)},Diagram.prototype.delElement=function(t){var e;for(e in this._nodes)if(this._nodes[e]==t)return t.remove(),!0;for(e in this._relations)if(this._relations[e]==t)return t.remove(),!0;return!1},Diagram.prototype.notifyDeleted=function(t){var e;if(t instanceof Relation){for(e in this._relations)if(this._relations[e]==t)return void this._relations.splice(e,1)}else if(t instanceof Node)for(e in this._nodes)if(this._nodes[e]==t)return void this._nodes.splice(e,1)},Diagram.prototype._addRelation=function(t){t instanceof Relation&&(t.setDiagram(this),this._relations.push(t))},Diagram.prototype.addRelationFromPoints=function(t,e,i,n,o){var s=this.getElementByPoint(e,i),r=this.getElementByPoint(n,o);return!!(s&&r&&t.setElements(s,r))&&(t.notifyChange(),this.addElement(t))},Diagram.prototype._clearMain=function(){this._mainContext.clearRect(0,0,this._width,this._height),this._mainContext.save(),this._mainContext.fillStyle=this._background,this._mainContext.fillRect(0,0,this._width,this._height),this._mainContext.restore()},Diagram.prototype._clearMotion=function(){this._motionContext.clearRect(0,0,this._width,this._height)},Diagram.prototype.draw=function(){for(this._clearMain(),this.updateHeightCanvas(),this.updateWidthCanvas(),this._name.draw(this._mainContext),i=this._nodes.length-1;i>=0;i-=1)this._nodes[i].draw(this._mainContext);for(i in this._relations)this._relations[i].draw(this._mainContext)},Diagram.prototype.updateHeightCanvas=function(){if(this._updateCanvas){var t,e=0;for(t=this._nodes.length-1;t>=0;t-=1)this._nodes[t]._y+this._nodes[t]._height+10>e&&(e=this._nodes[t]._y+this._nodes[t]._height+10);e>this._height?(this._div.style.height=e+"px",this._div.childNodes[0].height=e,this._div.childNodes[1].height=e,this._mainContext.canvas.height=e,this._motionContext.canvas.height=e,this._clearMotion(),this._height=e):(e=e>580?e:580,this._div.style.height=e+"px",this._div.childNodes[0].height=e,this._div.childNodes[1].height=e,this._mainContext.canvas.height=e,this._motionContext.canvas.height=e,this._clearMotion(),this._height=e)}},Diagram.prototype.setUpdateHeightCanvas=function(t){this._updateCanvas=t},Diagram.prototype._drawMotion=function(t){this._clearMotion(),t.drawShape(this._motionContext)},Diagram.prototype._sortNodesByArea=function(){this._nodes.sort(function(t,e){var i=t.getArea(),n=e.getArea();return i<n?-1:i==n?0:1})},Diagram.prototype.getElementByPoint=function(t,e){var i;for(i in this._relations)if(this._relations[i].isOver(t,e))return this._relations[i];for(i=0;i<this._nodes.length;i++)if(this._nodes[i].isOver(t,e))return this._nodes[i];return null},Diagram.prototype.reassignRelationTo=function(t,e,i){var n;for(n in this._relations)if(this._relations[n]!=t&&this._relations[n].isOver(e,i))return this._relations[n];for(n=0;n<this._nodes.length;n++)if(this._nodes[n].isOver(e,i))return this._nodes[n];return null},Diagram.prototype.checkForParent=function(t){if(t instanceof Node){var e,i,n,o=!1,s=t.getParent();for(e=0;e<this._nodes.length&&!o;e++)if((i=this._nodes[e])instanceof SuperNode){for(var r=0;r<i._nodeChilds.length&&!o;r++)if((n=i._nodeChilds[r]).isContainer()&&n!=t&&n.isOver(t.getCentralPoint())&&(!t.isContainer()||t.isContainer()&&!n.isChildOf(t))){o=!0,i=n;break}}else if(i.isContainer()&&i!=t&&i.getArea()>t.getArea()&&i.isOver(t.getCentralPoint())&&(!t.isContainer()||t.isContainer()&&!i.isChildOf(t))){o=!0;break}if(o)i==s||(s?(s.delChild(t),s.updateContainer(),i.addChild(t)):i.addChild(t));else if(s){s.delChild(t),s.updateContainer();var h=s.getParent();h instanceof SuperNode&&h.notifyChange(!0)}}},Diagram.prototype._defineDragAndDrop=function(){var t=this;this._element=null,this._lastElement=null,this._selectElement=function(e){if(1!=e._touch){if(0!=e.button){if(2!=e.button)return void(t._pressKey=!0);t._pressMouseRight=!0}else t._pressMouse=!0;var i,n=e.pageX-t._div.offsetLeft,o=e.pageY-t._div.offsetTop,s=!1;for(t._lastElement instanceof Relation&&t._lastElement.select(n,o)&&(t._element=t._lastElement,s=!0),i=0;i<t._relations.length&&!s;i++)t._relations[i].select(n,o)&&(t._element=t._relations[i],s=!0);for(i=0;i<t._nodes.length&&!s;i++)t._nodes[i].select(n,o)&&(t._element=t._nodes[i],s=!0);t._alone&&(t._name.deselect(),!s&&t._name.select(n,o)&&(s=!0)),t._lastElement&&t._lastElement!=t._element&&(t._lastElement.deselect(),t._lastElement=null)}},this._selectByTouch=function(e){if(1==e.touches.length){var i=e.touches[0];t._touch=!0,t._hold=!1,t._startX=i.pageX-t._div.offsetLeft,t._startY=i.pageY-t._div.offsetTop;var n,o=!1;for(t._lastElement instanceof Relation&&t._lastElement.select(t._startX,t._startY)&&(t._element=t._lastElement,o=!0),n=0;n<t._relations.length&&!o;n++)t._relations[n].select(t._startX,t._startY)&&(t._element=t._relations[n],o=!0);for(n=0;n<t._nodes.length&&!o;n++)t._nodes[n].select(t._startX,t._startY)&&(t._element=t._nodes[n],o=!0);t._alone&&(t._name.deselect(),!o&&t._name.select(t._startX,t._startY)&&(o=!0)),1==o&&1==t._element._selectedBefore&&(!(t._element instanceof Node||t._element instanceof Relation)||t._element._component||t._element instanceof Node&&t._element.resize||(t._tapTime=setTimeout(function(){t._tapHold(i)},600),t._stopEvent(e),t._cancelEvent(e))),t._lastElement&&t._lastElement!=t._element&&(t._lastElement.deselect(),t._lastElement=null)}},this._dragElement=function(e){if(0==e.button&&t._pressMouse&&t._element){var i=e.pageX-t._div.offsetLeft,n=e.pageY-t._div.offsetTop;i<0&&(i=0),n<0&&(n=0),i>=t._width&&(i=t._width),n>=t._height&&(n=t._height),t._div.style.cursor="pointer",t._element.drag(i,n),t._drawMotion(t._element)}},this._dropElement=function(e){if(0==e.button&&t._pressMouse){if(t._element){t._div.style.cursor="default",t._clearMotion();var i=e.pageX-t._div.offsetLeft,n=e.pageY-t._div.offsetTop;t._element.drop(i,n),t._lastElement=t._element,t._element=null,t._sortNodesByArea(),t.draw()}else t.draw();t._pressMouse=!1}},this._dropByTouch=function(e){if(t._move){if(t._element){t._div.style.cursor="default",t._clearMotion();var i=e.changedTouches[0];t._startX=i.pageX-t._div.offsetLeft,t._startY=i.pageY-t._div.offsetTop,t._element.drop(t._startX,t._startY),t._lastElement=t._element,t._element=null,t._sortNodesByArea(),t.draw()}else t.draw();t._touch=!1,t._move=!1}else clearTimeout(t._tapTime)},this._moveByTouch=function(e){if(1==e.touches.length&&(clearTimeout(t._tapTime),1==t._touch&&t._element&&null!=t._element)){e.preventDefault(),t._div.style.cursor="default",t._clearMotion();var i=e.changedTouches[0],n=i.pageX-t._div.offsetLeft,o=i.pageY-t._div.offsetTop;n<0&&(n=0),o<0&&(o=0),n>=t._width&&(n=t._width),o>=t._height&&(o=t._height),t._div.style.cursor="pointer",t._element.drag(n,o),t._drawMotion(t._element),t._move=!0}},this._suprElement=function(e){46==e.keyCode&&t._lastElement&&(t.delElement(t._lastElement),t._lastElement=null,t.draw())},this._tapHold=function(e){var i=e.pageX-t._div.offsetLeft,n=e.pageY-t._div.offsetTop;t._touch=!1,t._hold=!0,null!=t._element&&t._element.showContextualMenu(i,n),clearTimeout(t._tapTime)},this.stopEvents=function(){this._name.deselect(),t._lastElement&&(t._lastElement.deselect(),t._lastElement=null)},this._stopEvent=function(t){t||(t=window.event),t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},this._cancelEvent=function(t){t||(t=window.event),t.preventDefault?t.preventDefault():t.returnValue=!1}},Diagram.prototype.setVisibility=function(t){this._visible=t,t||this.interaction(!1)},Diagram.prototype.isVisible=function(){return this._visible},Diagram.prototype.interaction=function(t){t?(this._div.addEventListener("mousedown",this._selectElement,!1),window.addEventListener("mousemove",this._dragElement,!1),window.addEventListener("mouseup",this._dropElement,!1),this._div.addEventListener("touchstart",this._selectByTouch,!1),window.addEventListener("touchmove",this._moveByTouch,!1),window.addEventListener("touchend",this._dropByTouch,!1)):(this.stopEvents(),this._div.removeEventListener("mousedown",this._selectElement,!1),window.removeEventListener("mousemove",this._dragElement,!1),window.removeEventListener("mouseup",this._dropElement,!1),this._div.removeEventListener("touchstart",this._selectByTouch,!1),window.removeEventListener("touchmove",this._moveByTouch,!1),window.removeEventListener("touchend",this._dropByTouch,!1))},Diagram.prototype._enumerateElements=function(){var t,e=0,i=0;for(t=0;t<this._nodes.length;t++)if(t>i&&(i=t),this._nodes[t].setId(i),this._nodes[t]instanceof SuperNode){for(e=i+1;e<this._nodes[t]._nodeChilds.length+i+1;e++)this._nodes[t]._nodeChilds[e-i-1].setId(e);i=e}else t!=i&&(i+=1);for(t=0;t<this._relations.length;t++)this._relations[t].setId(t)},Diagram.prototype.getXML=function(t){if(this._enumerateElements(),this._sortNodesByArea(),this._alone)var e=(t=(new DOMParser).parseFromString("<"+this.getType()+"/>","text/xml")).getElementsByTagName(this.getType())[0];else e=t.createElement(this.getType());var i;for(e.setAttribute("name",this._name.getValue()),this._backgroundNodes&&e.setAttribute("backgroundNodes",this._backgroundNodes),i=this._nodes.length-1;i>=0;i--)null==this._nodes[i].getParent()&&void 0==this._nodes[i]._action&&e.appendChild(this._nodes[i].getElementXML(t));for(i=0;i<this._relations.length;i++)this._relations[i].getParent()||e.appendChild(this._relations[i].getElementXML(t));return e},Diagram.prototype.getXMLString=function(){return(new XMLSerializer).serializeToString(this.getXML())},Diagram.prototype.setXML=function(t){var e=[];if(this._alone){if(!(i=t.getElementsByTagName(this.getType())[0]))return!1}else var i=t;this._name.setValue(i.getAttribute("name")),i.getAttribute("backgroundNodes")&&(this._backgroundNodes=i.getAttribute("backgroundNodes"));var n,o=i.childNodes;for(n=0;n<o.length;n++)this._instantiateElements(o[n],e);for(n=0;n<o.length;n++)this._addElementXML(o[n],e);for(n=0;n<this._relations.length;n++)this._relations[n].notifyChange();return this._sortNodesByArea(),!0},Diagram.prototype.setXMLString=function(t){if(!t||!JSFun.isString(t))return!1;t=t.replace(/\n/gi,"");var e=(new DOMParser).parseFromString(t,"text/xml");return null==e?null:this.setXML(e)},Diagram.prototype._addElementXML=function(t,e,i){i=i||null;var n=e[t.getAttribute("id")];if(n){if(i instanceof SuperNode&&n instanceof Region&&n.addComponents(!1),n.setElementXML(t,e),i instanceof SuperNode&&n instanceof Node){if(n.setDiagram(this),n instanceof Region){var o=n._parent._nodeChilds,s=o.length;s>0&&(n._parent._orientation?o[s-1].setWidth(n._x-o[s-1]._x):o[s-1].setHeight(n._y-o[s-1]._y),o[s-1].updateComponents())}}else this._addElementOnly(n);i&&n instanceof Node&&(i.addChild(n),n instanceof Swimlane&&n._parent.updateSizeComponentSwimlane(),i.updateContainer(!1),i._parent instanceof SuperNode&&i._parent.updateContainer(!1));for(var r=0;r<t.childNodes.length;r++)this._addElementXML(t.childNodes[r],e,n)}},Diagram.prototype._instantiateElements=function(t,e,i){i=i||null;var n,o=this._instantiateObjectFromString(t.nodeName,i);if(o)for(e[t.getAttribute("id")]=o,n=0;n<t.childNodes.length;n++)o instanceof SuperNode&&"Region"==t.childNodes[n].nodeName?this._instantiateElements(t.childNodes[n],e,o):this._instantiateElements(t.childNodes[n],e)},Diagram.prototype.setValidElements=function(t){var e;this._validElements=[];for(e in t)JSFun.isString(t[e])&&this._validElements.push(t[e])},Diagram.prototype.getValidElements=function(){if(this._validElements)return this._validElements},Diagram.prototype._instantiateObjectFromString=function(elemName,parent){if(!JSFun.isString(elemName))return null;var i;parent=parent||null;for(i in this._validElements)if(elemName==this._validElements[i]){if("UMLAlternative"==elemName||"UMLHorizontalRegion"==elemName||"UMLVerticalRegion"==elemName||"UMLCompositeState"==elemName){var setElementXml=!0;return eval("new "+this._validElements[i]+"({ setElementXml: "+setElementXml+"})")}return parent?new window[this._validElements[i]]({addComponent:!1,parent:parent}):eval("new "+this._validElements[i]+"()")}},Diagram.prototype.updateWidthCanvas=function(){if(this._updateWidthCanvas){var t,e=0;for(t=this._nodes.length-1;t>=0;t-=1)this._nodes[t]._x+this._nodes[t]._width+10>e&&(e=this._nodes[t]._x+this._nodes[t]._width+10);e>this._width?(this._div.style.width=e+"px",this._div.childNodes[0].width=e,this._div.childNodes[1].width=e,this._mainContext.canvas.width=e,this._motionContext.canvas.width=e,this._clearMotion(),this._width=e):(e=e>this._minWidth?e:this._minWidth,this._div.style.width=e+"px",this._div.childNodes[0].width=e,this._div.childNodes[1].width=e,this._mainContext.canvas.width=e,this._motionContext.canvas.width=e,this._clearMotion(),this._width=e)}},Diagram.prototype.setUpdateWidthCanvas=function(t){this._updateWidthCanvas=t},Diagram.prototype.getRelations=function(){return this._relations};var Dialog=function(t){t=t||{},this._text=t.text||"",this._cancelable=t.cancelable||!1,this._active=!1};Dialog.prototype.show=function(t,e){e=e||null;if(!this._active){if(this._active=!0,"string"!=typeof this._text)return!1;that=this;var i=document.createElement("div");i.className="ud_popup";var n,o=document.createElement("form"),s=document.createElement("input");if(s.setAttribute("type","submit"),s.setAttribute("value","OK"),(n=document.createElement("div")).appendChild(document.createTextNode(this._text)),e){var r,h=document.createElement("div");o=document.createElement("form");(r=document.createElement("input")).setAttribute("type","text"),r.setAttribute("value",e),h.appendChild(r),o.appendChild(h)}if(this.acceptText=function(n){document.body.removeChild(i),e?t(r.value):t(),that._active=!1},s.addEventListener("click",this.acceptText,!1),o.onsubmit=function(){return!1},o.appendChild(s),this._cancelable){var a=document.createElement("input");a.setAttribute("type","submit"),a.setAttribute("value","cancel"),this.deleteDialog=function(t){document.body.removeChild(i),that._active=!1},a.addEventListener("click",this.deleteDialog,!1),o.appendChild(a)}return i.appendChild(n),i.appendChild(o),document.body.appendChild(i),s.focus(),i.style.top=(window.innerHeight-o.offsetHeight)/2+"px",i.style.left=(window.innerWidth-o.offsetWidth)/2+"px",!0}};var ElipseSymbol=function(t){t=t||{},ElipseSymbol.baseConstructor.call(this,t),this.setWidth(15),this.setHeight(15)};JSFun.extend(ElipseSymbol,Component),ElipseSymbol.prototype.draw=function(t){this._visible&&(t.save(),t.strokeStyle=ComponentStyle.component_color,t.beginPath(),t.translate(this.getPixelX()+this._getMargin()-11.5,this.getPixelY()+this._getMargin()),t.scale(11.5,7),t.arc(1,1,1,0,2*Math.PI,!0),t.restore(),t.stroke(),t.restore())};var Elliptical=function(t){t=t||{},Elliptical.baseConstructor.call(this,t)};JSFun.extend(Elliptical,Node),Elliptical.prototype.isOver=function(t,e){t instanceof Point&&(e=t.getY(),t=t.getX());var i=this.getWidth()/2,n=this.getHeight()/2,o=Math.abs(t-this.getX()-i),s=Math.abs(e-this.getY()-n);if(o<=i&&Math.abs(Math.sqrt((1-o*o/(i*i))*n*n))>=s)return!0},Elliptical.prototype.getParticularWidth=function(t){if(t>=this.getY()&&t<=this.getY()+this.getHeight()){var e=this.getWidth()/2,i=this.getHeight()/2,n=this.getY()+i-t,o=this.getX()+e,s=e*Math.sqrt(1-n*n/(i*i));return[o-s,2*s]}return[0,0]},Elliptical.prototype.getLinkCentered=function(t,e){t instanceof Point&&(e=t.getY(),t=t.getX());var i=this.getWidth()/2,n=this.getHeight()/2,o=this.getX()+i,s=this.getY()+n;return JSGraphic.ellipseIntersection(o,s,i,n,t,e)},Elliptical.prototype.calculateSize=function(){var t,e,i=0,n=0,o=!1;for(e=0;e<this._components.length;e++)(t=this._components[e])._visible?t.getPosition()==Component.Float&&(n+=t.getHeight(),t.getWidth()>i&&(i=t.getWidth())):t._visible||(o=!0);0==n&&1==o&&(n=20),0==i&&1==o&&(i=20),n>0&&this.setMinHeight(1.447716*n),i>0&&this.setMinWidth(1.447716*i)},Elliptical.prototype.updateComponents=function(){if(this._components.length>0){this.calculateSize();var t,e=this.getX(),i=this.getY(),n=this.getWidth()/2,o=this.getHeight()/2,s=e+n,r=i+o,h=JSGraphic.ellipseIntersection(s,r,n,o,e,i);this.insertComponents(h.getX(),h.getY(),this.getWidth()-2*(h.getX()-this.getX()),this.getHeight()-2*(h.getY()-this.getHeight()));for(t in this._relations)this._relations[t].notifyChange()}};var TextArea=function(t){t=t||{},TextArea.baseConstructor.call(this,t),this.setText(t.text||""),this._active=!1,this.setFontColor(t.text_color||"#000000"),this.setFontSize(t.font_size||"12"),this._font_width=this.getFontSize()/1.5,this.line_height=parseInt(this.getFontSize())+1,this.setFontFamily(t.text_family||"monospace"),this.setFontStyle(t.font_style||"normal"),this.setFontWeight(t.font_weight||"normal")};JSFun.extend(TextArea,Component),TextArea.prototype.showDialog=function(){var t=this;this._active=!0;var e=document.createElement("div"),i=document.createElement("form"),n=document.createElement("textarea"),o=document.createElement("input"),s=document.createElement("input");e.className="ud_popup",n.setAttribute("rows",5),n.setAttribute("cols",30),n.value=this._text.join("\n"),o.setAttribute("type","submit"),o.setAttribute("value","OK"),s.setAttribute("type","submit"),s.setAttribute("value","Cancel"),this.changeText=function(i){t._active&&(t.setText(n.value),document.body.removeChild(e),t._active=!1,t.notifyChange())},this.closeDialog=function(i){t._active&&(document.body.removeChild(e),t._active=!1,t.notifyChange())},i.onsubmit=function(){return!1},o.addEventListener("click",this.changeText,!1),s.addEventListener("click",this.closeDialog,!1),i.appendChild(n),i.appendChild(o),i.appendChild(s),e.appendChild(i),document.body.appendChild(e),n.focus(),e.style.top=(window.innerHeight-i.offsetHeight)/2+"px",e.style.left=(window.innerWidth-i.offsetWidth)/2+"px"},TextArea.prototype.setText=function(t){if(JSFun.isString(t)){var e,i=0,n=t.split("\n");for(e=0;e<n.length;e++)n[e].length>i&&(i=n[e].length);this._text=n,""==t?this.setWidth(40):this.setWidth(i*this._font_width),this.setHeight(this._text.length*this._line_height)}},TextArea.prototype.setValue=function(t){t=t.replace(/;/gi,"\n"),this.setText(t)},TextArea.prototype.getValue=function(){return this._text.join(";")},TextArea.prototype.select=function(t,e,i){var n=i||0;return!(this._active||!this.isOver(t,e,n))&&(this.showDialog(t,e),!0)},TextArea.prototype.draw=function(t){if(this._visible){t.save(),this._active&&(t.fillStyle="#ffc485",t.fillRect(this._getX(),this._getY(),this.getWidth(),this.getHeight())),t.font=this.getFontStyle()+" "+this.getFontWeight()+" "+this.getFontSize()+"px "+this.getFontFamily(),t.textBaseline="middle",t.fillStyle=this.getFontColor(),this.getUnderlineText()&&1==this.getUnderlineText()&&this.underline(t);var e,i=this._getMX(),n=this._getMY()+this._line_height/2,o=this.getWidth()-2*this._getMargin(),s=0;for(e=0;e<this._text.length;e++)s=i+o/2-this._text[e].length*this._font_width/2,t.fillText(this._text[e],s,n),n+=this._line_height;t.restore()}},TextArea.prototype.drawShape=function(t){this._visible&&(t.save(),t.strokeStyle="#aaaaaa",t.strokeRect(this.getPixelX(),this.getPixelY(),this.getWidth(),this.getHeight()),t.restore())},TextArea.prototype.deselect=function(){this._active&&(this.closeDialog(),this._active=!1)},TextArea.prototype.setFontSize=function(t){this._font_size=t,this.resize()},TextArea.prototype.getFontSize=function(){return this._font_size},TextArea.prototype.setFontColor=function(t){this._font_color=t},TextArea.prototype.getFontColor=function(){return this._font_color},TextArea.prototype.setFontFamily=function(t){this._font_family=t},TextArea.prototype.getFontFamily=function(){return this._font_family},TextArea.prototype.resize=function(){this._line_height=parseInt(this.getFontSize(),10)+1,this._font_width=this.getFontSize()/1.5;var t,e=0,i=this.getValue().split("\n")||"";for(t=0;t<i.length;t++)i[t].length>e&&(e=i[t].length);""==i?this.setWidth(40):this.setWidth(e*this._font_width),this.setHeight(i.length*this._line_height)},TextArea.prototype.setFontStyle=function(t){this._font_style=t},TextArea.prototype.getFontStyle=function(){return this._font_style},TextArea.prototype.setFontWeight=function(t){this._font_weight=t},TextArea.prototype.getFontWeight=function(){return this._font_weight},TextArea.prototype.getComponentXML=function(t){var e=t.createElement("item");return this._id&&e.setAttribute("id",this._id),"#000000"!=this.getFontColor()&&e.setAttribute("fontColor",this.getFontColor()),"12"!=this.getFontSize()&&e.setAttribute("fontSize",this.getFontSize()),"normal"!=this.getFontStyle()&&e.setAttribute("fontStyle",this.getFontStyle()),"monospace"!=this.getFontFamily()&&e.setAttribute("fontFamily",this.getFontFamily()),"normal"!=this.getFontWeight()&&e.setAttribute("fontWeight",this.getFontWeight()),e.setAttribute("value",this.getValue()),e},TextArea.prototype.underline=function(t){if(this._text){var e=t.measureText(this._text).width;t.strokeStyle=this.getFontColor(),t.lineWidth=1,t.beginPath(),t.moveTo(this._getMX(),this._getMY()+(this.getFontSize()-1)),t.lineTo(this._getMX()+e,this._getMY()+(this.getFontSize()-1)),t.stroke()}};var GuardItem=function(t){t=t||{},GuardItem.baseConstructor.call(this,t),this._parse=/^(?:\[([^\[\]\;]*)\])?$/,this.setMinWidth(15)};JSFun.extend(GuardItem,TextArea),GuardItem.prototype.encode=function(t){var e="[]";return t&&(e="["+t+"]"),this._parse.exec(e)?e:"wrong_operation"},GuardItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},GuardItem.prototype.showDialog=function(){var t=this;if(!this.active){this._active=!0;var e=document.createElement("div");e.className="ud_popup";var i=document.createElement("form"),n=document.createElement("textarea");n.setAttribute("rows",5),n.setAttribute("cols",30);var o=document.createElement("input");o.setAttribute("type","submit"),o.setAttribute("value","OK");var s=document.createElement("input");s.setAttribute("type","submit"),s.setAttribute("value","No"),n.value=this.decode(this._text.join("\n")),this.changeText=function(i){t._active&&(t.setText(t.encode(n.value)),document.body.removeChild(e),t._active=!1,t.notifyChange())},this.closeDialog=function(i){t._active&&(document.body.removeChild(e),t._active=!1,t.notifyChange())},i.onsubmit=function(){return!1},o.addEventListener("click",this.changeText,!1),s.addEventListener("click",this.closeDialog,!1),i.appendChild(n),i.appendChild(o),i.appendChild(s),e.appendChild(i),document.body.appendChild(e),n.focus(),e.style.top=(window.innerHeight-i.offsetHeight)/2+"px",e.style.left=(window.innerWidth-i.offsetWidth)/2+"px"}},GuardItem.prototype.draw=function(t){if(this._visible){t.save(),this._active&&(t.fillStyle="#ffc485",t.fillRect(this._getX(),this._getY(),this.getWidth(),this.getHeight())),t.font=this.getFontStyle()+" "+this.getFontWeight()+" "+this.getFontSize()+"px "+this.getFontFamily(),t.textBaseline="middle",t.fillStyle=this.getFontColor();var e,i=this._getMX(),n=this._getMY()+this._line_height/2;this.getWidth(),this._getMargin();for(e=0;e<this._text.length;e++)t.fillText(this._text[e],i,n),n+=this._line_height;t.restore()}};var InstanceItem=function(t){t=t||{},InstanceItem.baseConstructor.call(this,t);this._parse=new RegExp("^([^:=]+)?(?:: ([^=:]+))?(?:= ([^=:]+))?$")};JSFun.extend(InstanceItem,TextBox),InstanceItem.prototype.encode=function(t){var e="";return t[0]&&(e+=t[0]),t[1]&&(e+=": "+t[1]),t[2]&&(e+="= "+t[2]),this._parse.exec(e)?(this._underlineText="",t[0]&&(this._underlineText+=t[0]),t[1]&&(this._underlineText+=": "+t[1]),e):"wrong_instance"},InstanceItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},InstanceItem.prototype.showDialog=function(){if(!this.active){var t=this;this.active=!0;var e=document.createElement("div");e.className="ud_popup";var i,n=document.createElement("form"),o=[];for(i=0;i<3;i++)o.push(document.createElement("input"));var s=document.createElement("input");s.setAttribute("type","submit"),s.setAttribute("value","OK");var r=this.decode(this.getValue());for(i=0;i<o.length;i++)o[i].setAttribute("type","text"),o[i].setAttribute("value",r[i]||"");this.changeText=function(i){if(t.active){var n,s=[];for(n=0;n<o.length;n++)s.push(o[n].value);t.setText(t.encode(s)),document.body.removeChild(e),t.active=!1,t.notifyChange()}},this.closeDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyChange())},n.onsubmit=function(){return!1},s.addEventListener("click",this.changeText,!1);var h,a,l=["name","classifier","value"];for(i=0;i<o.length;i++)a=document.createElement("div"),(h=document.createElement("label")).appendChild(document.createTextNode(l[i])),a.appendChild(h),a.appendChild(o[i]),n.appendChild(a);if(n.appendChild(s),this.deletable){var d=document.createElement("input");d.setAttribute("type","submit"),d.setAttribute("value","delete"),this.deleteDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyDelete(),t.notifyChange())},d.addEventListener("click",this.deleteDialog,!1),n.appendChild(d)}e.appendChild(n),document.body.appendChild(e),s.focus(),e.style.top=(window.innerHeight-n.offsetHeight)/2+"px",e.style.left=(window.innerWidth-n.offsetWidth)/2+"px"}},InstanceItem.prototype.underline=function(t){var e=this._underlineText;t.font=this.getFontSize()+"px "+this.getFontFamily();var i=t.measureText(e).width;t.strokeStyle=this.getFontColor(),t.lineWidth=1,t.moveTo(this._getMX(),this._getMY()+(this.getFontSize()-1)),t.lineTo(this._getMX()+i,this._getMY()+(this.getFontSize()-1)),t.stroke()},InstanceItem.prototype.draw=function(t){this._visible&&(this._underlineText&&this.underline(t),InstanceItem.base.draw.call(this,t))},InstanceItem.prototype.setValue=function(t){InstanceItem.base.setValue.call(this,t),this.encode(t)};var Tab=function(t){t=t||{},Tab.baseConstructor.call(this,t)};JSFun.extend(Tab,TextBox),Tab.prototype.draw=function(t){if(this._visible){Tab.base.draw.call(this,t);var e=this.getPixelX(),i=this.getPixelY();t.beginPath(),t.moveTo(e,i+this.getHeight()),t.lineTo(e+this.getWidth()-4,i+this.getHeight()),t.lineTo(e+this.getWidth(),i),t.stroke()}};var LoopItem=function(t){t=t||{},LoopItem.baseConstructor.call(this,t),this._parse=/^LOOP(?:[\(]?([0-9 ]*)[\,]?)(?:([0-9 ]*)[\)]?)?$/};JSFun.extend(LoopItem,Tab),LoopItem.prototype.encode=function(t){var e="LOOP";return t[0]&&(e+="("+t[0]),t[1]?(t[0]||(e+="(0"),e+=","+t[1]+")"):t[0]&&(e+=")"),this._parse.exec(e)?e:"wrong_operation"},LoopItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},LoopItem.prototype.showDialog=function(){if(!this.active){var t=this;this.active=!0;var e=document.createElement("div");e.className="ud_popup";var i,n=document.createElement("form"),o=[];for(i=0;i<2;i++)o.push(document.createElement("input"));var s=document.createElement("input");s.setAttribute("type","submit"),s.setAttribute("value","OK");var r=this.decode(this.getValue());for(i=0;i<o.length;i++)o[i].setAttribute("type","text"),o[i].setAttribute("value",r[i]||"");this.changeText=function(i){if(t.active){var n,s=[];for(n=0;n<o.length;n++)s.push(o[n].value);t.setText(t.encode(s)),document.body.removeChild(e),t.active=!1,t.notifyChange()}},n.onsubmit=function(){return!1},s.addEventListener("click",this.changeText,!1);var h,a,l=["initial value","end value"];for(i=0;i<o.length;i++)a=document.createElement("div"),(h=document.createElement("label")).appendChild(document.createTextNode(l[i])),a.appendChild(h),a.appendChild(o[i]),n.appendChild(a);if(n.appendChild(s),this.deletable){var d=document.createElement("input");d.setAttribute("type","submit"),d.setAttribute("value","delete"),this.deleteDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyDelete(),t.notifyChange())},d.addEventListener("click",this.deleteDialog,!1),n.appendChild(d)}e.appendChild(n),document.body.appendChild(e),s.focus(),e.style.top=(window.innerHeight-n.offsetHeight)/2+"px",e.style.left=(window.innerWidth-n.offsetWidth)/2+"px"}};var ObjectItem=function(t){t=t||{},ObjectItem.baseConstructor.call(this,t),this._parse=/^([a-zA-Z]*)(?:\:([^\:\{\}]*))?(?:\{([a-zA-Z]*)\})?$/};JSFun.extend(ObjectItem,TextBox),ObjectItem.prototype.encode=function(t){var e="";return t[0]&&(e+=t[0]),t[1]&&(e+=":"+t[1]),t[2]&&(e+="{"+t[2]+"}"),this._parse.exec(e)?e:"wrong_operation"},ObjectItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},ObjectItem.prototype.showDialog=function(){if(!this.active){var t=this;this.active=!0;var e=document.createElement("div");e.className="ud_popup";var i,n=document.createElement("form"),o=[];for(i=0;i<3;i++)o.push(document.createElement("input"));var s=document.createElement("input");s.setAttribute("type","submit"),s.setAttribute("value","ok");var r=this.decode(this.getValue());for(i=0;i<o.length;i++)o[i].setAttribute("type","text"),o[i].setAttribute("value",r[i]||"");this.changeText=function(i){if(t.active){var n,s=[];for(n=0;n<o.length;n++)s.push(o[n].value);t.setText(t.encode(s)),document.body.removeChild(e),t.active=!1,t.notifyChange()}},this.closeDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyChange())},n.onsubmit=function(){return!1},s.addEventListener("click",this.changeText,!1);var h,a,l=["name","class","state"];for(i=0;i<o.length;i++)a=document.createElement("div"),(h=document.createElement("label")).appendChild(document.createTextNode(l[i])),a.appendChild(h),a.appendChild(o[i]),n.appendChild(a);if(n.appendChild(s),this.deletable){var d=document.createElement("input");d.setAttribute("type","submit"),d.setAttribute("value","delete"),this.deleteDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyDelete(),t.notifyChange())},d.addEventListener("click",this.deleteDialog,!1),n.appendChild(d)}e.appendChild(n),document.body.appendChild(e),s.focus(),e.style.top=(window.innerHeight-n.offsetHeight)/2+"px",e.style.left=(window.innerWidth-n.offsetWidth)/2+"px"}};var OperationItem=function(t){t=t||{},OperationItem.baseConstructor.call(this,t),this._parse=/^([-|#|+|~])?([^:()]+)(?:\(([^()]+)?\))(?::([^:()]+))?$/,this.setMinWidth(100)};JSFun.extend(OperationItem,TextBox),OperationItem.prototype.encode=function(t){var e="";return t[0]&&(e+=t[0]),t[1]&&(e+=t[1]),t[2]?e+="("+t[2]+")":e+="()",t[3]&&(e+=":"+t[3]),this._parse.exec(e)?e:"wrong_operation"},OperationItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},OperationItem.prototype.showDialog=function(){if(!this.active){var t=this;this.active=!0;var e,i=document.createElement("div"),n=document.createElement("form"),o=[];for(e=0;e<4;e++)o.push(document.createElement("input"));o[0]=document.createElement("select");var s=document.createElement("option");s.value="",s.appendChild(document.createTextNode("(none)")),o[0].appendChild(s),(s=document.createElement("option")).value="+",s.appendChild(document.createTextNode("+ (public)")),o[0].appendChild(s),(s=document.createElement("option")).value="-",s.appendChild(document.createTextNode("- (private)")),o[0].appendChild(s),(s=document.createElement("option")).value="#",s.appendChild(document.createTextNode("# (protected)")),o[0].appendChild(s),(s=document.createElement("option")).value="~",s.appendChild(document.createTextNode("~ (package)")),o[0].appendChild(s);var r=document.createElement("input");i.className="ud_popup";var h=this.decode(this.getValue());for(e=0;e<o.length;e++)o[e].type="text",o[e].value=h[e]||"";if(h[0]){var a=o[0].childNodes;for(e in a)a[e].value==h[0]&&(a[e].selected="selected")}r.setAttribute("type","submit"),r.setAttribute("value","OK"),this.changeText=function(e){if(t.active){var n,s=[];for(n=0;n<o.length;n++)s.push(o[n].value);t.setText(t.encode(s)),document.body.removeChild(i),t.active=!1,t.notifyChange()}},this.closeDialog=function(e){t.active&&(document.body.removeChild(i),t.active=!1,t.notifyChange())},n.onsubmit=function(){return!1},r.addEventListener("click",this.changeText,!1);var l,d,p=["visibility","name","parameters","return"];for(e=0;e<o.length;e++)d=document.createElement("div"),(l=document.createElement("label")).appendChild(document.createTextNode(p[e])),d.appendChild(l),d.appendChild(o[e]),n.appendChild(d);if(n.appendChild(r),this.deletable){var c=document.createElement("input");c.setAttribute("type","submit"),c.setAttribute("value","delete"),this.deleteDialog=function(e){t.active&&(document.body.removeChild(i),t.active=!1,t.notifyDelete(),t.notifyChange())},c.addEventListener("click",this.deleteDialog,!1),n.appendChild(c)}i.appendChild(n),document.body.appendChild(i),i.style.top=(window.innerHeight-n.offsetHeight)/2+"px",i.style.left=(window.innerWidth-n.offsetWidth)/2+"px"}},OperationItem.prototype.select=function(t,e){return Math.abs(t-(this.getPixelX()+this.getSuperWidth()-20))<=5&&Math.abs(e-(this.getPixelY()+8.66))<=5?(this.notifyToUp(),this.notifyChange(),!0):Math.abs(t-(this.getPixelX()+this.getSuperWidth()-30))<=5&&Math.abs(e-(this.getPixelY()+7.33))<=5?(this.notifyToDown(),this.notifyChange(),!0):OperationItem.base.select.call(this,t,e)},OperationItem.prototype.drawShape=function(t){if(this._visible){var e=this.getPixelX()+this.getSuperWidth()-35,i=this.getPixelY()+3;t.save(),t.fillStyle="#0000aa",t.beginPath(),t.moveTo(e,i),t.lineTo(e+10,i),t.lineTo(e+5,i+7),t.closePath(),t.fill(),e+=10,t.beginPath(),t.moveTo(e+5,i),t.lineTo(e,i+7),t.lineTo(e+10,i+7),t.closePath(),t.fill(),t.restore()}};var OperationFields=function(t){t=t||{},OperationFields.baseConstructor.call(this,t)};JSFun.extend(OperationFields,CollapsibleFields),OperationFields.prototype.newItem=function(){return new OperationItem({text:"new_operation()"})};var Rectangular=function(t){t=t||{},Rectangular.baseConstructor.call(this,t)};JSFun.extend(Rectangular,Node),Rectangular.prototype.setElementXML=function(t){Rectangular.base.setElementXML.call(this,t)};var Separator=function(t){t=t||{},Separator.baseConstructor.call(this,t),this._setPosition(Component.Static),this._orientation?this.setWidth(t.width||1):this.setHeight(t.height||1)};JSFun.extend(Separator,Component),Separator.prototype.draw=function(t){this._visible&&(t.save(),t.lineWidth=this._orientation?this._width-2*this._margin:this._height-2*this._margin,t.strokeStyle=ComponentStyle.component_color,t.beginPath(),this._orientation?(t.moveTo(this.getPixelX(),this.getPixelY()),t.lineTo(this.getPixelX(),this.getPixelY()+this.getHeight())):(t.moveTo(this.getPixelX(),this.getPixelY()),t.lineTo(this.getPixelX()+this.getWidth(),this.getPixelY())),t.stroke(),t.restore())};var RegionLine=function(t){t=t||{},RegionLine.baseConstructor.call(this,t),this._setPosition(t.position||Component.BottomLeft),t.orientation?(this.setHeight(t.height||100),this.setWidth(t.width||1)):(this.setHeight(t.height||1),this.setWidth(t.width||100))};JSFun.extend(RegionLine,Component),RegionLine.prototype.select=function(t,e){var i=this._getX(),n=this._getY(),o=-1;if(!this.selected&&this.isOver(t,e)){var s=this;return this._selectComponent=function(t){s.getParent()._diagram.interaction(!1);var e=s.getParent().getParent();if(e._orientation)for(var i=0;i<e._nodeChilds.length;i++)e._nodeChilds[i].getX()<s.getParent().getX()&&i,e._nodeChilds[i].getX()>s._getX()&&-1==o&&(o=i);else for(i=0;i<e._nodeChilds.length;i++)e._nodeChilds[i].getY()<s.getParent().getY()&&i,e._nodeChilds[i].getY()>s._getY()&&-1==o&&(o=i)},this._dragComponent=function(t){if(0==t.button&&s.getParent()._diagram._pressMouse){var e=t.pageX-s.getParent()._diagram._div.offsetLeft,i=t.pageY-s.getParent()._diagram._div.offsetTop;e<0&&(e=0),i<0&&(i=0),e>=s.getParent()._diagram._width&&(e=s.getParent()._diagram._width),i>=s.getParent()._diagram._height&&(i=s.getParent()._diagram._height),s.getParent()._diagram._div.style.cursor="pointer";s.getParent()._relx,s.getParent()._rely;if(s.getParent().getParent()._orientation){var n=s.getParent()._diagram._width;e>s.getParent()._x+s.getParent()._minWidth&&e<n&&(s._x=e)}else{var o=s.getParent()._diagram._height;i>s.getParent()._y+s.getParent()._minHeight&&i<o&&(s._y=i)}s.getParent()._diagram._drawMotion(s)}},this._dropComponent=function(t){if(0==t.button&&s.getParent()._diagram._pressMouse){var e=s._getX()-i,r=s._getY()-n;if(s.getParent().getParent()._orientation){var h=s.getParent().getParent()._nodeChilds[o];if(s._x=s._x-e,e>0)s.getParent().setWidth(s.getParent().getWidth()+e);else{s.getParent(),s.getParent().getWidth();s.getParent().setWidth(s.getParent().getWidth()+e),-1!=o&&(h._x=h._x+e,h.setWidth(h.getWidth()-e))}}else{h=s.getParent().getParent()._nodeChilds[o];if(s._y=s._y-r,r>0)s.getParent().setHeight(s.getParent().getHeight()+r);else{s.getParent(),s.getParent().getHeight();s.getParent().setHeight(s.getParent().getHeight()+r),-1!=o&&(h._y=h._y+r,h.setHeight(h.getHeight()-r))}}s.getParent()._diagram._div.style.cursor="default",s.getParent()._diagram._clearMotion(),s.getParent()._resizing=!1,s.getParent()._selected=!0,s.getParent().getParent()._selected=!0;s.getParent().getParent().notifyChange(!0,!1,!0),s.getParent()._diagram.draw(),window.removeEventListener("mousedown",s._selectComponent,!1),window.removeEventListener("mousemove",s._dragComponent,!1),window.removeEventListener("mouseup",s._dropComponent,!1),s.getParent()._diagram.interaction(!0),s.getParent()._diagram._lastElement=s.getParent()._diagram._element,s.getParent()._diagram._element=null,o=-1,-1,s.getParent()._diagram._pressMouse=!1}},window.addEventListener("mousedown",this._selectComponent,!1),window.addEventListener("mousemove",this._dragComponent,!1),window.addEventListener("mouseup",this._dropComponent,!1),!0}return!1},RegionLine.prototype.isOver=function(t,e){return!!(this._visible&&t>=this._x-5&&t<=this._x+this._width+5&&e>=this._y-5&&e<=this._y+this._height+5)},RegionLine.prototype.draw=function(t){this._visible&&(this._parent.getParent()._orientation?JSGraphic.dashedLine(t,this.getPixelX(),this.getPixelY(),this.getPixelX(),this.getPixelY()+this.getHeight(),10):JSGraphic.dashedLine(t,this.getPixelX(),this.getPixelY(),this.getPixelX()+this.getWidth(),this.getPixelY(),10))},RegionLine.prototype.drawShape=function(t){if(this._visible){t.save(),t.strokeStyle="#aaaaaa",this._parent.getParent()._orientation?t.strokeRect(this.getPixelX()-2,this.getPixelY(),this.getWidth()+4,this.getHeight()):t.strokeRect(this.getPixelX(),this.getPixelY()-4,this.getWidth(),this.getHeight()+6),t.restore(),t.save(),t.fillStyle="#ff0000",t.beginPath(),this._parent.getParent()._orientation?t.arc(this._parent.getX()+this._parent.getWidth()-7,this._parent.getY()+7,4,0,2*Math.PI,!0):t.arc(this._parent.getX()+7,this._parent.getY()+this._parent.getHeight()-7,4,0,2*Math.PI,!0),t.closePath(),t.fill(),t.restore();for(var e=this._parent.getParent()._nodeChilds,i=0;i<e.length&&e[i]!=this._parent;i++);t.save(),t.fillStyle="#ff0000",t.beginPath(),this._parent.getParent()._orientation?t.arc(e[i+1].getX()+e[i+1].getWidth()-7,e[i+1].getY()+7,4,0,2*Math.PI,!0):t.arc(e[i+1].getX()+7,e[i+1].getY()+e[i+1].getHeight()-7,4,0,2*Math.PI,!0),t.closePath(),t.fill(),t.restore()}};var SuperNode=function(t){t=t||{},SuperNode.baseConstructor.call(this,t),this._orientation=t.orientation||0,this._includeComponentByRegion=0!=t.includeComponentByRegion,this.setContainer()};JSFun.extend(SuperNode,Node),SuperNode.prototype.addRegion=function(t){t instanceof Node&&(t.setContainer(),this.addChild(t),this.notifyChange(!0))},SuperNode.prototype.deleteRegion=function(t){var e;if(this._orientation)var i=t.getWidth();else i=t.getHeight();for(e=0;e<this._nodeChilds.length&&this._nodeChilds[e]!=t;e++);t.remove();var n=e;n==this._nodeChilds.length&&this._nodeChilds[n-1]._components[2]&&this._nodeChilds[n-1]._components[2].notifyDelete(),this._orientation?(this._minWidth=this.getWidth()-i,this.setWidth(this.getWidth()-i)):(this._minHeight=this.getHeight()-i,this.setHeight(this.getHeight()-i)),this.notifyChange(!0),this.notifyDraw()},SuperNode.prototype.notifyChange=function(t,e,i){if(t=t||!1,e=e||!1,i=i||!1,this._resizing=!0,this.updateRegions(e,i),this._container){if(t){var n=this._nodeChilds;for(s=0;s<n.length;s++)n.length-1!=s?n[s].updateContainer(!1):n[s].updateContainer()}else this.updateContainer();if(this._parent)for(var o=this._parent.getParent();o;)o instanceof SuperNode?(o.notifyChange(!0),o=null):o=o._parent}else this.updateComponents(),this._parent&&this._parent.updateContainer();this.updateRegions(e,i);for(var s=0;s<this._nodeChilds.length;s++)this._nodeChilds[s].setDiagram(this._diagram);this._resizing=!1},SuperNode.prototype.updateContainer=function(t){if(0!=t&&1!=t&&(t=!0),this._container){var e,i,n,o,s,r=this._x,h=this._y,a=this._x,l=this._y,d=this._nodeChilds.length;for(e=0;e<d;e++)(i=this._nodeChilds[e])._visible&&(this._orientation?(s=i._x,elemLeftY=i._y,n=e==d-1?i._x+i._minWidth:i._x+i._width,o=i._y+i._minHeight):(s=i._x,elemLeftY=i._y,n=i._x+i._minWidth,o=e==d-1?i._y+i._minHeight:i._y+i._height,n=i._x+i._minWidth),n>a&&(a=n),o>l&&(l=o),s<r&&(r=s),elemLeftY<h&&(h=elemLeftY));r<this._x||h<this._y?(this.setWidth(this._x-r+this._width),this.setHeight(this._y-h+this._height),this._x=r,this._y=h,this.setMinWidth(a-r),this.setMinHeight(l-h)):(this.setMinWidth(a-this._x),this.setMinHeight(l-this._y)),this._prex=this._x,this._prey=this._y,this.updateComponents(),this._parent&&t&&this._parent.updateContainer()}},SuperNode.prototype.updateRegions=function(t,e){t=t||!1,e=e||!1;var i=this._nodeChilds.length;if(this._orientation){for(var n=this.getX(),o=0;o<i;o++){(h=this._nodeChilds[o]).setMinHeight(this._minHeight-this._components[0].getHeight()-this._components[1].getHeight()),h.setHeight(this.getHeight()-this._components[0].getHeight()-this._components[1].getHeight()),h._components[2]instanceof RegionLine&&h._components[2].setHeight(this.getHeight()-this._components[0].getHeight()-this._components[1].getHeight())}for(o=0;o<i;o++)this._nodeChilds[o]._x=n,this._nodeChilds[o]._y=this.getY()+this._components[0].getHeight()+this._components[1].getHeight(),o==i-1&&(t||n+this._nodeChilds[o]._width<this.getWidth()+this.getX()?this._nodeChilds[o].setWidth(this.getWidth()+this.getX()-n):this.setWidth(n+this._nodeChilds[o]._width-this.getX())),n+=this._nodeChilds[o].getWidth();for(o=0;o<i;o++){if((a=this._nodeChilds[o]._x-this._nodeChilds[o]._prex)>0||a<0&&!e)for(var s=0;s<this._nodeChilds[o]._nodeChilds.length;s++)this._nodeChilds[o]._nodeChilds[s].updatePosition(a,0,!0);this._nodeChilds[o].resetMovement()}}else{var r=this.getY()+this._components[0].getHeight()+this._components[1].getHeight();for(o=0;o<i;o++){var h;(h=this._nodeChilds[o]).setMinWidth(this._minWidth),h.setWidth(this.getWidth()),h._components[2]instanceof RegionLine&&h._components[2].setWidth(this.getWidth())}for(o=0;o<i;o++)this._nodeChilds[o]._x=this.getX(),this._nodeChilds[o]._y=r,o==i-1&&(t||r+this._nodeChilds[o]._height<this.getHeight()+this.getY()?this._nodeChilds[o].setHeight(this.getHeight()+this.getY()-r):this.setHeight(r+this._nodeChilds[o]._height-this.getY())),r+=this._nodeChilds[o].getHeight();for(o=0;o<i;o++){var a;if((a=this._nodeChilds[o]._y-this._nodeChilds[o]._prey)>0||a<0&&!e)for(s=0;s<this._nodeChilds[o]._nodeChilds.length;s++)this._nodeChilds[o]._nodeChilds[s].updatePosition(0,a,!0);this._nodeChilds[o].resetMovement()}}for(this.updateComponents(),o=0;o<this._nodeChilds.length;o++)this._nodeChilds[o].updateComponents()},SuperNode.prototype.select=function(t,e){if(this._visible){var i,n=-1,o=this;for(this.deselectComponent(),i=0;i<this._nodeChilds.length;i++)this._nodeChilds[i]._selected&&(n=i),this._nodeChilds[i].deselect();if(this._diagram._activeMenu&&this.removeContextualMenu(),1==this._diagram._pressMouse){if(this._selected&&this._moveable&&Math.abs(t-(this._x+this._width+2.5))<=5&&Math.abs(e-(this._y+this._height+2.5))<=5)return this._resizing=!0,!0;if(this._selected){var s=this._nodeChilds;for(i=0;i<s.length-1;i++)if(i==n){if(this._orientation)var r=s[i].getX()+s[i].getWidth()-7,h=s[i].getY()+7,a=s[i+1].getX()+s[i+1].getWidth()-7,l=s[i+1].getY()+7;else r=s[i].getX()+7,h=s[i].getY()+s[i].getHeight()-7,a=s[i+1].getX()+7,l=s[i+1].getY()+s[i+1].getHeight()-7;var d=new Dialog({text:"Do you want to delete the region?",cancelable:!0});if(Math.abs(t-r)<=8&&Math.abs(e-h)<=8)return this._diagram._pressMouse=!1,d.show(function(){o.deleteRegion(s[i])}),!0;if(Math.abs(t-a)<=8&&Math.abs(e-l)<=8)return this._diagram._pressMouse=!1,d.show(function(){o.deleteRegion(s[i+1])}),!0}for(i=0;i<this._nodeChilds.length;i++){var p=this._nodeChilds[i];if(p.isOverComponent(t,e))return p.isOverRegionLine(t,e)?p.selectComponent(t,e):(this._relx=t-this._x,this._rely=e-this._y,this._selectedBefore=!0),!0}if(this.isOverComponent(t,e))return this._relx=t-this._x,this._rely=e-this._y,this._selectedBefore=!0,!0}return!!this.isOver(t,e)&&(this._relx=t-this._x,this._rely=e-this._y,this._selectedBefore=this._selected,this._selected=!0,!0)}if(1==this._diagram._pressMouseRight){if(this.isOver(t,e)){document.oncontextmenu=function(){return!1};var c=document.documentElement.scrollTop||document.body.scrollTop;return t+=this._diagram._div.offsetLeft,e=c?e-c+this._diagram._div.offsetTop:e+this._diagram._div.offsetTop,this.showContextualMenu(t,e),!0}return!1}}},SuperNode.prototype.drop=function(t,e){if(this._moved){if(this._alone||this._diagram.checkForParent(this),this.updatePosition(),this._parent){this._parent.updateContainer();for(var i=this._parent.getParent();i;)i instanceof SuperNode?(i.notifyChange(!0),i=null):i=i._parent}}else if(this._resizing){if(this instanceof SuperNode){this.notifyChange(!0,!0)}else this.notifyChange();if(this._parent){this._parent.updateContainer();for(i=this._parent.getParent();i;)i instanceof SuperNode?(i.notifyChange(!0,!0),i=null):i=i._parent}}else this._selectedBefore&&this.selectComponent(t,e);this._moved=!1,this._resizing=!1},SuperNode.prototype.selectComponent=function(t,e){var i;for(i=0;i<this._components.length;i+=1)if(this._components[i].select(t,e))return void(this._activeComponent=this._components[i]);for(i=0;i<this._nodeChilds.length;i++){var n=this._nodeChilds[i];if(n.isOverComponent(t,e))return n.selectComponent(t,e),n._selectedBefore=!0,!0}},SuperNode.prototype.draw=function(t){if(this._visible){t.save(),t.fillStyle=NodeStyle.shape_color,this._moveable&&this._selected&&t.fillRect(parseInt(this._x+this._width),parseInt(this._y+this._height),5,5),t.restore(),this.drawFigures(t),this.drawComponents(t),this._selected&&this.drawComponentsShape(t);for(var e=0;e<this._nodeChilds.length;e++)this._nodeChilds[e].draw(t);if(this._selected)for(e=0;e<this._nodeChilds.length;e++)this._nodeChilds[e]._components[0]&&this._nodeChilds[e]._components[0].drawShape(t),this._nodeChilds[e]._components[1]&&this._nodeChilds[e]._components[1].drawShape(t)}},SuperNode.prototype.getElementXML=function(t){var e,i=t.createElement(this.getType());this._selectedFigure&&this.setSelectedFigure(0),i.setAttribute("id",this.getId()),i.setAttribute("x",this.getX()),i.setAttribute("y",this.getY()),i.setAttribute("width",this.getWidth()),i.setAttribute("height",this.getHeight()),i.setAttribute("backgroundColor",this.getBackgroundColor()),i.setAttribute("orientation",this._orientation),i.setAttribute("includeComponentByRegion",this._includeComponentByRegion);for(e in this._components)this._components[e].getId()&&i.appendChild(this._components[e].getComponentXML(t));for(e in this._nodeChilds)i.appendChild(this._nodeChilds[e].getElementXML(t));for(e in this._relationChilds)i.appendChild(this._relationChilds[e].getElementXML(t));return i},SuperNode.prototype.setElementXML=function(t){var e;this.setPosition(parseInt(t.getAttribute("x")),parseInt(t.getAttribute("y"))),this.resetMovement(),this.setWidth(parseInt(t.getAttribute("width"))),this.setHeight(parseInt(t.getAttribute("height"))),this.setBackgroundColor(t.getAttribute("backgroundColor")),this._orientation=parseInt(t.getAttribute("orientation")),this._includeComponentByRegion=t.getAttribute("includeComponentByRegion"),this._includeComponentByRegion="true"==this._includeComponentByRegion;var i=t.childNodes;for(e=0;e<i.length;e++){var n;if("item"==i[e].nodeName)this.setValue(i[e].getAttribute("id"),i[e].getAttribute("value"));else if("superitem"==i[e].nodeName)for(n in this._components)this._components[n].getId()==i[e].getAttribute("id")&&this._components[n].setComponentXML(i[e])}};var RegionItem=function(t){t=t||{},RegionItem.baseConstructor.call(this,t)};JSFun.extend(RegionItem,TextBox),RegionItem.prototype.select=function(t,e){return!(this.selected||!this.isOver(t,e))&&(this.createRegion(),!0)},RegionItem.prototype.createRegion=function(){this.getParent()._components.length;this.getParent()._orientation,this.getParent().addRegion(new Region({parent:this.getParent()}))};var Rhombus=function(t){t=t||{},Rhombus.baseConstructor.call(this,t)};JSFun.extend(Rhombus,Node),Rhombus.prototype.getLinkCentered=function(t,e){t instanceof Point&&(e=t.getY(),t=t.getX());var i,n,o,s,r=this.getCentralPoint(),h=r.getX(),a=r.getY();return i=this.getX(),n=r.getY(),o=r.getX(),s=this.getY(),t<h?e<a||(s=this.getY()+this.getHeight()):e<a?i=this.getX()+this.getWidth():(i=this.getX()+this.getWidth(),s=this.getY()+this.getHeight()),JSGraphic.lineIntersection(i,n,o,s,t,e,r.getX(),r.getY())},Rhombus.prototype.calculateSize=function(){var t,e,i=0,n=0;for(e=0;e<this._components.length;e+=1)(t=this._components[e]).getPosition()==Component.Float&&(n+=t.getHeight(),t.getWidth()>i&&(i=t.getWidth()));n>0&&this.setMinHeight(2*n),i>0&&this.setMinWidth(2*i)},Rhombus.prototype.updateComponents=function(){if(this._components.length>0){this.calculateSize();var t,e=this.getX(),i=this.getY(),n=this.getWidth()/2,o=this.getHeight()/2,s=this.getCentralPoint(),r=JSGraphic.lineIntersection(e,i+o,e+n,i,this.getX(),this.getY(),s.getX(),s.getY());this.insertComponents(r.getX(),r.getY(),this.getWidth()-2*(r.getX()-this.getX()),this.getHeight()-2*(r.getY()-this.getHeight()));for(t in this._relations)this._relations[t].notifyChange()}};var RoleItem=function(t){t=t||{},RoleItem.baseConstructor.call(this,t),this._parse=/^([#|+|\-|~])?([\/])?(.*)?$/};JSFun.extend(RoleItem,TextBox),RoleItem.prototype.encode=function(t){var e="";return t[0]&&(e+=t[0]),t[1]&&(e+=t[1]),t[2]&&(e+=t[2]),this._parse.exec(e)?e:"wrong_role"},RoleItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},RoleItem.prototype.showDialog=function(){if(!this.active){var t=this;this.active=!0;var e,i=document.createElement("div"),n=document.createElement("form"),o=[];for(e=0;e<3;e++)o.push(document.createElement("input"));o[0]=document.createElement("select");var s=document.createElement("option");s.value="",s.appendChild(document.createTextNode("(none)")),o[0].appendChild(s),(s=document.createElement("option")).value="+",s.appendChild(document.createTextNode("+ (public)")),o[0].appendChild(s),(s=document.createElement("option")).value="-",s.appendChild(document.createTextNode("- (private)")),o[0].appendChild(s),(s=document.createElement("option")).value="#",s.appendChild(document.createTextNode("# (protected)")),o[0].appendChild(s),(s=document.createElement("option")).value="~",s.appendChild(document.createTextNode("~ (package)")),o[0].appendChild(s),o[1]=document.createElement("select"),(s=document.createElement("option")).value="",s.appendChild(document.createTextNode("no")),o[1].appendChild(s),(s=document.createElement("option")).value="/",s.appendChild(document.createTextNode("yes")),o[1].appendChild(s);var r=document.createElement("input");i.className="ud_popup";var h=this.decode(this.getValue());for(e=0;e<o.length;e++)o[e].type="text",o[e].value=h[e]||"";if(h[0]){var a=o[0].childNodes;for(e in a)a[e].value==h[0]&&(a[e].selected="selected")}if(h[1]){a=o[1].childNodes;for(e in a)a[e].value==h[1]&&(a[e].selected="selected")}r.setAttribute("type","submit"),r.setAttribute("value","OK"),this.changeText=function(e){if(t.active){var n,s=[];for(n=0;n<o.length;n++)s.push(o[n].value);t.setText(t.encode(s)),document.body.removeChild(i),t.active=!1,t.notifyChange()}},this.closeDialog=function(e){t.active&&(document.body.removeChild(i),t.active=!1,t.notifyChange())},n.onsubmit=function(){return!1},r.addEventListener("click",this.changeText,!1);var l,d,p=["visibility","derived","role"];for(e=0;e<o.length;e++)d=document.createElement("div"),(l=document.createElement("label")).appendChild(document.createTextNode(p[e])),d.appendChild(l),d.appendChild(o[e]),n.appendChild(d);if(n.appendChild(r),this.deletable){var c=document.createElement("input");c.setAttribute("type","submit"),c.setAttribute("value","delete"),this.deleteDialog=function(e){t.active&&(document.body.removeChild(i),t.active=!1,t.notifyDelete(),t.notifyChange())},c.addEventListener("click",this.deleteDialog,!1),n.appendChild(c)}i.appendChild(n),document.body.appendChild(i),i.style.top=(window.innerHeight-n.offsetHeight)/2+"px",i.style.left=(window.innerWidth-n.offsetWidth)/2+"px"}};var Space=function(t){t=t||{},Space.baseConstructor.call(this,t),t.height&&this.setHeight(t.height||0)};JSFun.extend(Space,Component);var SpecificationItem=function(t){t=t||{},SpecificationItem.baseConstructor.call(this,t);this._parse=new RegExp("^(entry/)?([a-zA-Z]*)?(;do/)?([a-zA-Z]*)?(;exit/)?([a-zA-Z]*)?$"),this._behaviors=new Array,this._visible=t.visible||!1,this.setMinWidth(100),this.setDeletable()};JSFun.extend(SpecificationItem,TextBox),SpecificationItem.prototype.encode=function(t){var e="";return t[0]&&(this._behaviors[0]=t[0],e+="entry/"),t[1]&&(e+=t[1]),t[2]&&(this._behaviors[1]=t[2],e+=";do/"),t[3]&&(e+=t[3]),t[4]&&(this._behaviors[2]=t[4],e+=";exit/"),t[5]&&(e+=t[5]),this._parse.exec(e)?e:"wrong_attribute"},SpecificationItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},SpecificationItem.prototype.getComponentXML=function(t){var e=t.createElement("item");return this._id&&e.setAttribute("id",this._id),"#000000"!=this.getFontColor()&&e.setAttribute("fontColor",this.getFontColor()),"12"!=this.getFontSize()&&e.setAttribute("fontSize",this.getFontSize()),"normal"!=this.getFontStyle()&&e.setAttribute("fontStyle",this.getFontStyle()),"monospace"!=this.getFontFamily()&&e.setAttribute("fontFamily",this.getFontFamily()),"normal"!=this.getFontWeight()&&e.setAttribute("fontWeight",this.getFontWeight()),e.setAttribute("value",this.getValue()),e.setAttribute("behaviors",this._behaviors),e.setAttribute("visible",this._visible),e},SpecificationItem.prototype.setValue=function(t,e,i){e&&(this._behaviors[0]=e[0],this._behaviors[1]=e[2],this._behaviors[2]=e[4]),this._visible="true"==i,this.setText(t)},SpecificationItem.prototype.setText=function(t){if(JSFun.isString(t)){var e,i=0,n=t.split(";");for(e=0;e<n.length;e++)n[e].length>i&&(i=n[e].length);this._text=n,""==t?this.setWidth(40):this.setWidth(i*this._font_width),this.setHeight(this._text.length*this._line_height)}},SpecificationItem.prototype.getValue=function(){return this._text?this._text.join(";"):""},SpecificationItem.prototype.isOver=function(t,e){return!!(t>=this._x&&t<=this._x+this._width&&e>=this._y&&e<=this._y+this._height&&this._visible)},SpecificationItem.prototype.showDialog=function(){if(!this.active&&this._visible){var t=this;this.active=!0;var e=document.createElement("div");e.className="ud_popup";var i,n=document.createElement("form"),o=[];for(i=0;i<6;i++)o.push(document.createElement("input"));var s,r=document.createElement("input");for(r.setAttribute("type","submit"),r.setAttribute("value","OK"),i=0;i<6;i+=2)o[i]=document.createElement("select"),(s=document.createElement("option")).value="0",s.appendChild(document.createTextNode("<UNSPECIFIED>")),o[i].appendChild(s),(s=document.createElement("option")).value="1",s.appendChild(document.createTextNode("Activity")),o[i].appendChild(s),(s=document.createElement("option")).value="2",s.appendChild(document.createTextNode("FunctionBehavior")),o[i].appendChild(s),(s=document.createElement("option")).value="3",s.appendChild(document.createTextNode("Interaction")),o[i].appendChild(s),(s=document.createElement("option")).value="4",s.appendChild(document.createTextNode("OpaqueBehavior")),o[i].appendChild(s),(s=document.createElement("option")).value="5",s.appendChild(document.createTextNode("ProtocolStateMachine")),o[i].appendChild(s),(s=document.createElement("option")).value="6",s.appendChild(document.createTextNode("StateMachine")),o[i].appendChild(s);var h=t.decode(t.getValue());for(i=0;i<o.length;i++)o[i].type="text",o[i].value=h[i]||"";if(h[0]){var a=o[0].childNodes;for(i=0;i<a.length;i++)a[i].value==t._behaviors[0]&&(a[i].selected="selected")}if(h[2]){a=o[2].childNodes;for(i=0;i<a.length;i++)a[i].value==t._behaviors[1]&&(a[i].selected="selected")}if(h[4]){a=o[4].childNodes;for(i=0;i<a.length;i++)a[i].value==t._behaviors[2]&&(a[i].selected="selected")}t.changeText=function(n){if(t.active){var s=[];for(i=0;i<o.length;i++)s.push(o[i].value);t.setText(t.encode(s)),document.body.removeChild(e),t.active=!1,t.notifyChange(),t._parent.updateComponents(),t._parent.notifyDraw()}},t.closeDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyChange(),t.notifyDraw())},n.onsubmit=function(){return!1},r.addEventListener("click",t.changeText,!1);var l,d,p=["Behavior","name","Behavior","name","Behavior","name","restrictions"],c=["Entry","Do Activity","Exit"],u=-1;for(i=0;i<o.length;i++)i%2==0&&((d=document.createElement("div")).appendChild(document.createTextNode(c[++u])),d.style.background="#ccccff",d.style.textAlign="center",d.style.fontWeight="bold",d.style.marginLeft="-10px",d.style.marginRight="-10px",d.style.font="14px",d.style.paddingTop="3px",d.style.paddingBottom="3px",n.appendChild(d)),d=document.createElement("div"),(l=document.createElement("label")).appendChild(document.createTextNode(p[i])),d.appendChild(l),d.style.clear="both",d.appendChild(o[i]),n.appendChild(d);if(n.appendChild(r),t.deletable){var _=document.createElement("input");_.setAttribute("type","submit"),_.setAttribute("value","delete"),t.deleteDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t._visible=!1,t.setText(""),t.notifyChange(),t.notifyDraw())},_.addEventListener("click",t.deleteDialog,!1),n.appendChild(_),n.appendChild(_)}e.appendChild(n),document.body.appendChild(e),r.focus(),e.style.top=(window.innerHeight-n.offsetHeight)/2+"px",e.style.left=(window.innerWidth-n.offsetWidth)/2+"px"}},SpecificationItem.prototype.drawShape=function(t){this._visible&&(t.save(),t.strokeStyle="#aaaaaa",t.strokeRect(this.getPixelX(),this.getPixelY(),this.getWidth(),this.getHeight()),t.restore())},SpecificationItem.prototype.draw=function(t){if(this._visible){t.save(),t.font=this.getFontStyle()+" "+this.getFontWeight()+" "+this.getFontSize()+"px "+this.getFontFamily(),t.textBaseline="middle",t.fillStyle=this.getFontColor();var e,i=this._getMX(),n=this._getMY()+this._line_height/2,o=this.getWidth()-2*this._getMargin(),s=0;for(e=0;e<this._text.length;e++)s=i+o/2-this._text[e].length*this._font_width/2,t.fillText(this._text[e],s,n),n+=this._line_height;t.restore()}},SpecificationItem.prototype.resize=function(){this._line_height=parseInt(this.getFontSize(),10)+1,this._font_width=this.getFontSize()/1.5;var t,e=0,i=this.getValue().split(";")||"";for(t=0;t<i.length;t++)i[t].length>e&&(e=i[t].length);""==i?this.setWidth(40):this.setWidth(e*this._font_width),this.setHeight(i.length*this._line_height)};var TransitionItem=function(t){t=t||{},TransitionItem.baseConstructor.call(this,t),this._parse=/^([a-zA-Z]*)(?:\[([^\[\]]*)\])?(?:\/([a-zA-Z]*))?$/};JSFun.extend(TransitionItem,TextBox),TransitionItem.prototype.encode=function(t){var e="";return t[0]&&(e+=t[0]),t[1]&&(e+="["+t[1]+"]"),t[2]&&(e+="/"+t[2]),this._parse.exec(e)?e:"wrong_operation"},TransitionItem.prototype.decode=function(t){var e=this._parse.exec(t);return e?(e.shift(),e):[]},TransitionItem.prototype.showDialog=function(){if(!this.active){var t=this;this.active=!0;var e=document.createElement("div");e.className="ud_popup";var i,n=document.createElement("form"),o=[];for(i=0;i<3;i++)o.push(document.createElement("input"));var s=document.createElement("input");s.setAttribute("type","submit"),s.setAttribute("value","OK");var r=this.decode(this.getValue());for(i=0;i<o.length;i++)o[i].setAttribute("type","text"),o[i].setAttribute("value",r[i]||"");this.changeText=function(i){if(t.active){var n,s=[];for(n=0;n<o.length;n++)s.push(o[n].value);t.setText(t.encode(s)),document.body.removeChild(e),t.active=!1,t.notifyChange()}},this.closeDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyChange())},n.onsubmit=function(){return!1},s.addEventListener("click",this.changeText,!1);var h,a,l=["trigger","guard","behavior"];for(i=0;i<o.length;i++)a=document.createElement("div"),(h=document.createElement("label")).appendChild(document.createTextNode(l[i])),a.appendChild(h),a.appendChild(o[i]),n.appendChild(a);if(n.appendChild(s),this.deletable){var d=document.createElement("input");d.setAttribute("type","submit"),d.setAttribute("value","delete"),this.deleteDialog=function(i){t.active&&(document.body.removeChild(e),t.active=!1,t.notifyDelete(),t.notifyChange())},d.addEventListener("click",this.deleteDialog,!1),n.appendChild(d)}e.appendChild(n),document.body.appendChild(e),s.focus(),e.style.top=(window.innerHeight-n.offsetHeight)/2+"px",e.style.left=(window.innerWidth-n.offsetWidth)/2+"px"}};